var xn=Object.defineProperty,$n=(e,t,n)=>t in e?xn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,ae=(e,t,n)=>$n(e,typeof t!="symbol"?t+"":t,n);const wn={uint8x2:{numComponents:2,type:"UNSIGNED_BYTE",normalized:!1,dataType:"unsigned int",byteSize:2,wgslType:"vec2<u32>",typedArrayConstructor:Uint8Array},uint8x4:{numComponents:4,type:"UNSIGNED_BYTE",normalized:!1,dataType:"unsigned int",byteSize:4,wgslType:"vec4<u32>",typedArrayConstructor:Uint8Array},sint8x2:{numComponents:2,type:"BYTE",normalized:!1,dataType:"signed int",byteSize:2,wgslType:"vec2<i32>",typedArrayConstructor:Int8Array},sint8x4:{numComponents:4,type:"BYTE",normalized:!1,dataType:"signed int",byteSize:4,wgslType:"vec4<i32>",typedArrayConstructor:Int8Array},unorm8x2:{numComponents:2,type:"UNSIGNED_BYTE",normalized:!0,dataType:"unsigned normalized",byteSize:2,wgslType:"vec2<f32>",typedArrayConstructor:Uint8Array},unorm8x4:{numComponents:4,type:"UNSIGNED_BYTE",normalized:!0,dataType:"unsigned normalized",byteSize:4,wgslType:"vec4<f32>",typedArrayConstructor:Uint8Array},snorm8x2:{numComponents:2,type:"BYTE",normalized:!0,dataType:"signed normalized",byteSize:2,wgslType:"vec2<f32>",typedArrayConstructor:Int8Array},snorm8x4:{numComponents:4,type:"BYTE",normalized:!0,dataType:"signed normalized",byteSize:4,wgslType:"vec4<f32>",typedArrayConstructor:Int8Array},uint16x2:{numComponents:2,type:"UNSIGNED_SHORT",normalized:!1,dataType:"unsigned int",byteSize:4,wgslType:"vec2<u32>",typedArrayConstructor:Uint16Array},uint16x4:{numComponents:4,type:"UNSIGNED_SHORT",normalized:!1,dataType:"unsigned int",byteSize:8,wgslType:"vec4<u32>",typedArrayConstructor:Uint16Array},sint16x2:{numComponents:2,type:"SHORT",normalized:!1,dataType:"signed int",byteSize:4,wgslType:"vec2<i32>",typedArrayConstructor:Int16Array},sint16x4:{numComponents:4,type:"SHORT",normalized:!1,dataType:"signed int",byteSize:8,wgslType:"vec4<i32>",typedArrayConstructor:Int16Array},unorm16x2:{numComponents:2,type:"UNSIGNED_SHORT",normalized:!0,dataType:"unsigned normalized",byteSize:4,wgslType:"vec2<f32>",typedArrayConstructor:Uint16Array},unorm16x4:{numComponents:4,type:"UNSIGNED_SHORT",normalized:!0,dataType:"unsigned normalized",byteSize:8,wgslType:"vec4<f32>",typedArrayConstructor:Uint16Array},snorm16x2:{numComponents:2,type:"SHORT",normalized:!0,dataType:"signed normalized",byteSize:4,wgslType:"vec2<f32>",typedArrayConstructor:Int16Array},snorm16x4:{numComponents:4,type:"SHORT",normalized:!0,dataType:"signed normalized",byteSize:8,wgslType:"vec4<f32>",typedArrayConstructor:Int16Array},float16x2:{numComponents:2,type:"HALF_FLOAT",normalized:!1,dataType:"float",byteSize:4,wgslType:"vec2<f16>",typedArrayConstructor:Int16Array},float16x4:{numComponents:4,type:"HALF_FLOAT",normalized:!1,dataType:"float",byteSize:8,wgslType:"vec4<f16>",typedArrayConstructor:Int16Array},float32:{numComponents:1,type:"FLOAT",normalized:!1,dataType:"float",byteSize:4,wgslType:"f32",typedArrayConstructor:Float32Array},float32x2:{numComponents:2,type:"FLOAT",normalized:!1,dataType:"float",byteSize:8,wgslType:"vec2<f32>",typedArrayConstructor:Float32Array},float32x3:{numComponents:3,type:"FLOAT",normalized:!1,dataType:"float",byteSize:12,wgslType:"vec3<f32>",typedArrayConstructor:Float32Array},float32x4:{numComponents:4,type:"FLOAT",normalized:!1,dataType:"float",byteSize:16,wgslType:"vec4<f32>",typedArrayConstructor:Float32Array},uint32:{numComponents:1,type:"UNSIGNED_INT",normalized:!1,dataType:"unsigned int",byteSize:4,wgslType:"u32",typedArrayConstructor:Uint32Array},uint32x2:{numComponents:2,type:"UNSIGNED_INT",normalized:!1,dataType:"unsigned int",byteSize:8,wgslType:"vec2<u32>",typedArrayConstructor:Uint32Array},uint32x3:{numComponents:3,type:"UNSIGNED_INT",normalized:!1,dataType:"unsigned int",byteSize:12,wgslType:"vec3<u32>",typedArrayConstructor:Uint32Array},uint32x4:{numComponents:4,type:"UNSIGNED_INT",normalized:!1,dataType:"unsigned int",byteSize:16,wgslType:"vec4<u32>",typedArrayConstructor:Uint32Array},sint32:{numComponents:1,type:"INT",normalized:!1,dataType:"signed int",byteSize:4,wgslType:"i32",typedArrayConstructor:Int32Array},sint32x2:{numComponents:2,type:"INT",normalized:!1,dataType:"signed int",byteSize:8,wgslType:"vec2<i32>",typedArrayConstructor:Int32Array},sint32x3:{numComponents:3,type:"INT",normalized:!1,dataType:"signed int",byteSize:12,wgslType:"vec3<i32>",typedArrayConstructor:Int32Array},sint32x4:{numComponents:4,type:"INT",normalized:!1,dataType:"signed int",byteSize:16,wgslType:"vec4<i32>",typedArrayConstructor:Int32Array},"unorm10-10-10-2":{numComponents:4,type:"UNSIGNED_INT_2_10_10_10_REV",normalized:!0,dataType:"unsigned normalized",byteSize:4,wgslType:"vec4<f32>",typedArrayConstructor:Int32Array}},ee={operation:"add",srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"};class Rn{static getBlendConstantColor(t){if(!t)return;const{color:n,alpha:s}=t;if((n==null?void 0:n.srcFactor)==="constant"||(n==null?void 0:n.srcFactor)==="one-minus-constant"||(n==null?void 0:n.dstFactor)==="constant"||(n==null?void 0:n.dstFactor)==="one-minus-constant"||(s==null?void 0:s.srcFactor)==="constant"||(s==null?void 0:s.srcFactor)==="one-minus-constant"||(s==null?void 0:s.dstFactor)==="constant"||(s==null?void 0:s.dstFactor)==="one-minus-constant"){const r=t.constantColor;return r||(r??[0,0,0,0])}}}class st{static getBuffer(t){let n=this.bufferMap.get(t);return n||(n={size:Math.ceil(t.byteLength/4)*4,data:t},this.bufferMap.set(t,n),n)}}ae(st,"bufferMap",new WeakMap);function kr(e){if(!e)return;const{stencilFront:t,stencilBack:n}=e;let s;if(t){const{failOp:r,depthFailOp:i,passOp:o}=t;(r==="replace"||i==="replace"||o==="replace")&&(s=(e==null?void 0:e.stencilReference)??0)}if(n){const{failOp:r,depthFailOp:i,passOp:o}=n;(r==="replace"||i==="replace"||o==="replace")&&(s=(e==null?void 0:e.stencilReference)??0)}return s}const Xr={view:void 0,clearValue:[0,0,0,0],loadOp:"clear"},Yr={addressModeU:"repeat",addressModeV:"repeat",addressModeW:"repeat",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",lodMinClamp:0,lodMaxClamp:16,compare:void 0,maxAnisotropy:1};class ft{static getTextureBytesPerPixel(t="rgba8unorm"){var n;const s=(n=ve[t])==null?void 0:n.bytesPerPixel;return console.assert(!!s,`未处理格式 ${t} ，无法查询到该格式中每个像素占用的字节数量！`),s}static getTextureDataConstructor(t="rgba8unorm"){var n;const s=(n=ve[t])==null?void 0:n.dataConstructor;return console.assert(!!s,`未处理格式 ${t} ，无法查询到该格式的纹理数据构造函数！`),s}}const ve={r8unorm:{bytesPerPixel:1,dataConstructor:Uint8Array},r8snorm:{bytesPerPixel:1,dataConstructor:Int8Array},r8uint:{bytesPerPixel:1,dataConstructor:Uint8Array},r8sint:{bytesPerPixel:1,dataConstructor:Int8Array},r16uint:{bytesPerPixel:2,dataConstructor:Uint16Array},r16sint:{bytesPerPixel:2,dataConstructor:Int16Array},r16float:{bytesPerPixel:2,dataConstructor:Uint16Array},rg8unorm:{bytesPerPixel:2,dataConstructor:Uint8Array},rg8snorm:{bytesPerPixel:2,dataConstructor:Int8Array},rg8uint:{bytesPerPixel:2,dataConstructor:Uint8Array},rg8sint:{bytesPerPixel:2,dataConstructor:Int8Array},r32uint:{bytesPerPixel:4,dataConstructor:Uint32Array},r32sint:{bytesPerPixel:4,dataConstructor:Int32Array},r32float:{bytesPerPixel:4,dataConstructor:Float32Array},rg16uint:{bytesPerPixel:4,dataConstructor:Uint16Array},rg16sint:{bytesPerPixel:4,dataConstructor:Int16Array},rg16float:{bytesPerPixel:4,dataConstructor:Uint16Array},rgba8unorm:{bytesPerPixel:4,dataConstructor:Uint8Array},"rgba8unorm-srgb":{bytesPerPixel:4,dataConstructor:Uint8Array},rgba8snorm:{bytesPerPixel:4,dataConstructor:Int8Array},rgba8uint:{bytesPerPixel:4,dataConstructor:Uint8Array},rgba8sint:{bytesPerPixel:4,dataConstructor:Int8Array},bgra8unorm:{bytesPerPixel:4,dataConstructor:Uint8Array},"bgra8unorm-srgb":{bytesPerPixel:4,dataConstructor:Uint8Array},rgb9e5ufloat:{bytesPerPixel:4,dataConstructor:Uint32Array},rgb10a2uint:{bytesPerPixel:4,dataConstructor:Uint32Array},rgb10a2unorm:{bytesPerPixel:4,dataConstructor:Uint32Array},rg11b10ufloat:{bytesPerPixel:4,dataConstructor:Uint32Array},rg32uint:{bytesPerPixel:8,dataConstructor:Uint32Array},rg32sint:{bytesPerPixel:8,dataConstructor:Int32Array},rg32float:{bytesPerPixel:8,dataConstructor:Float32Array},rgba16uint:{bytesPerPixel:8,dataConstructor:Uint16Array},rgba16sint:{bytesPerPixel:8,dataConstructor:Int16Array},rgba16float:{bytesPerPixel:8,dataConstructor:Uint16Array},rgba32uint:{bytesPerPixel:16,dataConstructor:Uint32Array},rgba32sint:{bytesPerPixel:16,dataConstructor:Int32Array},rgba32float:{bytesPerPixel:16,dataConstructor:Float32Array},stencil8:{bytesPerPixel:1,dataConstructor:Uint8Array},depth16unorm:{bytesPerPixel:2,dataConstructor:Uint16Array},depth24plus:{bytesPerPixel:3,dataConstructor:Uint8Array},"depth24plus-stencil8":{bytesPerPixel:4},depth32float:{bytesPerPixel:4},"depth32float-stencil8":{bytesPerPixel:5},"bc1-rgba-unorm":void 0,"bc1-rgba-unorm-srgb":void 0,"bc2-rgba-unorm":void 0,"bc2-rgba-unorm-srgb":void 0,"bc3-rgba-unorm":void 0,"bc3-rgba-unorm-srgb":void 0,"bc4-r-unorm":void 0,"bc4-r-snorm":void 0,"bc5-rg-unorm":void 0,"bc5-rg-snorm":void 0,"bc6h-rgb-ufloat":void 0,"bc6h-rgb-float":void 0,"bc7-rgba-unorm":void 0,"bc7-rgba-unorm-srgb":void 0,"etc2-rgb8unorm":void 0,"etc2-rgb8unorm-srgb":void 0,"etc2-rgb8a1unorm":void 0,"etc2-rgb8a1unorm-srgb":void 0,"etc2-rgba8unorm":void 0,"etc2-rgba8unorm-srgb":void 0,"eac-r11unorm":void 0,"eac-r11snorm":void 0,"eac-rg11unorm":void 0,"eac-rg11snorm":void 0,"astc-4x4-unorm":void 0,"astc-4x4-unorm-srgb":void 0,"astc-5x4-unorm":void 0,"astc-5x4-unorm-srgb":void 0,"astc-5x5-unorm":void 0,"astc-5x5-unorm-srgb":void 0,"astc-6x5-unorm":void 0,"astc-6x5-unorm-srgb":void 0,"astc-6x6-unorm":void 0,"astc-6x6-unorm-srgb":void 0,"astc-8x5-unorm":void 0,"astc-8x5-unorm-srgb":void 0,"astc-8x6-unorm":void 0,"astc-8x6-unorm-srgb":void 0,"astc-8x8-unorm":void 0,"astc-8x8-unorm-srgb":void 0,"astc-10x5-unorm":void 0,"astc-10x5-unorm-srgb":void 0,"astc-10x6-unorm":void 0,"astc-10x6-unorm-srgb":void 0,"astc-10x8-unorm":void 0,"astc-10x8-unorm-srgb":void 0,"astc-10x10-unorm":void 0,"astc-10x10-unorm-srgb":void 0,"astc-12x10-unorm":void 0,"astc-12x10-unorm-srgb":void 0,"astc-12x12-unorm":void 0,"astc-12x12-unorm-srgb":void 0};class Hr{static getTexImageSourceSize(t){let n,s;return t instanceof VideoFrame?(n=t.codedWidth,s=t.codedHeight):t instanceof HTMLVideoElement?(n=t.videoWidth,s=t.videoHeight):(n=t.width,s=t.height),[n,s]}}class Cn{constructor(){ae(this,"_map",new WeakMap),ae(this,"_size",0)}get size(){return this._size}get(t){const n=t.length;let s=this._map,r;for(let i=0,o=n-1;i<o;i++)if(r=lt(t[i]),s=s.get(r),s===void 0)return;return r=lt(t[n-1]),s.get(r)}set(t,n){const s=t.length;let r=this._map,i;for(let o=0;o<s-1;o++)i=lt(t[o]),r.has(i)||r.set(i,new WeakMap),r=r.get(i);return i=lt(t[s-1]),r.has(i)||(r.set(i,n),this._size++),n}delete(t){const n=t.length;let s=this._map,r;for(let o=0;o<n-1;o++)if(r=lt(t[o]),s=s.get(r),s===void 0)return!1;r=lt(t[n-1]);const i=s.delete(r);return i&&this._size--,i}}const ne=new Map;let Wn=0;function lt(e){if(typeof e=="object"&&e!==null)return e;if(ne.has(e))return ne.get(e);const n={__id:Wn++,__value:e};return ne.set(e,n),n}function Kr(e){return e}const Qe={isRunWebGPU:!1,isRunWebGL:!1};console.log("@feng3d/render-api v0.1.0");var Fn=Object.defineProperty,In=(e,t,n)=>t in e?Fn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,w=(e,t,n)=>In(e,typeof t!="symbol"?t+"":t,n),Ae,xe;const je=class ce{constructor(){w(this,"_value"),w(this,"_parents",new Map)}get value(){return this.track(),this._value}track(){if(!ce.activeReactivity||!ot)return;const t=ce.activeReactivity;t&&this._parents.set(t,t._version)}trigger(){this._parents.forEach((t,n)=>{n._version===t&&(n.trigger(),n._children.set(this,this._value))}),this._parents.clear()}};w(je,"activeReactivity");let B=je;function Pn(e){const t=ot;ot=!0;const n=e();return ot=t,n}function Nn(e){const t=ot;ot=!1;const n=e();return ot=t,n}let ot=!0;function qe(e,t){if(t){if(Rt.indexOf(e)!==-1)return;Rt.push(e)}else{if(wt.indexOf(e)!==-1)return;wt.push(e)}}function Zt(e){$e++;const t=e();if(!(--$e>0))return Rt.length>0&&(Rt.forEach(n=>{n._children.forEach((s,r)=>{r._parents.set(n,n._version)}),n._children.clear()}),Rt.length=0),wt.length>0&&(wt.forEach(n=>{const s=B.activeReactivity;B.activeReactivity=null,n.runIfDirty(),B.activeReactivity=s}),wt.length=0),t}let $e=0;const wt=[],Rt=[];function Qr(e){return new Ze(e)}class Ze extends B{constructor(t){super(),w(this,"__v_isRef",!0),w(this,"_func"),w(this,"_children",new Map),w(this,"_isDirty",!0),w(this,"_version",-1),this._func=t}get value(){return this.runIfDirty(),this.track(),this._value}trigger(){B.activeReactivity===this&&qe(this,B.activeReactivity===this),super.trigger()}run(){Pn(()=>{const t=B.activeReactivity;B.activeReactivity=this,this._version++,this._value=this._func(this._value),B.activeReactivity=t})}runIfDirty(){this._isDirty=this._isDirty||this.isChildrenChanged(),this._isDirty&&(this._isDirty=!1,this.run())}isChildrenChanged(){if(this._children.size===0)return!1;let t=!1;const n=B.activeReactivity;return B.activeReactivity=null,this._children.forEach((s,r)=>{if(!t&&r.value!==s){t=!0;return}}),B.activeReactivity=n,t||this._children.forEach((s,r)=>{r._parents.set(this,this._version)}),this._children.clear(),t}}var k=(e=>(e.IS_REACTIVE="__v_isReactive",e.RAW="__v_raw",e.IS_REF="__v_isRef",e))(k||{}),at=(e=>(e[e.INVALID=0]="INVALID",e[e.COMMON=1]="COMMON",e[e.COLLECTION=2]="COLLECTION",e))(at||{}),z=(e=>(e.GET="get",e.HAS="has",e.ITERATE="iterate",e))(z||{}),K=(e=>(e.SET="set",e.ADD="add",e.DELETE="delete",e.CLEAR="clear",e))(K||{});const ct=Symbol(""),ue=Symbol(""),It=Symbol("");globalThis.__DEV__??(globalThis.__DEV__=!0);const me=e=>e!==null&&typeof e=="object",St=Array.isArray,bt=e=>typeof e=="symbol",On=e=>typeof e=="string",Se=e=>On(e)&&e!=="NaN"&&e[0]!=="-"&&`${parseInt(e,10)}`===e,kt=e=>Je(e)==="[object Map]",fe=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),Ct=(e,t)=>!Object.is(e,t);function Un(e){switch(e){case"Object":case"Array":return at.COMMON;case"Map":case"Set":case"WeakMap":case"WeakSet":return at.COLLECTION;default:return at.COMMON}}function Mn(e){return Object.isExtensible(e)?Un(Bn(e)):at.INVALID}const Je=e=>Object.prototype.toString.call(e),Bn=e=>Je(e).slice(8,-1);function v(e){const t=e&&e[k.RAW];return t?v(t):e}function Dn(e){const t=Object.create(null);for(const n of e.split(","))t[n]=1;return n=>n in t}let H;class jr{constructor(t=!1){w(this,"_active",!0),w(this,"_on",0),w(this,"effects",[]),w(this,"cleanups",[]),w(this,"_isPaused",!1),w(this,"parent"),w(this,"scopes"),w(this,"index"),w(this,"prevScope"),this.detached=t,this.parent=H,!t&&H&&(this.index=(H.scopes||(H.scopes=[])).push(this)-1)}get active(){return this._active}pause(){if(this._active){this._isPaused=!0;let t,n;if(this.scopes)for(t=0,n=this.scopes.length;t<n;t++)this.scopes[t].pause();for(t=0,n=this.effects.length;t<n;t++)this.effects[t].pause()}}resume(){if(this._active&&this._isPaused){this._isPaused=!1;let t,n;if(this.scopes)for(t=0,n=this.scopes.length;t<n;t++)this.scopes[t].resume();for(t=0,n=this.effects.length;t<n;t++)this.effects[t].resume()}}run(t){if(this._active){const n=H;try{return H=this,t()}finally{H=n}}}on(){++this._on===1&&(this.prevScope=H,H=this)}off(){this._on>0&&--this._on===0&&(H=this.prevScope,this.prevScope=void 0)}stop(t){if(this._active){this._active=!1;let n,s;for(n=0,s=this.effects.length;n<s;n++)this.effects[n].stop();for(this.effects.length=0,n=0,s=this.cleanups.length;n<s;n++)this.cleanups[n]();if(this.cleanups.length=0,this.scopes){for(n=0,s=this.scopes.length;n<s;n++)this.scopes[n].stop(!0);this.scopes.length=0}if(!this.detached&&this.parent&&!t){const r=this.parent.scopes.pop();r&&r!==this&&(this.parent.scopes[this.index]=r,r.index=this.index)}this.parent=void 0}}}function le(e){return new zn(e)}const tn=class $t extends Ze{constructor(t){super(t),w(this,"_isEnable",!0),H&&H.active&&H.effects.push(this),this.runIfDirty()}pause(){this._isEnable=!1}resume(){this._isEnable||(this._isEnable=!0,$t.pausedQueueEffects.has(this)&&($t.pausedQueueEffects.delete(this),this.trigger()))}stop(){this._isEnable=!1,$t.pausedQueueEffects.delete(this)}trigger(){Zt(()=>{super.trigger(),this._isEnable?qe(this,B.activeReactivity===this):$t.pausedQueueEffects.add(this)})}run(){this._isEnable?super.run():this._func(this._value)}};w(tn,"pausedQueueEffects",new WeakSet);let zn=tn;function Vn(e,t){let n=x._targetMap.get(e);n||(n=new Map,x._targetMap.set(e,n));let s=n.get(t);return s||(s=new x(e,t),n.set(t,s)),s}class x extends B{constructor(t,n){super(),w(this,"_target"),w(this,"_key"),this._target=t,this._key=n,t instanceof Map||t instanceof WeakMap?this._value=t.get(n):t instanceof Set||t instanceof WeakSet?this._value=t.has(n):this._value=t[n]}get value(){return this.track(),this._value}set value(t){this._key==="length"?t=this._target.length:bt(this._key)&&(t=~~this._value+1),t!==this._value&&(this.trigger(),this._value=t)}triggerIfChanged(){}static track(t,n,s){if(!B.activeReactivity)return;Vn(t,s).track()}static trigger(t,n,s,r,i){const o=this._targetMap.get(t);if(!o)return;const a=c=>{c&&(c.value=r)};Zt(()=>{if(n===K.CLEAR)o.forEach(a);else{const c=St(t),u=c&&Se(s);if(c&&s==="length"){const l=Number(r);o.forEach((d,h)=>{(h==="length"||h===It||!bt(h)&&h>=l)&&a(d)})}else switch((s!==void 0||o.has(void 0))&&a(o.get(s)),u&&a(o.get(It)),n){case K.ADD:c?u&&a(o.get("length")):(a(o.get(ct)),kt(t)&&a(o.get(ue)));break;case K.DELETE:c||(a(o.get(ct)),kt(t)&&a(o.get(ue)));break;case K.SET:kt(t)&&a(o.get(ct));break}}})}}w(x,"_targetMap",new WeakMap);const kn={__proto__:null,[Symbol.iterator](){return se(this,Symbol.iterator,V)},concat(...e){return dt(this).concat(...e.map(t=>St(t)?dt(t):t))},entries(){return se(this,"entries",e=>(e[1]=V(e[1]),e))},every(e,t){return Z(this,"every",e,t,void 0,arguments)},filter(e,t){return Z(this,"filter",e,t,n=>n.map(V),arguments)},find(e,t){return Z(this,"find",e,t,V,arguments)},findIndex(e,t){return Z(this,"findIndex",e,t,void 0,arguments)},findLast(e,t){return Z(this,"findLast",e,t,V,arguments)},findLastIndex(e,t){return Z(this,"findLastIndex",e,t,void 0,arguments)},forEach(e,t){return Z(this,"forEach",e,t,void 0,arguments)},includes(...e){return re(this,"includes",e)},indexOf(...e){return re(this,"indexOf",e)},join(e){return dt(this).join(e)},lastIndexOf(...e){return re(this,"lastIndexOf",e)},map(e,t){return Z(this,"map",e,t,void 0,arguments)},pop(){return At(this,"pop")},push(...e){return At(this,"push",e)},reduce(e,...t){return we(this,"reduce",e,t)},reduceRight(e,...t){return we(this,"reduceRight",e,t)},shift(){return At(this,"shift")},some(e,t){return Z(this,"some",e,t,void 0,arguments)},splice(...e){return At(this,"splice",e)},toReversed(){return dt(this).toReversed()},toSorted(e){return dt(this).toSorted(e)},toSpliced(...e){return dt(this).toSpliced(...e)},unshift(...e){return At(this,"unshift",e)},values(){return se(this,"values",V)}};function se(e,t,n){const s=_e(e),r=s[t]();return s!==e&&(r._next=r.next,r.next=()=>{const i=r._next();return i.value&&(i.value=n(i.value)),i}),r}function _e(e){return x.track(e=v(e),z.ITERATE,It),e}function dt(e){const t=v(e);return t===e?t:(x.track(t,z.ITERATE,It),t.map(V))}function Z(e,t,n,s,r,i){const o=_e(e),a=o!==e,c=o[t];if(c!==Array.prototype[t]){const d=c.apply(e,i);return a?V(d):d}let u=n;o!==e&&(a?u=function(d,h){return n.call(this,V(d),h,e)}:n.length>2&&(u=function(d,h){return n.call(this,d,h,e)}));const l=c.call(o,u,s);return a&&r?r(l):l}function we(e,t,n,s){const r=_e(e);let i=n;return r!==e&&(i=function(o,a,c){return n.call(this,o,V(a),c,e)}),r[t](i,...s)}function re(e,t,n){const s=v(e);x.track(s,z.ITERATE,It);const r=s[t](...n);return(r===-1||r===!1)&&ts(n[0])?(n[0]=v(n[0]),s[t](...n)):r}function At(e,t,n=[]){return Zt(()=>Nn(()=>v(e)[t].apply(e,n)))}function Wt(e){return e?e[k.IS_REF]===!0:!1}class qr extends(xe=B,Ae=k.IS_REF,xe){constructor(t){super(),w(this,Ae,!0),w(this,"_rawValue"),this._rawValue=v(t),this._value=V(t)}get value(){return this.track(),this._value}set value(t){const n=this._rawValue,s=v(t);Ct(n,s)&&Zt(()=>{this.trigger(),this._rawValue=s,this._value=V(s)})}}class Xn{get(t,n,s){if(n===k.IS_REACTIVE)return!0;if(n===k.RAW)return s===de.get(t)||Object.getPrototypeOf(t)===Object.getPrototypeOf(s)?t:void 0;const r=St(t);let i;if(r&&(i=kn[n]))return i;if(n==="hasOwnProperty")return Kn;const o=Reflect.get(t,n,Wt(t)?t:s);return(bt(n)?en.has(n):Qn(n))?o:(x.track(t,z.GET,n),Wt(o)?r&&Se(n)?o:o.value:me(o)?tt(o):o)}}class Yn extends Xn{set(t,n,s,r){let i=t[n];if(i=v(i),s=v(s),!St(t)&&Wt(i)&&!Wt(s))return i.value=s,!0;const o=St(t)&&Se(n)?Number(n)<t.length:fe(t,n),a=Reflect.set(t,n,s,Wt(t)?t:r);return t===v(r)&&(o?Ct(s,i)&&x.trigger(t,K.SET,n,s,i):x.trigger(t,K.ADD,n,s)),a}deleteProperty(t,n){const s=fe(t,n),r=t[n],i=Reflect.deleteProperty(t,n);return i&&s&&x.trigger(t,K.DELETE,n,void 0,r),i}has(t,n){const s=Reflect.has(t,n);return(!bt(n)||!en.has(n))&&x.track(t,z.HAS,n),s}ownKeys(t){return x.track(t,z.ITERATE,St(t)?"length":ct),Reflect.ownKeys(t)}}const Hn=new Yn;function Kn(e){bt(e)||(e=String(e));const t=v(this);return x.track(t,z.HAS,e),t.hasOwnProperty(e)}const en=new Set(Object.getOwnPropertyNames(Symbol).filter(e=>e!=="arguments"&&e!=="caller").map(e=>Symbol[e]).filter(bt)),Qn=Dn("__proto__,__v_isRef,__isVue"),jn={get:qn()};function qn(){const e=Zn();return(t,n,s)=>n===k.IS_REACTIVE?!0:n===k.RAW?t:Reflect.get(fe(e,n)&&n in t?e:t,n,s)}function Zn(){const e={get(n){const s=this[k.RAW],r=v(s),i=v(n);Ct(n,i)&&x.track(r,z.GET,n),x.track(r,z.GET,i);const{has:o}=Mt(r),a=V;if(o.call(r,n))return a(s.get(n));if(o.call(r,i))return a(s.get(i));s!==r&&s.get(n)},get size(){const n=this[k.RAW];return x.track(v(n),z.ITERATE,ct),Reflect.get(n,"size",n)},has(n){const s=this[k.RAW],r=v(s),i=v(n);return Ct(n,i)&&x.track(r,z.HAS,n),x.track(r,z.HAS,i),n===i?s.has(n):s.has(n)||s.has(i)},forEach(n,s){const r=this,i=r[k.RAW],o=v(i),a=V;return x.track(o,z.ITERATE,ct),i.forEach((c,u)=>n.call(s,a(c),a(u),r))},add(n){n=v(n);const s=v(this);return Mt(s).has.call(s,n)||(s.add(n),x.trigger(s,K.ADD,n,n)),this},set(n,s){s=v(s);const r=v(this),{has:i,get:o}=Mt(r);let a=i.call(r,n);a||(n=v(n),a=i.call(r,n));const c=o.call(r,n);return r.set(n,s),a?Ct(s,c)&&x.trigger(r,K.SET,n,s,c):x.trigger(r,K.ADD,n,s),this},delete(n){const s=v(this),{has:r,get:i}=Mt(s);let o=r.call(s,n);o||(n=v(n),o=r.call(s,n));const a=i?i.call(s,n):void 0,c=s.delete(n);return o&&x.trigger(s,K.DELETE,n,void 0,a),c},clear(){const n=v(this),s=n.size!==0,r=void 0,i=n.clear();return s&&x.trigger(n,K.CLEAR,void 0,void 0,r),i}};return["keys","values","entries",Symbol.iterator].forEach(n=>{e[n]=Jn(n)}),e}function Jn(e){return function(...t){const n=this[k.RAW],s=v(n),r=kt(s),i=e==="entries"||e===Symbol.iterator&&r,o=e==="keys"&&r,a=n[e](...t),c=V;return x.track(s,z.ITERATE,o?ue:ct),{next(){const{value:u,done:l}=a.next();return l?{value:u,done:l}:{value:i?[c(u[0]),c(u[1])]:c(u),done:l}},[Symbol.iterator](){return this}}}}const Mt=e=>Reflect.getPrototypeOf(e);function tt(e){if(!me(e)||e[k.RAW])return e;const t=Mn(e);if(t===at.INVALID)return e;const n=de.get(e);if(n)return n;const s=new Proxy(e,t===at.COLLECTION?jn:Hn);return de.set(e,s),s}const de=new WeakMap,V=e=>me(e)?tt(e):e;function ts(e){return e?!!e[k.RAW]:!1}console.log("@feng3d/reactivity v1.0.12");class es{constructor(){this._binds=[]}on(){const t=[],n={watch:(s,r,i,o,a=!0,c,u)=>(this.watch(s,r,i,o,a,c,u),t.push(()=>this.unwatch(s,r,i,o)),n),watchs:(s,r,i,o,a)=>(this.watchs(s,r,i,o,a),t.push(()=>this.unwatchs(s,r,i,o)),n),bind:(s,r,i,o)=>(this.bind(s,r,i,o),t.push(()=>this.unbind(s,r,i,o)),n),watchchain:(s,r,i,o,a=!0,c,u)=>(this.watchchain(s,r,i,o,a,c,u),t.push(()=>this.unwatchchain(s,r,i,o)),n),watchobject:(s,r,i,o,a=!0)=>(this.watchobject(s,r,i,o,a),t.push(()=>this.unwatchobject(s,r,i,o)),n),off:()=>{t.forEach(s=>s()),t.length=0}};return n}watch(t,n,s,r,i=!0,o,a){o=o||t,a=a||n,Object.getOwnPropertyDescriptor(t,J)||Object.defineProperty(t,J,{value:{},enumerable:!1,configurable:!0,writable:!1});const c=n,u=t[J];if(!u[c]){const h=Object.getOwnPropertyDescriptor(t,c);u[c]={value:t[c],oldPropertyDescriptor:h,handlers:[]};let f=nn(t,c);if(f&&f.set&&f.get){f={enumerable:f.enumerable,configurable:!0,get:f.get,set:f.set};const S=f.set;f.set=function(m){const L=this[c];S&&S.call(this,m),Re(m,L,this,c,o,a)}}else if(!f||!f.get&&!f.set)f={enumerable:!0,configurable:!0},f.get=function(){return this[J][c].value},f.set=function(S){const m=this[J][c].value;this[J][c].value=S,Re(S,m,this,c,o,a)};else{console.warn("无法修改监听属性的描述，监听失败！",t,c,s,r);return}Object.defineProperty(t,c,f)}const l=u[c];l.handlers.reduce((h,f)=>h||f.handler===s&&f.thisObject===r,!1)?console.warn("重复监听， 监听失败！",t,c,s,r):l.handlers.push({handler:s,thisObject:r,onlyChanged:i})}unwatch(t,n,s,r){const i=t[J];if(!i)return;const o=n;if(i[o]){const a=i[o].handlers;s===void 0&&(a.length=0);for(let c=a.length-1;c>=0;c--)a[c].handler===s&&(a[c].thisObject===r||r===void 0)&&a.splice(c,1);if(a.length===0){const c=t[o];delete t[o],i[o].oldPropertyDescriptor&&Object.defineProperty(t,o,i[o].oldPropertyDescriptor),t[o]=c,delete i[o]}Object.keys(i).length===0&&delete t[J]}}watchs(t,n,s,r,i=!0){n.forEach(o=>{this.watch(t,o,s,r,i)})}unwatchs(t,n,s,r){n.forEach(i=>{this.unwatch(t,i,s,r)})}bind(t,n,s,r){const i=()=>{s[r]=t[n]},o=()=>{t[n]=s[r]};this.watch(t,n,i),this.watch(s,r,o),this._binds.push([t,n,i,s,r,o])}unbind(t,n,s,r){const i=this._binds;for(let o=i.length-1;o>=0;o--){const a=i[o];if((a[1]===n&&a[4]===r||a[1]===r&&a[4]===n)&&(a[0]===t&&a[3]===s||a[0]===s&&a[3]===t)){this.unwatch(a[0],a[1],a[2]),this.unwatch(a[3],a[4],a[5]),i.splice(o,1);break}}}watchchain(t,n,s,r,i=!0,o,a){o=o||t,a=a||n;const c=n.indexOf(".");if(c===-1){this.watch(t,n,s,r,i,o,a);return}Object.getOwnPropertyDescriptor(t,xt)||Object.defineProperty(t,xt,{value:{},enumerable:!1,writable:!1,configurable:!0});const u=t[xt];u[n]||(u[n]=[]);const l=u[n];if(!l.reduce((h,f)=>h||f.handler===s&&f.thisObject===r,!1)){const h=n.substr(0,c),f=n.substr(c+1);t[h]&&this.watchchain(t[h],f,s,r,i,o,a);const S=(m,L)=>{L&&this.unwatchchain(L,f,s,r),m&&this.watchchain(m,f,s,r,i,o,a);const _=Ce(L,f),b=Ce(m,f);(!i||_!==b)&&s.call(r,b,_,o,a)};this.watch(t,h,S,void 0,i),l.push({handler:s,thisObject:r,watchchainFun:S})}}unwatchchain(t,n,s,r){const i=n.indexOf(".");if(i===-1){this.unwatch(t,n,s,r);return}const o=n.substr(0,i),a=n.substr(i+1),c=t[xt];if(!c||!c[n])return;const u=c[n];for(let l=u.length-1;l>=0;l--){const d=u[l];(Ge(s)||s===d.handler&&r===d.thisObject)&&(t[o]&&this.unwatchchain(t[o],a,d.handler,d.thisObject),this.unwatch(t,o,d.watchchainFun),u.splice(l,1))}u.length===0&&delete c[n],Object.keys(c).length===0&&delete t[xt]}watchobject(t,n,s,r,i=!0){We(n).forEach(a=>{this.watchchain(t,a,s,r,i)})}unwatchobject(t,n,s,r){We(n).forEach(o=>{this.unwatchchain(t,o,s,r)})}}const et=new es,J="__watchs__",xt="__watchchains__";function Re(e,t,n,s,r,i){r=r||n,i=i||s,n[J][s].handlers.concat().forEach(c=>{(!c.onlyChanged||e!==t)&&c.handler.call(c.thisObject,e,t,r,i)})}function nn(e,t){const n=Object.getOwnPropertyDescriptor(e,t);if(n)return n;const s=Object.getPrototypeOf(e);if(s)return nn(s,t)}function Ge(e){return e==null}function Ce(e,t){typeof t=="string"&&(t=t.split("."));let n=e;for(let s=0;s<t.length;s++){if(Ge(n))return;n=n[t[s]]}return n}function We(e){const t=[],n=Object.keys(e),s=new Array(n.length).fill(e),r=new Array(n.length).fill(-1);let i=0;for(;i<n.length;){const o=s[i],a=n[i],c=o[a];let u;if(Ge(c)||ns(c)||(u=Object.keys(c)).length===0){const l=[a];let d=i;for(;(d=r[d])!==-1;)l.push(n[d]);l.reverse(),t.push(l.join("."))}else u.forEach(l=>{n.push(l),s.push(c),r.push(i)});i++}return t}function ns(e){return e==null||typeof e=="boolean"||typeof e=="string"||typeof e=="number"}var ss=Object.defineProperty,rs=(e,t,n)=>t in e?ss(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,F=(e,t,n)=>rs(e,typeof t!="symbol"?t+"":t,n);const is={depth:!0,stencil:!0,antialias:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1},os=["if","ifdef","defined"];class as{getMacroVariablesFromShaderCode(t,n){const s=this.getMacroVariablesFromCode(t),r=this.getMacroVariablesFromCode(n);for(let i=0;i<r.length;i++){const o=r[i];s.indexOf(o)===-1&&s.push(o)}return s}getMacroVariablesFromCode(t){const n=[],s=t.split(`
`);for(let r=0;r<s.length;r++){const i=s[r];if(i.indexOf("#if")!==-1){const o=/(\w+)/g;let a=o.exec(i);for(;a;){const c=a[1];c!==null&&isNaN(Number(c))&&os.indexOf(c)===-1&&n.indexOf(c)===-1&&n.push(c),a=o.exec(i)}}}return n}}const Fe=new as,cs={shaders:{},modules:{}};class us{constructor(){F(this,"_shaderConfig"),F(this,"_shaderCache",{})}get shaderConfig(){return this._shaderConfig=this._shaderConfig||cs,this._shaderConfig}set shaderConfig(t){this._shaderConfig=t}getShaderCodeWithMacro(t,n){const s=Bt.getShader(t),i=this.getMacroCode(s.vertexMacroVariables,n)+s.vertex,a=this.getMacroCode(s.fragmentMacroVariables,n)+s.fragment;return{vertex:i,fragment:a}}getShader(t){if(this._shaderCache[t])return this._shaderCache[t];const n=Bt.shaderConfig.shaders[t],s=Bt.uninclude(n.vertex),r=Bt.uninclude(n.fragment),i=Fe.getMacroVariablesFromCode(s),o=Fe.getMacroVariablesFromCode(r);return this._shaderCache[t]={vertex:s,fragment:r,vertexMacroVariables:i,fragmentMacroVariables:o},this._shaderCache[t]}uninclude(t){const n=/#include<(.+)>/g;let s=n.exec(t);for(;s;){let r=this.shaderConfig.modules[s[1]];r||console.error(`无法找到着色器 ${s[1]}`),r=this.uninclude(r),t=t.replace(s[0],r),n.lastIndex=0,s=n.exec(t)}return t}getShaderNames(){return Object.keys(this.shaderConfig.shaders)}clearCache(){this._shaderCache={}}getMacroCode(t,n){let s="";return t.forEach(r=>{const i=n[r];typeof i=="boolean"?i&&(s+=`#define ${r}
`):typeof i=="number"&&(s+=`#define ${r} ${i}
`)}),s.length>0?`${s}
`:s}}const Bt=new us;function gt(e,t,n,s="STATIC_DRAW"){let r=e._bufferMap.get(t);if(r)return r;r=e.createBuffer(),e._bufferMap.set(t,r);const i=t.size;e.bindBuffer(e[n],r),e.bufferData(e[n],i,e[s]);const o=u=>{const l=u.bufferOffset??0;let d=u.data;u.size&&(d=new Uint8Array(d.buffer,d.byteOffset,u.size*d.BYTES_PER_ELEMENT)),e.bufferSubData(e[n],l,d)},a=tt(t),c=[];return c.push(le(()=>{a.data,t.data&&(e.bindBuffer(e[n],r),o({data:new Uint8Array(t.data)}))})),c.push(le(()=>{var u;(u=a.writeBuffers)==null||u.forEach(()=>{});const l=t.writeBuffers;l&&(e.bindBuffer(e[n],r),l.forEach(o),Qe.isRunWebGPU?setTimeout(()=>{tt(t).writeBuffers=null},0):tt(t).writeBuffers=null)})),r.destroy=()=>{c.forEach(u=>u.stop())},r}function fs(e,t){const n=e._bufferMap.get(t);n&&(e._bufferMap.delete(t),n.destroy(),delete n.destroy,e.deleteBuffer(n))}class ls{constructor(t,n="highp"){F(this,"_maxAnisotropy"),F(this,"_maxTextures"),F(this,"_maxVertexTextures"),F(this,"_maxTextureSize"),F(this,"_maxCubemapSize"),F(this,"_maxAttributes"),F(this,"_maxVertexUniforms"),F(this,"_maxVaryings"),F(this,"_maxFragmentUniforms"),F(this,"_vertexTextures"),F(this,"_floatFragmentTextures"),F(this,"_floatVertexTextures"),F(this,"_maxPrecision"),F(this,"_maxSamples"),F(this,"_stencilBits"),F(this,"_vaoAvailable"),this._gl=t,this._precision=n}get maxAnisotropy(){return this._maxAnisotropy?this._maxAnisotropy:(this._maxAnisotropy=this._gl.getExtension("EXT_texture_filter_anisotropic")?this._gl.getParameter(this._gl.getExtension("EXT_texture_filter_anisotropic").MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._maxAnisotropy)}get maxTextures(){return this._maxTextures?this._maxTextures:(this._maxTextures=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),this._maxTextures)}get maxVertexTextures(){return this._maxVertexTextures?this._maxVertexTextures:(this._maxVertexTextures=this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxVertexTextures)}get maxTextureSize(){return this._maxTextureSize?this._maxTextureSize:(this._maxTextureSize=this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),this._maxTextureSize)}get maxCubemapSize(){return this._maxCubemapSize?this._maxCubemapSize:(this._maxCubemapSize=this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),this._maxCubemapSize)}get maxAttributes(){return this._maxAttributes?this._maxAttributes:(this._maxAttributes=this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),this._maxAttributes)}get maxVertexUniforms(){return this._maxVertexUniforms?this._maxVertexUniforms:(this._maxVertexUniforms=this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),this._maxVertexUniforms)}get maxVaryings(){return this._maxVaryings?this._maxVaryings:(this._maxVaryings=this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),this._maxVaryings)}get maxFragmentUniforms(){return this._maxFragmentUniforms?this._maxFragmentUniforms:(this._maxFragmentUniforms=this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxFragmentUniforms)}get vertexTextures(){return this._vertexTextures?this._vertexTextures:(this._vertexTextures=this.maxVertexTextures>0,this._vertexTextures)}get floatFragmentTextures(){return this._floatFragmentTextures?this._floatFragmentTextures:(this._floatFragmentTextures=this._gl instanceof WebGL2RenderingContext||!!this._gl.getExtension("OES_texture_float"),this._floatFragmentTextures)}get floatVertexTextures(){return this._floatVertexTextures?this._floatVertexTextures:(this._floatVertexTextures=this.vertexTextures&&this.floatFragmentTextures,this._floatVertexTextures)}get maxPrecision(){return this._maxPrecision?this._maxPrecision:(this._maxPrecision=ds(this._gl,this._precision),this._maxPrecision)}get maxSamples(){return this._maxSamples?this._maxSamples:(this._maxSamples=this._gl instanceof WebGL2RenderingContext?this._gl.getParameter(this._gl.MAX_SAMPLES):0,this._maxSamples)}get stencilBits(){return this._stencilBits?this._stencilBits:(this._stencilBits=this._gl.getParameter(this._gl.STENCIL_BITS),this._stencilBits)}get vaoAvailable(){return this._vaoAvailable?this._vaoAvailable:(this._vaoAvailable=this._gl instanceof WebGL2RenderingContext||!!this._gl.getExtension("OES_vertex_array_object"),this._vaoAvailable)}}function ds(e,t="highp"){if(t==="highp"){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";t="mediump"}return t==="mediump"&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}function hs(e){let t=e._gl;if(t)return t;const n=typeof e.canvasId=="string"?document.getElementById(e.canvasId):e.canvasId;return t=e._gl=Ss(n,e),e.webGLContextAttributes,t._capabilities=new ls(t),t._bufferMap=new WeakMap,t._textures=new WeakMap,t._renderbuffers=new WeakMap,t._framebuffers=new WeakMap,t._vertexArrays=new Cn,t._samplers=new WeakMap,t._transforms=new WeakMap,t._programs={},t._shaders={},n.addEventListener("webglcontextlost",ps,!1),n.addEventListener("webglcontextrestored",Ls,!1),n.addEventListener("webglcontextcreationerror",ms,!1),t}function ps(e){e.preventDefault(),console.warn("WebGLRenderer: Context Lost.")}function Ls(){console.warn("WebGLRenderer: Context Restored.")}function ms(e){console.error("WebGLRenderer: A WebGL context could not be created. Reason: ",e.statusMessage)}function Ss(e,t){const n=Object.assign({},is,t.webGLContextAttributes);let s=e.getContext(t.webGLcontextId||"webgl2",n);return s||console.warn("无法使用用户提供参数获取指定WebGL上下文",n),s=e.getContext("webgl2",n)||e.getContext("webgl2")||e.getContext("webgl",n)||e.getContext("webgl"),s||console.error("无法获取WebGL上下文。"),s}function _s(e,t,n){let s=e._renderbuffers.get(t);if(s)return s;s=e.createRenderbuffer(),e._renderbuffers.set(t,s);const{internalformat:r,width:i,height:o}=t;return e.bindRenderbuffer(e.RENDERBUFFER,s),n===4&&e instanceof WebGL2RenderingContext?e.renderbufferStorageMultisample(e.RENDERBUFFER,n,e[r],i,o):e.renderbufferStorage(e.RENDERBUFFER,e[r],i,o),s}function sn(e,t){const n=e._renderbuffers.get(t);e._renderbuffers.delete(t),e.deleteRenderbuffer(n)}function _t(e="rgba8unorm"){const t=Gs[e];return console.assert(!!t,`未处理格式 ${e}；或者WebGL不支持纹理， 该格式只在WebGPU中支持！`),t}const Gs={r8unorm:{internalformat:"R8",format:"RED",type:"UNSIGNED_BYTE"},r8snorm:void 0,r8uint:{internalformat:"R8",format:"RED",type:"UNSIGNED_BYTE"},r8sint:void 0,r16uint:void 0,r16sint:void 0,r16float:{internalformat:"R16F",format:"RED",type:"HALF_FLOAT"},rg8unorm:{internalformat:"RG8",format:"RG",type:"UNSIGNED_BYTE"},rg8snorm:void 0,rg8uint:{internalformat:"RG8UI",format:"RG_INTEGER",type:"UNSIGNED_BYTE"},rg8sint:void 0,r32uint:void 0,r32sint:void 0,r32float:{internalformat:"R32F",format:"RED",type:"FLOAT"},rg16uint:void 0,rg16sint:void 0,rg16float:{internalformat:"RG16F",format:"RG",type:"HALF_FLOAT"},rgba8unorm:{internalformat:"RGBA8",format:"RGBA",type:"UNSIGNED_BYTE"},"rgba8unorm-srgb":{internalformat:"SRGB8_ALPHA8",format:"RGBA",type:"UNSIGNED_BYTE"},rgba8snorm:void 0,rgba8uint:{internalformat:"RGBA8UI",format:"RGBA_INTEGER",type:"UNSIGNED_BYTE"},rgba8sint:void 0,bgra8unorm:{internalformat:"RGBA8",format:"RGBA",type:"UNSIGNED_BYTE"},"bgra8unorm-srgb":void 0,rgb9e5ufloat:{internalformat:"RGB9_E5",format:"RGB",type:"HALF_FLOAT"},rgb10a2uint:void 0,rgb10a2unorm:{internalformat:"RGB10_A2",format:"RGBA",type:"UNSIGNED_INT_2_10_10_10_REV"},rg11b10ufloat:{internalformat:"R11F_G11F_B10F",format:"RGB",type:"UNSIGNED_INT_10F_11F_11F_REV"},rg32uint:void 0,rg32sint:void 0,rg32float:{internalformat:"RG32F",format:"RG",type:"FLOAT"},rgba16uint:void 0,rgba16sint:void 0,rgba16float:{internalformat:"RGBA16F",format:"RGBA",type:"HALF_FLOAT"},rgba32uint:void 0,rgba32sint:void 0,rgba32float:{internalformat:"RGBA32F",format:"RGBA",type:"FLOAT"},stencil8:void 0,depth16unorm:{internalformat:"DEPTH_COMPONENT16",format:"DEPTH_COMPONENT",type:"UNSIGNED_SHORT"},depth24plus:void 0,"depth24plus-stencil8":void 0,depth32float:void 0,"depth32float-stencil8":void 0,"bc1-rgba-unorm":void 0,"bc1-rgba-unorm-srgb":void 0,"bc2-rgba-unorm":void 0,"bc2-rgba-unorm-srgb":void 0,"bc3-rgba-unorm":void 0,"bc3-rgba-unorm-srgb":void 0,"bc4-r-unorm":void 0,"bc4-r-snorm":void 0,"bc5-rg-unorm":void 0,"bc5-rg-snorm":void 0,"bc6h-rgb-ufloat":void 0,"bc6h-rgb-float":void 0,"bc7-rgba-unorm":void 0,"bc7-rgba-unorm-srgb":void 0,"etc2-rgb8unorm":void 0,"etc2-rgb8unorm-srgb":void 0,"etc2-rgb8a1unorm":void 0,"etc2-rgb8a1unorm-srgb":void 0,"etc2-rgba8unorm":void 0,"etc2-rgba8unorm-srgb":void 0,"eac-r11unorm":void 0,"eac-r11snorm":void 0,"eac-rg11unorm":void 0,"eac-rg11snorm":void 0,"astc-4x4-unorm":void 0,"astc-4x4-unorm-srgb":void 0,"astc-5x4-unorm":void 0,"astc-5x4-unorm-srgb":void 0,"astc-5x5-unorm":void 0,"astc-5x5-unorm-srgb":void 0,"astc-6x5-unorm":void 0,"astc-6x5-unorm-srgb":void 0,"astc-6x6-unorm":void 0,"astc-6x6-unorm-srgb":void 0,"astc-8x5-unorm":void 0,"astc-8x5-unorm-srgb":void 0,"astc-8x6-unorm":void 0,"astc-8x6-unorm-srgb":void 0,"astc-8x8-unorm":void 0,"astc-8x8-unorm-srgb":void 0,"astc-10x5-unorm":void 0,"astc-10x5-unorm-srgb":void 0,"astc-10x6-unorm":void 0,"astc-10x6-unorm-srgb":void 0,"astc-10x8-unorm":void 0,"astc-10x8-unorm-srgb":void 0,"astc-10x10-unorm":void 0,"astc-10x10-unorm-srgb":void 0,"astc-12x10-unorm":void 0,"astc-12x10-unorm-srgb":void 0,"astc-12x12-unorm":void 0,"astc-12x12-unorm-srgb":void 0};function bs(e){if(e[mt])return e[mt];const n=e.colorAttachments[0].view.texture.descriptor.size,s=[],r={colorAttachments:e.colorAttachments.map(o=>{const a=o.view.texture,c={internalformat:gs(a.descriptor.format),width:n[0],height:n[1]};return s.push(c),{...o,view:c}}),depthStencilAttachment:e.depthStencilAttachment,sampleCount:e.sampleCount},i={__type__:"BlitFramebuffer",read:r,draw:e,blitFramebuffers:[[0,0,n[0],n[1],0,0,n[0],n[1],"COLOR_BUFFER_BIT","NEAREST"]]};return e[mt]={passDescriptor:r,blitFramebuffer:i,renderbuffers:s},e[mt]}function gs(e){const{internalformat:t}=_t(e);return t}const mt="_IGLRenderPassDescriptorWithMultisample";function Pt(e="2d"){const t=ys[e];return console.assert(!!t,`WebGL 不支持纹理维度 ${e} , 该维度只在WebGPU中支持！`),t}const ys={"1d":void 0,"2d":"TEXTURE_2D","2d-array":"TEXTURE_2D_ARRAY",cube:"TEXTURE_CUBE_MAP","cube-array":void 0,"3d":"TEXTURE_3D"},Ts={packAlignment:4,unpackAlignment:4,unpackFlipY:!1,unpackPremulAlpha:!1,unpackColorSpaceConversion:"BROWSER_DEFAULT_WEBGL",packRowLength:0,packSkipPixels:0,packSkipRows:0,unpackRowLength:0,unpackImageHeight:0,unpackSkipPixels:0,unpackSkipRows:0,unpackSkipImages:0};function he(e,t){let n=e._textures.get(t);if(n)return n;(()=>{const c=t.descriptor,u=Pt(c.dimension),{internalformat:l,format:d,type:h}=_t(c.format);n=e.createTexture(),e._textures.set(t,n),e.bindTexture(e[u],n);const{sources:f}=t,S=c.generateMipmap,[m,L,_]=c.size,b=c.mipLevelCount||1;if(f)f.forEach(T=>{const{textureOrigin:E,size:R}=T,U=T.mipLevel??0,P=R==null?void 0:R[0],j=R==null?void 0:R[1];R==null||R[2],E==null||E[0],E==null||E[1];const q=E==null?void 0:E[2];if(e instanceof WebGL2RenderingContext){const D=T;if(D.image){const{image:M,imageOrigin:N,flipY:$,premultipliedAlpha:A}=D,C={};if(C.unpackSkipPixels=(N==null?void 0:N[0])||0,C.unpackSkipRows=(N==null?void 0:N[1])||0,C.unpackFlipY=$||!1,C.unpackPremulAlpha=A||!1,ht(e,C),u==="TEXTURE_2D"||u==="TEXTURE_CUBE_MAP"){const W=u==="TEXTURE_CUBE_MAP"?nt(q):u;P&&j?e.texImage2D(e[W],U,e[l],P,j,0,e[d],e[h],M):e.texImage2D(e[W],U,e[l],e[d],e[h],M)}else u==="TEXTURE_3D"||u==="TEXTURE_2D_ARRAY"?e.texImage3D(e[u],U,e[l],P,j,_,0,e[d],e[h],M):console.error(`未处理 ${u} 纹理初始化存储！`)}else{const M=T,{data:N,dataLayout:$,dataImageOrigin:A}=M,C=($==null?void 0:$.offset)||0,W={};if(W.unpackSkipPixels=(A==null?void 0:A[0])||0,W.unpackSkipRows=(A==null?void 0:A[1])||0,W.unpackSkipImages=(A==null?void 0:A[2])||0,W.unpackRowLength=$==null?void 0:$.width,W.unpackImageHeight=$==null?void 0:$.height,ht(e,W),u==="TEXTURE_2D"||u==="TEXTURE_CUBE_MAP"){const Et=u==="TEXTURE_CUBE_MAP"?nt(q):u;e.texImage2D(e[Et],U,e[l],P,j,0,e[d],e[h],N,C)}else u==="TEXTURE_3D"||u==="TEXTURE_2D_ARRAY"?e.texImage3D(e[u],U,e[l],P,j,_,0,e[d],e[h],N,C):console.error(`未处理 ${u} 纹理初始化存储！`)}}else{const D=T;if(D.image){const{image:M,imageOrigin:N,flipY:$,premultipliedAlpha:A}=D,C={};if(C.unpackSkipPixels=(N==null?void 0:N[0])||0,C.unpackSkipRows=(N==null?void 0:N[1])||0,C.unpackFlipY=$||!1,C.unpackPremulAlpha=A||!1,ht(e,C),u==="TEXTURE_2D"||u==="TEXTURE_CUBE_MAP"){const W=u==="TEXTURE_CUBE_MAP"?nt(q):u;e.texImage2D(e[W],U,e[d],e[d],e[h],M)}else console.error(`未处理 ${u} 纹理初始化存储！`)}else{const M=T,{data:N,dataLayout:$,dataImageOrigin:A}=M,C=($==null?void 0:$.offset)||0,W={};if(W.unpackSkipPixels=(A==null?void 0:A[0])||0,W.unpackSkipRows=(A==null?void 0:A[1])||0,W.unpackSkipImages=(A==null?void 0:A[2])||0,W.unpackRowLength=$==null?void 0:$.width,W.unpackImageHeight=$==null?void 0:$.height,ht(e,W),u==="TEXTURE_2D"||u==="TEXTURE_CUBE_MAP"){const Et=u==="TEXTURE_CUBE_MAP"?nt(q):u;console.assert(C===0,"WebGL1中ITextureDataLayout.offset必须为0"),e.texImage2D(e[Et],U,e[d],P,j,0,e[d],e[h],N)}else console.error(`未处理 ${u} 纹理初始化存储！`)}}}),S&&e.generateMipmap(e[u]);else if(e instanceof WebGL2RenderingContext)u==="TEXTURE_2D"||u==="TEXTURE_CUBE_MAP"?e.texStorage2D(e[u],b,e[l],m,L):u==="TEXTURE_3D"||u==="TEXTURE_2D_ARRAY"?e.texStorage3D(e[u],b,e[l],m,L,_):console.error(`未处理 ${u} 纹理初始化存储！`);else if(u==="TEXTURE_2D"||u==="TEXTURE_CUBE_MAP")for(let T=0;T<b;T++)e.texImage2D(e[u],T,e[d],m,L,0,e[d],e[h],null);else console.error(`未处理 ${u} 纹理初始化存储！`)})();const r=()=>{n.destroy()};et.watch(t,"sources",r);const i=()=>{const{writeTextures:c}=t;if(!c||c.length===0)return;const u=t.descriptor,l=Pt(u.dimension),{format:d,type:h}=_t(u.format);e.bindTexture(e[l],n),c.forEach(f=>{const{mipLevel:S,textureOrigin:m,size:L}=f,_=L==null?void 0:L[0],b=L==null?void 0:L[1],T=L==null?void 0:L[2],E=m==null?void 0:m[0],R=m==null?void 0:m[1],U=m==null?void 0:m[2],P=f;if(P.image){const{image:A,imageOrigin:C,flipY:W,premultipliedAlpha:Et}=P,vt={};if(vt.unpackSkipPixels=(C==null?void 0:C[0])||0,vt.unpackSkipRows=(C==null?void 0:C[1])||0,vt.unpackFlipY=W||!1,vt.unpackPremulAlpha=Et||!1,ht(e,vt),e instanceof WebGL2RenderingContext)if(l==="TEXTURE_2D"||l==="TEXTURE_CUBE_MAP"){const Ut=l==="TEXTURE_CUBE_MAP"?nt(T):l;_&&b?e.texSubImage2D(e[Ut],S,E,R,_,b,e[d],e[h],A):e.texSubImage2D(e[Ut],S,E,R,e[d],e[h],A)}else l==="TEXTURE_3D"||l==="TEXTURE_2D_ARRAY"?e.texSubImage3D(e[l],S,E,R,U,_,b,T,e[d],e[h],A):console.error(`未处理 WebGL1 中 ${l} 纹理类型的图片资源上传！`);else if(l==="TEXTURE_2D"||l==="TEXTURE_CUBE_MAP"){const Ut=l==="TEXTURE_CUBE_MAP"?nt(T):l;e.texSubImage2D(e[Ut],S,E,R,e[d],e[h],A)}else console.error(`WebGL1 中 不支持 ${l} 纹理类型！`);return}const j=f,{data:q,dataLayout:D,dataImageOrigin:M}=j,N=(D==null?void 0:D.offset)||0,$={};if($.unpackSkipPixels=(M==null?void 0:M[0])||0,$.unpackSkipRows=(M==null?void 0:M[1])||0,$.unpackSkipImages=(M==null?void 0:M[2])||0,$.unpackRowLength=D==null?void 0:D.width,$.unpackImageHeight=D==null?void 0:D.height,ht(e,$),e instanceof WebGL2RenderingContext)if(l==="TEXTURE_2D"||l==="TEXTURE_CUBE_MAP"){const A=l==="TEXTURE_CUBE_MAP"?nt(T):l;e.texSubImage2D(e[A],S,E,R,_,b,e[d],e[h],q,N)}else l==="TEXTURE_3D"||l==="TEXTURE_2D_ARRAY"?e.texSubImage3D(e[l],S,E,R,U,_,b,T,e[d],e[h],q,N):console.error(`未处理 WebGL1 中 ${l} 纹理类型的像素资源上传。`);else if(l==="TEXTURE_2D"||l==="TEXTURE_CUBE_MAP"){const A=l==="TEXTURE_CUBE_MAP"?nt(T):l;e.texSubImage2D(e[A],S,E,R,_,b,e[d],e[h],q),console.assert(!N,"WebGL1 不支持 IGLTextureDataSource.dataLayout.offset ！")}else console.error(`WebGL1 中 不支持 ${l} 纹理类型！`)})};i();const o=t.descriptor;et.watchs(o,["generateMipmap"],i),et.watch(t,"writeTextures",i);const a=(c,u)=>{c&&u&&c[0]===u[0]&&c[1]===u[1]&&(c[2]||1)===(u[2]||1)||n.destroy()};return et.watch(o,"size",a),n.destroy=()=>{e.deleteTexture(n),e._textures.delete(t),et.unwatchs(o,["generateMipmap"],i),et.unwatch(t,"sources",r),et.unwatch(t,"writeTextures",i),et.unwatch(o,"size",a),delete n.destroy},n}function Es(e,t){const n=e._textures.get(t);n&&n.destroy()}function ht(e,t){const{packAlignment:n,unpackAlignment:s,unpackFlipY:r,unpackPremulAlpha:i,unpackColorSpaceConversion:o,packRowLength:a,packSkipPixels:c,packSkipRows:u,unpackRowLength:l,unpackImageHeight:d,unpackSkipPixels:h,unpackSkipRows:f,unpackSkipImages:S}={...Ts,...t};e.pixelStorei(e.PACK_ALIGNMENT,n),e.pixelStorei(e.UNPACK_ALIGNMENT,s),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,r),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e[o]),e instanceof WebGL2RenderingContext&&(e.pixelStorei(e.PACK_ROW_LENGTH,a),e.pixelStorei(e.PACK_SKIP_PIXELS,c),e.pixelStorei(e.PACK_SKIP_ROWS,u),e.pixelStorei(e.UNPACK_ROW_LENGTH,l),e.pixelStorei(e.UNPACK_IMAGE_HEIGHT,d),e.pixelStorei(e.UNPACK_SKIP_PIXELS,h),e.pixelStorei(e.UNPACK_SKIP_ROWS,f),e.pixelStorei(e.UNPACK_SKIP_IMAGES,S))}function nt(e){const t=vs[e];return console.assert(!!t,"CubeMap的depthOrArrayLayers值应在[0-5]之间！"),t}const vs=["TEXTURE_CUBE_MAP_POSITIVE_X","TEXTURE_CUBE_MAP_NEGATIVE_X","TEXTURE_CUBE_MAP_POSITIVE_Y","TEXTURE_CUBE_MAP_NEGATIVE_Y","TEXTURE_CUBE_MAP_POSITIVE_Z","TEXTURE_CUBE_MAP_NEGATIVE_Z"];function Yt(e,t){var n,s,r,i,o;const a=((s=(n=t==null?void 0:t.colorAttachments)==null?void 0:n[0])==null?void 0:s.view)||((r=t==null?void 0:t.depthStencilAttachment)==null?void 0:r.view);if(!a||"texture"in a&&"context"in a.texture)return null;let c=e._framebuffers.get(t);if(c)return c;const u=t.sampleCount;c=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,c),e._framebuffers.set(t,c);const l=[];(i=t.colorAttachments)==null||i.forEach((h,f)=>{const S=h.view,m=e[`COLOR_ATTACHMENT${f}`];if(l.push(m),"texture"in S){const L=S.texture,_=S.baseMipLevel||0,b=S.baseArrayLayer||0;if("context"in L){l.pop();return}const T=he(e,L),E=Pt(L.descriptor.dimension);E==="TEXTURE_2D"?e.framebufferTexture2D(e.FRAMEBUFFER,m,e[E],T,_):E==="TEXTURE_2D_ARRAY"?e instanceof WebGL2RenderingContext&&e.framebufferTextureLayer(e.DRAW_FRAMEBUFFER,m,T,_,b):console.error(`未处理 ${E} 的颜色附件纹理设置！`)}else{const L=_s(e,S,u);e.framebufferRenderbuffer(e.FRAMEBUFFER,m,e.RENDERBUFFER,L)}}),e instanceof WebGL2RenderingContext?e.drawBuffers(l):console.error("WebGL1 不支持 drawBuffers 。");const d=t.depthStencilAttachment;if(d){if(d.view){const h=d.view,f=h.texture,S=h.baseMipLevel||0,m=h.baseArrayLayer||0;if(!("context"in f)){const L=he(e,f),_=Pt(f.descriptor.dimension);_==="TEXTURE_2D"?e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e[_],L,S):_==="TEXTURE_2D_ARRAY"?e instanceof WebGL2RenderingContext&&e.framebufferTextureLayer(e.DRAW_FRAMEBUFFER,e.DEPTH_ATTACHMENT,L,S,m):console.error(`未处理 ${_} 的深度模板附件纹理设置！`)}}else if(c){const h=(o=t.colorAttachments)==null?void 0:o[0];let f=e.drawingBufferWidth,S=e.drawingBufferHeight;if(h!=null&&h.view){const _=h.view;if("texture"in _){const b=_.texture;"descriptor"in b&&(f=b.descriptor.size[0],S=b.descriptor.size[1])}}const m=e.createRenderbuffer();e.bindRenderbuffer(e.RENDERBUFFER,m),e instanceof WebGL2RenderingContext?(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH24_STENCIL8,f,S),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,m)):(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,f,S),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,m));const L=e;L._framebufferDepthRenderbuffers||(L._framebufferDepthRenderbuffers=new Map),L._framebufferDepthRenderbuffers.set(c,m)}}return c}function Ht(e,t,n=!0){if(n&&(t!=null&&t[mt])){As(e,t[mt]);return}const s=e._framebuffers.get(t);e._framebuffers.delete(t);const r=e;if(r._framebufferDepthRenderbuffers&&s){const i=r._framebufferDepthRenderbuffers.get(s);i&&(e.deleteRenderbuffer(i),r._framebufferDepthRenderbuffers.delete(s))}e.deleteFramebuffer(s)}function As(e,t){Ht(e,t.blitFramebuffer.read,!1),Ht(e,t.blitFramebuffer.draw,!1),t.renderbuffers.forEach(n=>{sn(e,n)})}function xs(e){const t=Ws[e];return console.assert(!!t),t}function $s(e){return Cs[e]!==void 0}const ws={FLOAT:5126,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT:5124,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676},rn={SAMPLER_2D:35678,SAMPLER_CUBE:35680},Rs={UNSIGNED_INT:5125,UNSIGNED_INT_VEC2:36294,UNSIGNED_INT_VEC3:36295,UNSIGNED_INT_VEC4:36296,FLOAT_MAT2x3:35685,FLOAT_MAT2x4:35686,FLOAT_MAT3x2:35687,FLOAT_MAT3x4:35688,FLOAT_MAT4x2:35689,FLOAT_MAT4x3:35690},on={SAMPLER_3D:35679,SAMPLER_2D_SHADOW:35682,SAMPLER_2D_ARRAY:36289,SAMPLER_2D_ARRAY_SHADOW:36292,SAMPLER_CUBE_SHADOW:36293,INT_SAMPLER_2D:36298,INT_SAMPLER_3D:36299,INT_SAMPLER_CUBE:36300,INT_SAMPLER_2D_ARRAY:36303,UNSIGNED_INT_SAMPLER_2D:36306,UNSIGNED_INT_SAMPLER_3D:36307,UNSIGNED_INT_SAMPLER_CUBE:36308,UNSIGNED_INT_SAMPLER_2D_ARRAY:36311},Ie={...ws,...rn,...Rs,...on},Cs={...rn,...on},Ws=Object.keys(Ie).reduce((e,t)=>(e[Ie[t]]=t,e),{});function Jt(e,t){const n=an(t);let s=e._programs[n];if(s)return s;const r=t.vertex.glsl||t.vertex.code;let i;const o=t.fragment;o&&(i=o.glsl||o.code),i=i||`#version 300 es
        precision highp float;
        precision highp int;

        void main()
        {
        }
    `;const a=t.transformFeedbackVaryings;return s=Is(e,r,i,a),e._programs[n]=s,s}function Fs(e,t){const n=an(t),s=e._programs[n];s&&(delete e._programs[n],e.deleteProgram(s))}function an(e){const t=e.vertex.glsl||e.vertex.code;let n;const s=e.fragment;s&&(n=s.glsl||s.code);const r=e.transformFeedbackVaryings;return`---vertexShader---
${t}
---fragment---
${n}
---feedback---${r==null?void 0:r.varyings.toString()} ${r==null?void 0:r.bufferMode}`}function Is(e,t,n,s){const r=Pe(e,"VERTEX_SHADER",t),i=Pe(e,"FRAGMENT_SHADER",n),o=Ps(e,r,i,s),a=e.getProgramParameter(o,e.ACTIVE_ATTRIBUTES),c=[];for(let h=0;h<a;h++){const f=e.getActiveAttrib(o,h),{name:S,size:m,type:L}=f,_=e.getAttribLocation(o,S),b=Us(L);c.push({name:S,size:m,type:b,location:_})}const u=e.getProgramParameter(o,e.ACTIVE_UNIFORMS),l=[];let d=0;for(let h=0;h<u;h++){const f=e.getActiveUniform(o,h),{name:S,size:m,type:L}=f,_=xs(L),b=$s(_),T=/(\w+)/g,E=[S];if(m>1){console.assert(S.substring(S.length-3)==="[0]");const U=S.substring(0,S.length-3);for(let P=1;P<m;P++)E[P]=`${U}[${P}]`}const R=[];for(let U=0;U<E.length;U++){const P=E[U];let j=T.exec(P);const q=[];for(;j;)q.push(j[1]),j=T.exec(P);const D=e.getUniformLocation(o,P);b?(R.push({location:D,paths:q,textureID:d}),d++):R.push({location:D,paths:q,textureID:-1})}l[h]={name:S,type:_,isTexture:b,items:R}}if(e instanceof WebGL2RenderingContext){const h=e.getProgramParameter(o,e.ACTIVE_UNIFORM_BLOCKS),f=new Array(h).fill(0).map((S,m)=>{e.uniformBlockBinding(o,m,m);const L=e.getActiveUniformBlockParameter(o,m,e.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES),_=[];for(let E=0;E<L.length;E++){const R=l[L[E]];R.inBlock=!0,_.push(R)}const T={name:e.getActiveUniformBlockName(o,m),index:m,dataSize:e.getActiveUniformBlockParameter(o,m,e.UNIFORM_BLOCK_DATA_SIZE),uniforms:_,bufferBindingInfo:void 0};return T.bufferBindingInfo=Ns(T),T});o.uniformBlocks=f}return o.vertex=t,o.fragment=n,o.attributes=c,o.uniforms=l,o}function Pe(e,t,n){let s=e._shaders[n];if(s)return s;if(s=e.createShader(e[t]),e._shaders[n]=s,e.shaderSource(s,n),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS)){const i=e.getShaderInfoLog(s);throw e.deleteShader(s),`Failed to compile shader: ${i}`}return s}function Ps(e,t,n,s){const r=e.createProgram();if(e.attachShader(r,t),e.attachShader(r,n),s&&(e instanceof WebGL2RenderingContext?e.transformFeedbackVaryings(r,s.varyings,e[s.bufferMode]):console.error("WebGL1 不支持 transformFeedbackVaryings 功能！")),e.linkProgram(r),!e.getProgramParameter(r,e.LINK_STATUS)){const o=e.getProgramInfoLog(r);throw e.deleteProgram(r),e.deleteShader(n),e.deleteShader(t),`Failed to link program: ${o}`}return r}function Ns(e){const t=e.dataSize;let n=0,s;const r=[];return e.uniforms.forEach(o=>{const a=o.type,c=Os[a];console.assert(!!c,`没有找到 ${a} 统一缓冲类型对应的对齐与尺寸。`);const u=o.name.substring(0,o.name.lastIndexOf("."));s!==u&&(n=ie(16,n),s=u),o.items.forEach(l=>{n=ie(c.align,n);const d=n,h=c.size;n+=c.size;const f=c.clsType,S=l.paths.slice(1);r.push({paths:S,offset:d,size:h,Cls:f})})}),n=ie(16,n),console.assert(t===n,`uniformBlock映射尺寸出现错误( ${t}  ${n} )！`),{size:e.dataSize,items:r}}function ie(e,t){return Math.ceil(t/e)*e}const Os={FLOAT:{align:4,size:4,clsType:Float32Array},FLOAT_VEC2:{align:8,size:8,clsType:Float32Array},FLOAT_VEC3:{align:16,size:12,clsType:Float32Array},FLOAT_VEC4:{align:16,size:16,clsType:Float32Array},INT:{align:4,size:4,clsType:Int32Array},INT_VEC2:{align:8,size:8,clsType:Int32Array},INT_VEC3:{align:16,size:12,clsType:Int32Array},INT_VEC4:{align:16,size:16,clsType:Int32Array},BOOL:{align:4,size:4,clsType:Int32Array},BOOL_VEC2:{align:8,size:8,clsType:Int32Array},BOOL_VEC3:{align:16,size:12,clsType:Int32Array},BOOL_VEC4:{align:16,size:16,clsType:Int32Array},FLOAT_MAT2:{align:8,size:16,clsType:Float32Array},FLOAT_MAT3:{align:16,size:48,clsType:Float32Array},FLOAT_MAT4:{align:16,size:64,clsType:Float32Array},UNSIGNED_INT:{align:4,size:4,clsType:Uint32Array},UNSIGNED_INT_VEC2:{align:8,size:8,clsType:Uint32Array},UNSIGNED_INT_VEC3:{align:16,size:12,clsType:Uint32Array},UNSIGNED_INT_VEC4:{align:16,size:16,clsType:Uint32Array},FLOAT_MAT2x3:{align:16,size:32,clsType:Float32Array},FLOAT_MAT2x4:{align:16,size:32,clsType:Float32Array},FLOAT_MAT3x2:{align:8,size:24,clsType:Float32Array},FLOAT_MAT3x4:{align:16,size:48,clsType:Float32Array},FLOAT_MAT4x2:{align:8,size:32,clsType:Float32Array},FLOAT_MAT4x3:{align:16,size:64,clsType:Float32Array}};function Us(e){return Ms[e]}const Ms=Object.freeze({5120:"BYTE",5121:"UNSIGNED_BYTE",5122:"SHORT",5123:"UNSIGNED_SHORT",5124:"INT",5125:"UNSIGNED_INT",5126:"FLOAT",5131:"HALF_FLOAT"});function cn(e){const t=Ne[e];return console.assert(!!t,`接收到错误值，请从 ${Object.keys(Ne).toString()} 中取值！`),t}const Ne={never:"NEVER",less:"LESS",equal:"EQUAL","less-equal":"LEQUAL",greater:"GREATER","not-equal":"NOTEQUAL","greater-equal":"GEQUAL",always:"ALWAYS"};function Bs(e,t){let n=e._samplers.get(t);if(n)return n;if(e instanceof WebGL2RenderingContext){n=e.createSampler(),e._samplers.set(t,n);const s=un(t.minFilter,t.mipmapFilter),r=fn(t.magFilter),i=Ft(t.addressModeU),o=Ft(t.addressModeV),a=Ft(t.addressModeW),c=t.lodMinClamp||0,u=t.lodMaxClamp||16,l=t.compare?"COMPARE_REF_TO_TEXTURE":"NONE",d=cn(t.compare??"less-equal");e.samplerParameteri(n,e.TEXTURE_MIN_FILTER,e[s]),e.samplerParameteri(n,e.TEXTURE_MAG_FILTER,e[r]),e.samplerParameteri(n,e.TEXTURE_WRAP_S,e[i]),e.samplerParameteri(n,e.TEXTURE_WRAP_T,e[o]),e.samplerParameteri(n,e.TEXTURE_WRAP_R,e[a]),e.samplerParameterf(n,e.TEXTURE_MIN_LOD,c),e.samplerParameterf(n,e.TEXTURE_MAX_LOD,u),e.samplerParameteri(n,e.TEXTURE_COMPARE_MODE,e[l]),e.samplerParameteri(n,e.TEXTURE_COMPARE_FUNC,e[d])}return n}function Ds(e,t){if(e instanceof WebGL2RenderingContext){const n=e._samplers.get(t);e._samplers.delete(t),e.deleteSampler(n)}}function Ft(e="repeat"){const t=Oe[e];return console.assert(!!t,`接收到错误值，请从 ${Object.keys(Oe).toString()} 中取值！`),t}const Oe={"clamp-to-edge":"CLAMP_TO_EDGE",repeat:"REPEAT","mirror-repeat":"MIRRORED_REPEAT"};function un(e="nearest",t){let n;return e==="linear"?t==="linear"?n="LINEAR_MIPMAP_LINEAR":t==="nearest"?n="LINEAR_MIPMAP_NEAREST":n="LINEAR":t==="linear"?n="NEAREST_MIPMAP_LINEAR":t==="nearest"?n="NEAREST_MIPMAP_NEAREST":n="NEAREST",n}function fn(e="nearest"){const t=Ue[e];return console.assert(!!t,`接收到错误值，请从 ${Object.keys(Ue).toString()} 中取值！`),t}const Ue={nearest:"NEAREST",linear:"LINEAR"};function zs(e,t){let n=e._transforms.get(t);return n||(e instanceof WebGL2RenderingContext&&(n=e.createTransformFeedback(),e._transforms.set(t,n),e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,n),t.bindBuffers.forEach(s=>{const{index:r,data:i}=s,o=st.getBuffer(i.buffer),a=gt(e,o,"TRANSFORM_FEEDBACK_BUFFER","STREAM_COPY");e.bindBufferBase(e.TRANSFORM_FEEDBACK_BUFFER,r,a)}),e.bindBuffer(e.ARRAY_BUFFER,null)),n)}function Vs(e,t){const n=e._transforms.get(t);n&&(e._transforms.delete(t),e instanceof WebGL2RenderingContext&&e.deleteTransformFeedback(n))}const Me="_GL_Submit_Times";function ks(e,t){if(!t||!(e instanceof WebGL2RenderingContext))return Dt;let n=t._GLRenderOcclusionQuery;if(n)return n;const s=t.filter(o=>o.__type__==="OcclusionQuery");if(s.length===0)return t._GLRenderOcclusionQuery=Dt,Dt;const r=()=>{s.forEach((o,a)=>{o._step=Xs(e,o)})},i=o=>{const a=s.map(c=>c._step.resolve());Promise.all(a).then(c=>{var u;(u=o.onOcclusionQuery)==null||u.call(o,s,c)})};return t._GLRenderOcclusionQuery=n={init:r,resolve:i},n}const Dt={init:()=>{},resolve:()=>{}};function Xs(e,t){const n={};let s;return{begin:()=>{s=e.createQuery(),e.beginQuery(e.ANY_SAMPLES_PASSED,s)},end:()=>{e.endQuery(e.ANY_SAMPLES_PASSED)},resolve:async()=>{if(n.result!==void 0)return n.result;if(e instanceof WebGL2RenderingContext)return await new Promise((c,u)=>{(function l(){if(!e.getQueryParameter(s,e.QUERY_RESULT_AVAILABLE)){requestAnimationFrame(l);return}const d=n.result=e.getQueryParameter(s,e.QUERY_RESULT);t.onQuery(d),c(d),e.deleteQuery(s)})()})}}}function ln(e){let t=Ys[e];return console.assert(!!t,`WebGL 不支持参数 IPrimitiveTopology ${e} !`),t=t||e,t}const Ys={"point-list":"POINTS","line-list":"LINES","line-strip":"LINE_STRIP","triangle-list":"TRIANGLES","triangle-strip":"TRIANGLE_STRIP",LINE_LOOP:"LINE_LOOP",TRIANGLE_FAN:"TRIANGLE_FAN"};function Hs(e,t,n,s){const r=n.BYTES_PER_ELEMENT===2?e.UNSIGNED_SHORT:e.UNSIGNED_INT,i=s.indexCount,o=s.firstIndex||0,a=s.instanceCount||1,c=o*n.BYTES_PER_ELEMENT+n.byteOffset;a>1?e instanceof WebGL2RenderingContext?e.drawElementsInstanced(e[t],i,r,c,a):e.getExtension("ANGLE_instanced_arrays").drawElementsInstancedANGLE(e[t],i,r,c,a):e.drawElements(e[t],i,r,c)}function dn(e,t,n){const s=n.vertexCount,r=n.firstVertex||0,i=n.instanceCount||1;i>1?e instanceof WebGL2RenderingContext?e.drawArraysInstanced(e[t],r,s,i):e.getExtension("ANGLE_instanced_arrays").drawArraysInstancedANGLE(e[t],r,s,i):e.drawArrays(e[t],r,s)}const Be=Object.freeze({FRONT_AND_BACK:"FRONT_AND_BACK",none:"BACK",front:"FRONT",back:"BACK"}),De=Object.freeze({ccw:"CCW",cw:"CW"});function Ks(e,t){const n=(t==null?void 0:t.cullFace)||"none",s=(t==null?void 0:t.frontFace)||"ccw";if(n!=="none"){const r=Be[n];console.assert(!!r,`接收到错误值，请从 ${Object.keys(Be).toString()} 中取值！`);const i=De[s];console.assert(!!i,`接收到错误 IFrontFace 值，请从 ${Object.keys(De).toString()} 中取值！`),e.enable(e.CULL_FACE),e.cullFace(e[r]),e.frontFace(e[i])}else e.disable(e.CULL_FACE)}function Qs(e,t,n=!0){if(!n){e.disable(e.DEPTH_TEST);return}if(t&&(t.depthWriteEnabled||t.depthCompare!=="always")){const s=cn(t.depthCompare??"less"),r=t.depthWriteEnabled??!0;if(e.enable(e.DEPTH_TEST),e.depthFunc(e[s]),e.depthMask(r),t.depthBias||t.depthBiasSlopeScale){const i=t.depthBiasSlopeScale??0,o=t.depthBias??0;e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(i,o)}else e.disable(e.POLYGON_OFFSET_FILL)}else e.disable(e.DEPTH_TEST)}function js(e,t){var n,s;const r=((n=t==null?void 0:t[0])==null?void 0:n.writeMask)||[!0,!0,!0,!0];e.colorMask(r[0],r[1],r[2],r[3]);const i=(s=t==null?void 0:t[0])==null?void 0:s.blend;if(i){const o=i.color,a=i.alpha,c=ze((o==null?void 0:o.operation)??ee.operation),u=zt((o==null?void 0:o.srcFactor)??ee.srcFactor,o==null?void 0:o.operation),l=zt((o==null?void 0:o.dstFactor)??ee.dstFactor,o==null?void 0:o.operation),d=ze(a==null?void 0:a.operation)||c,h=zt(a==null?void 0:a.srcFactor,o==null?void 0:o.operation)||u,f=zt(a==null?void 0:a.dstFactor,o==null?void 0:o.operation)||l;if(Rn.getBlendConstantColor(i)){const m=i.constantColor??[0,0,0,0];e.blendColor(m[0],m[1],m[2],m[3])}e.enable(e.BLEND),e.blendEquationSeparate(e[c],e[d]),e.blendFuncSeparate(e[u],e[l],e[h],e[f])}else e.disable(e.BLEND)}function ze(e){if(!e)return;const t=Ve[e];return console.assert(!!t,`接收到错误值，请从 ${Object.keys(Ve).toString()} 中取值！`),t}const Ve={add:"FUNC_ADD",subtract:"FUNC_SUBTRACT","reverse-subtract":"FUNC_REVERSE_SUBTRACT",min:"MIN",max:"MAX"};function zt(e,t){if(!e)return;(t==="max"||t==="min")&&(e="one");const n=ke[e];return console.assert(!!n,`接收到错误值，请从 ${Object.keys(ke).toString()} 中取值！`),n}const ke={zero:"ZERO",one:"ONE",src:"SRC_COLOR","one-minus-src":"ONE_MINUS_SRC_COLOR","src-alpha":"SRC_ALPHA","one-minus-src-alpha":"ONE_MINUS_SRC_ALPHA",dst:"DST_COLOR","one-minus-dst":"ONE_MINUS_DST_COLOR","dst-alpha":"DST_ALPHA","one-minus-dst-alpha":"ONE_MINUS_DST_ALPHA","src-alpha-saturated":"SRC_ALPHA_SATURATE",constant:"CONSTANT_COLOR","one-minus-constant":"ONE_MINUS_CONSTANT_COLOR"};function qs(e,t){const n=Jt(e,t);e.useProgram(n),js(e,t.fragment.targets)}function Zs(e,t){const{stencilFront:n,stencilBack:s}={...t};if(n||s){const r=t.stencilReference??0,i=t.stencilReadMask??4294967295,o=t.stencilWriteMask??4294967295;if(e.enable(e.STENCIL_TEST),n){const a=Xe(n.compare??"always"),c=pt(n.failOp),u=pt(n.depthFailOp),l=pt(n.passOp);e.stencilFuncSeparate(e.FRONT,e[a],r,i),e.stencilOpSeparate(e.FRONT,e[c],e[u],e[l]),e.stencilMaskSeparate(e.FRONT,o)}if(s){const a=Xe(s.compare??"always"),c=pt(s.failOp),u=pt(s.depthFailOp),l=pt(s.passOp);e.stencilFuncSeparate(e.BACK,e[a],r,i),e.stencilOpSeparate(e.BACK,e[c],e[u],e[l]),e.stencilMaskSeparate(e.BACK,o)}}else e.disable(e.STENCIL_TEST)}function Xe(e){return Js[e]}const Js={never:"NEVER",less:"LESS",equal:"EQUAL","less-equal":"LEQUAL",greater:"GREATER","not-equal":"NOTEQUAL","greater-equal":"GEQUAL",always:"ALWAYS"};function pt(e){return tr[e]}const tr={keep:"KEEP",zero:"ZERO",replace:"REPLACE",invert:"INVERT","increment-clamp":"INCR","decrement-clamp":"DECR","increment-wrap":"INCR_WRAP","decrement-wrap":"DECR_WRAP"};function er(e,t,n=!0){qs(e,t),Qs(e,t.depthStencil,n),Zs(e,t.depthStencil)}function nr(e,t,n){if(n){const s=n.isYup??!0,r=n.x??0;let i=n.y??0;const o=n.width??t.width,a=n.height??t.height;s||(i=t.height-i-a),e.enable(e.SCISSOR_TEST),e.scissor(r,i,o,a)}else e.disable(e.SCISSOR_TEST)}const oe=new WeakMap;function sr(e,t){if(oe.has(t)){const a=oe.get(t);a.size!==e.size&&console.warn("updateBufferBinding 出现一份数据对应多个 variableInfo",{uniformData:t,bufferBindingInfo:e,preVariableInfo:a});return}oe.set(t,e);const n=e.size,s=!!t.bufferView;s?console.assert(t.bufferView.byteLength>=n,"uniformData.bufferView 统一块数据提供数据尺寸不能小于实际尺寸！"):t.bufferView=new Uint8Array(n);const r=st.getBuffer(t.bufferView.buffer),i=t.bufferView.byteOffset,o=tt(t);e.items.forEach(a=>{const{paths:c,offset:u,size:l,Cls:d}=a;le(()=>{let h=t.value,f=o.value;if(h===void 0)return;for(let L=0;L<c.length;L++)if(h=h[c[L]],f=f[c[L]],h===void 0){s||console.warn(`没有找到 统一块变量属性 ${c.join(".")} 的值！`);return}let S;typeof h=="number"?S=new d([h]):h.constructor.name!==d.name?S=new d(h):S=h;const m=r.writeBuffers??[];m.push({data:S,bufferOffset:i+u,size:Math.min(l,S.byteLength)/S.BYTES_PER_ELEMENT}),tt(r).writeBuffers=m})})}function rr(e,t,n,s,r){if(e instanceof WebGL2RenderingContext){const o=Bs(e,s);e.bindSampler(r,o)}else{const o=un(s.minFilter,s.mipmapFilter),a=fn(s.magFilter),c=Ft(s.addressModeU),u=Ft(s.addressModeV);n.minFilter!==o&&(e.texParameteri(e[t],e.TEXTURE_MIN_FILTER,e[o]),n.minFilter=o),n.magFilter!==a&&(e.texParameteri(e[t],e.TEXTURE_MAG_FILTER,e[a]),n.magFilter=a),n.wrapS!==c&&(e.texParameteri(e[t],e.TEXTURE_WRAP_S,e[c]),n.wrapS=c),n.wrapT!==u&&(e.texParameteri(e[t],e.TEXTURE_WRAP_T,e[u]),n.wrapT=u)}const i=(s==null?void 0:s.maxAnisotropy)||1;if(n.maxAnisotropy!==i){const o=e.getExtension("EXT_texture_filter_anisotropic");o&&e.texParameterf(e[t],o.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i,e._capabilities.maxAnisotropy)),n.maxAnisotropy=i}}function ir(e,t,n){const{texture:s,sampler:r}=n,{location:i,textureID:o}=t,a=Pt(s.descriptor.dimension);e.uniform1i(i,o);const c=he(e,s);e.activeTexture(e[`TEXTURE${o}`]),e.bindTexture(e[a],c);const u=or(s,r);return rr(e,a,c,u,o),c}const Ye=new WeakSet;function or(e,t){const n=e.descriptor;return!(n.generateMipmap||n.mipLevelCount&&n.mipLevelCount>1)&&t.mipmapFilter?(Ye.has(e)||(Ye.add(e),console.warn(`[WebGL] 纹理没有 mipmap（generateMipmap: false），但采样器设置了 mipmapFilter: '${t.mipmapFilter}'。 已自动忽略 mipmapFilter 并将 lodMaxClamp 设为 0，以避免黑屏。 建议：设置 generateMipmap: true 或移除 mipmapFilter 配置。`)),{...t,mipmapFilter:void 0,lodMaxClamp:0}):t}function ar(e,t,n,s){let r=s.value;typeof r=="number"?r=[r]:r.toArray&&(r=r.toArray());const i=n.location;switch(t){case"BOOL":case"INT":e.uniform1iv(i,r);break;case"BOOL_VEC2":case"INT_VEC2":e.uniform2iv(i,r);break;case"BOOL_VEC3":case"INT_VEC3":e.uniform3iv(i,r);break;case"BOOL_VEC4":case"INT_VEC4":e.uniform4iv(i,r);break;case"FLOAT":e.uniform1fv(i,[r]);break;case"FLOAT_VEC2":e.uniform2fv(i,r);break;case"FLOAT_VEC3":e.uniform3fv(i,r);break;case"FLOAT_VEC4":e.uniform4fv(i,r);break;case"FLOAT_MAT2":e.uniformMatrix2fv(i,!1,r);break;case"FLOAT_MAT3":e.uniformMatrix3fv(i,!1,r);break;case"FLOAT_MAT4":e.uniformMatrix4fv(i,!1,r);break;case"UNSIGNED_INT":e.uniform1uiv(i,r);break;case"UNSIGNED_INT_VEC2":e.uniform2uiv(i,r);break;case"UNSIGNED_INT_VEC3":e.uniform3uiv(i,r);break;case"UNSIGNED_INT_VEC4":e.uniform4uiv(i,r);break;case"FLOAT_MAT2x3":e.uniformMatrix2x3fv(i,!1,r);break;case"FLOAT_MAT2x4":e.uniformMatrix2x4fv(i,!1,r);break;case"FLOAT_MAT3x2":e.uniformMatrix3x2fv(i,!1,r);break;case"FLOAT_MAT3x4":e.uniformMatrix3x4fv(i,!1,r);break;case"FLOAT_MAT4x2":e.uniformMatrix4x2fv(i,!1,r);break;case"FLOAT_MAT4x3":e.uniformMatrix4x3fv(i,!1,r);break;default:console.error(`无法识别的uniform类型 ${n.paths} ${t}`)}}function cr(e){return e&&typeof e=="object"&&"texture"in e}function ur(e){return e&&typeof e=="object"&&!("texture"in e)&&!("value"in e)&&!("buffer"in e)}function fr(e){return e&&typeof e=="object"&&"descriptor"in e}function lr(e,t){const n=`${t}_texture`,s=t,r=e[n],i=e[s];if(r&&i&&cr(r)&&ur(i)&&fr(r.texture))return{texture:r.texture,sampler:i}}function hn(e,t,n){const s=Jt(e,t);s.uniforms.forEach(r=>{const{name:i,type:o,items:a,isTexture:c,inBlock:u}=r;u||a.forEach(l=>{const{paths:d}=l;let h=n[d[0]];for(let f=1;f<d.length;f++)h=h[d[f]];if(c&&!(h&&typeof h=="object"&&"texture"in h)){const S=lr(n,d[0]);S&&(h=S)}h===void 0&&console.error(`沒有找到Uniform ${i} 數據！`),c?ir(e,l,h):ar(e,o,l,h)})}),e instanceof WebGL2RenderingContext&&s.uniformBlocks.forEach(r=>{const{name:i,index:o}=r;let a=n[i];if(a===void 0){const f=i.charAt(0).toLowerCase()+i.slice(1);a=n[f]}if(a===void 0)throw new Error(`没有找到 UniformBlock "${i}" 的数据，请检查 bindingResources 中是否包含 "${i}" 或 "${i.charAt(0).toLowerCase()+i.slice(1)}" 键。`);let c=a;if(!(c.buffer&&c.BYTES_PER_ELEMENT)){const f=a;sr(r.bufferBindingInfo,f),c=f.bufferView}const u=st.getBuffer(c.buffer);u.label=u.label||`UniformBuffer ${i}`;const l=c.byteOffset,d=r.bufferBindingInfo.size,h=gt(e,u,"UNIFORM_BUFFER","DYNAMIC_DRAW");e.bindBufferRange(e.UNIFORM_BUFFER,o,h,l,d)})}function dr(e,t){if(!t)return;const n=st.getBuffer(t.buffer);n.label||(tt(n).label=`顶点索引 ${hr++}`);const s=gt(e,n,"ELEMENT_ARRAY_BUFFER","STATIC_DRAW");e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s)}let hr=0;function pr(e,t,n){const{stepMode:s,format:r,data:i}=n;let{arrayStride:o,offset:a}=n;const c=wn[r],{numComponents:u,normalized:l,type:d}=c;e.enableVertexAttribArray(t),s==="instance"&&(e instanceof WebGL2RenderingContext?e.vertexAttribDivisor(t,1):e.getExtension("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(t,1)),o=o||c.byteSize,a=i.byteOffset+(a||0);const h=st.getBuffer(i.buffer);h.label||(tt(h).label=`顶点数据 ${Lr++}`);const f=gt(e,h,"ARRAY_BUFFER","STATIC_DRAW");e.bindBuffer(e.ARRAY_BUFFER,f),e instanceof WebGL2RenderingContext&&(d==="INT"||d==="UNSIGNED_INT")?e.vertexAttribIPointer(t,u,e[d],o,a):e.vertexAttribPointer(t,u,e[d],l,o,a)}let Lr=0;function pn(e,t,n,s){if(!n&&!s)return;let r;if(e instanceof WebGL2RenderingContext){if(r=e._vertexArrays.get([t,n,s]),r){e.bindVertexArray(r);return}r=e.createVertexArray(),e.bindVertexArray(r),e._vertexArrays.set([t,n,s],r)}Jt(e,t).attributes.forEach(o=>{const{name:a,location:c}=o;if(c<0)return;const u=n[a];u||console.error(`缺少顶点 ${a} 数据！`),pr(e,c,u)}),dr(e,s)}function mr(e,t,n){if(n){const s=n.isYup??!0,r=n.x??0;let i=n.y??0;const o=n.width??t.width,a=n.height??t.height;s||(i=t.height-i-a),e.viewport(r,i,o,a)}else e.viewport(0,0,t.width,t.height)}function pe(e,t,n,s=!0){const{viewport:r,scissorRect:i,pipeline:o,vertices:a,indices:c,draw:u,bindingResources:l}=n,d=o==null?void 0:o.primitive;mr(e,t,r),nr(e,t,i),er(e,o,s),hn(e,o,l),pn(e,o,a,c),Ks(e,d);const h=(d==null?void 0:d.topology)||"triangle-list",f=ln(h);u.__type__==="DrawVertex"?dn(e,f,u):Hs(e,f,c,u)}function be(e,t){const{read:n,draw:s,blitFramebuffers:r}=t,i=Yt(e,n),o=Yt(e,s);e instanceof WebGL2RenderingContext&&(e.bindFramebuffer(e.READ_FRAMEBUFFER,i),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,o),s.colorAttachments.forEach((a,c)=>{var u;const l=(u=s.colorAttachments[c])==null?void 0:u.clearValue;l&&e.clearBufferfv(e.COLOR,c,l)}),r.forEach(a=>{const[c,u,l,d,h,f,S,m,L,_]=a;e.blitFramebuffer(c,u,l,d,h,f,S,m,e[L],e[_])}))}function He(e,t,n,s=!0){n._step.begin(),n.renderObjects.forEach(r=>{pe(e,t,r,s)}),n._step.end()}function Ke(e,t){var n;t=t||{};const s=Yt(e,t);e.bindFramebuffer(e.FRAMEBUFFER,s);const r=(n=t.colorAttachments)==null?void 0:n[0],i=(r==null?void 0:r.clearValue)??[0,0,0,0],o=(r==null?void 0:r.loadOp)??"clear";e.clearColor(i[0],i[1],i[2],i[3]);const a=t.depthStencilAttachment;if(a){const c=a.depthClearValue??1,u=a.depthLoadOp??"clear",l=a.stencilClearValue??0,d=a.stencilLoadOp??"load";e.clearDepth(c),e.clearStencil(l),e.clear((o==="clear"?e.COLOR_BUFFER_BIT:0)|(u==="clear"?e.DEPTH_BUFFER_BIT:0)|(d==="clear"?e.STENCIL_BUFFER_BIT:0))}else e.clear(o==="clear"?e.COLOR_BUFFER_BIT:0)}function Sr(e,t,n){var s,r;const i=t.descriptor||n,o=_r(e,i),a=!!(i!=null&&i.depthStencilAttachment),c=ks(e,t.renderPassObjects);if(c.init(),i!=null&&i.sampleCount&&i.colorAttachments[0].view.texture){const{passDescriptor:u,blitFramebuffer:l}=bs(i);Ke(e,u),(s=t.renderPassObjects)==null||s.forEach(d=>{d.__type__==="OcclusionQuery"?He(e,o,d,a):pe(e,o,d,a)}),be(e,l)}else Ke(e,i),(r=t.renderPassObjects)==null||r.forEach(u=>{u.__type__==="OcclusionQuery"?He(e,o,u,a):pe(e,o,u,a)});c.resolve(t)}function _r(e,t){var n;if(!t)return{width:e.drawingBufferWidth,height:e.drawingBufferHeight};const s=t.colorAttachments;if(s){const i=(n=s[0])==null?void 0:n.view;if(i){const o=i.texture;if("context"in o){const a=o,c=typeof a.context.canvasId=="string"?document.getElementById(a.context.canvasId):a.context.canvasId;if(c)return{width:c.width,height:c.height}}else if("descriptor"in o){const a=o;return{width:a.descriptor.size[0],height:a.descriptor.size[1]}}}return{width:e.drawingBufferWidth,height:e.drawingBufferHeight}}const r=t.depthStencilAttachment;if(r){const i=r.view;if(i){const o=i.texture;if("context"in o){const a=o,c=typeof a.context.canvasId=="string"?document.getElementById(a.context.canvasId):a.context.canvasId;if(c)return{width:c.width,height:c.height}}else if("descriptor"in o){const a=o;return{width:a.descriptor.size[0],height:a.descriptor.size[1]}}}return{width:e.drawingBufferWidth,height:e.drawingBufferHeight}}return{width:e.drawingBufferWidth,height:e.drawingBufferHeight}}function Gr(e,t){const n=Jt(e,t);e.useProgram(n)}function br(e,t,n){if(e instanceof WebGL2RenderingContext)if(t){const s=zs(e,t);e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,s),e.beginTransformFeedback(e[n])}else e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null);else t&&console.log("WebGL1 不支持顶点着色器回写数据功能！")}function gr(e,t){t&&e instanceof WebGL2RenderingContext&&(e.endTransformFeedback(),e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.TRANSFORM_FEEDBACK_BUFFER,null))}function yr(e,t){const{pipeline:n,vertices:s,uniforms:r,transformFeedback:i,draw:o}=t,a=ln("point-list");Gr(e,n),pn(e,n,s,void 0),hn(e,n,r),br(e,i,a),dn(e,a,o),gr(e,i)}function Tr(e,t){e instanceof WebGL2RenderingContext&&e.enable(e.RASTERIZER_DISCARD),t.transformFeedbackObjects.forEach(n=>{yr(e,n)}),e instanceof WebGL2RenderingContext&&e.disable(e.RASTERIZER_DISCARD)}function Er(e){const{source:t,destination:n,copySize:s}=e,r=t.aspect||"all",i=n.aspect||"all";console.assert(r===i,"拷贝纹理时两个纹理的 aspect 必须相同！");const o=[];let a;const c=[];let u,l;r==="all"?(l="COLOR_BUFFER_BIT",o.push({view:Lt(t)}),c.push({view:Lt(n)})):r==="depth-only"?(l="DEPTH_BUFFER_BIT",a={view:Lt(t)},u={view:Lt(n)}):r==="stencil-only"&&(l="STENCIL_BUFFER_BIT",a={view:Lt(t)},u={view:Lt(n)});const d=t.origin||[0,0],h=n.origin||[0,0],f=[d[0],d[1],d[0]+s[0],d[1]+s[1],h[0],h[1],h[0]+s[0],h[1]+s[1],l,"NEAREST"];return{__type__:"BlitFramebuffer",read:{colorAttachments:o,depthStencilAttachment:a},draw:{colorAttachments:c,depthStencilAttachment:u},blitFramebuffers:[f]}}function Lt(e){var t;return e.texture?{texture:e.texture,baseMipLevel:e.mipLevel,baseArrayLayer:(t=e.origin)==null?void 0:t[2]}:void 0}function vr(e,t){const n=Er(t);be(e,n)}function Ar(e,t){if(e instanceof WebGL2RenderingContext){const n=gt(e,st.getBuffer(t.source.buffer),"COPY_READ_BUFFER"),s=gt(e,st.getBuffer(t.destination.buffer),"COPY_WRITE_BUFFER"),r=t.source.byteOffset,i=t.destination.byteOffset,o=t.size??Math.min(t.source.byteLength,t.destination.byteLength);e.bindBuffer(e.COPY_READ_BUFFER,n),e.bindBuffer(e.COPY_WRITE_BUFFER,s),e.copyBufferSubData(e.COPY_READ_BUFFER,e.COPY_WRITE_BUFFER,r,i,o),e.bindBuffer(e.COPY_READ_BUFFER,null),e.bindBuffer(e.COPY_WRITE_BUFFER,null)}else console.error("WebGL1 不支持拷贝缓冲区功能！")}function xr(e,t,n){t.passEncoders.forEach(s=>{if(!s.__type__||s.__type__==="RenderPass"){Sr(e,s,n);return}if(s.__type__==="TransformFeedbackPass"){Tr(e,s);return}if(s.__type__==="BlitFramebuffer"){be(e,s);return}if(s.__type__==="CopyTextureToTexture"){vr(e,s);return}if(s.__type__==="CopyBufferToBuffer"){Ar(e,s);return}console.error(`未处理 passEncoder ${s}`)})}function $r(e,t,n){t.commandEncoders.map(s=>xr(e,s,n)),e[Me]=~~e[Me]+1}function wr(e,t){let n;if(e instanceof WebGL2RenderingContext){const{textureView:s,origin:r,copySize:i}=t,[o,a]=i;if(s)if("context"in s.texture){s.texture;const c="rgba8unorm",{format:u,type:l}=_t(c),d=ft.getTextureBytesPerPixel(c),h=ft.getTextureDataConstructor(c),S=o*d*a;n=new h(S/h.BYTES_PER_ELEMENT),e.bindFramebuffer(e.FRAMEBUFFER,null),e.readBuffer(e.BACK);const m=a===1?e.drawingBufferHeight-r[1]-1:e.drawingBufferHeight-r[1]-a;e.readPixels(r[0],m,o,a,e[u],e[l],n,0)}else{const c="COLOR_ATTACHMENT0",l=s.texture.descriptor,{format:d,type:h}=_t(l.format),f=ft.getTextureBytesPerPixel(l.format),S=ft.getTextureDataConstructor(l.format),L=o*f*a;n=new S(L/S.BYTES_PER_ELEMENT);const _={colorAttachments:[{view:s}]},b=Yt(e,_);e.bindFramebuffer(e.FRAMEBUFFER,b),e.readBuffer(e[c]),e.readPixels(r[0],r[1],o,a,e[d],e[h],n,0),Ht(e,_)}else{const c="rgba8unorm",{format:u,type:l}=_t(c),d=ft.getTextureBytesPerPixel(c),h=ft.getTextureDataConstructor(c),S=o*d*a;n=new h(S/h.BYTES_PER_ELEMENT),e.bindFramebuffer(e.FRAMEBUFFER,null),e.readBuffer(e.BACK);const m=a===1?e.drawingBufferHeight-r[1]-1:e.drawingBufferHeight-r[1]-a;e.readPixels(r[0],m,o,a,e[u],e[l],n,0)}}else console.error("WebGL1 不支持 readBuffer/readPixels ！");return n}class Zr{constructor(t){F(this,"_renderingContext"),F(this,"_gl"),Qe.isRunWebGL=!0,this._renderingContext=t,this._gl=hs(this._renderingContext)}submit(t){$r(this._gl,t)}readPixels(t){const n=wr(this._gl,t),s=t.textureView;if(s){const r=s.texture;"context"in r?t.format="rgba8unorm":"descriptor"in r&&(t.format=r.descriptor.format||"rgba8unorm")}else t.format="rgba8unorm";return t.result=n,n}deleteFramebuffer(t){Ht(this._gl,t)}deleteRenderbuffer(t){sn(this._gl,t)}deleteBuffer(t){fs(this._gl,t)}deleteTexture(t){Es(this._gl,t)}deleteSampler(t){Ds(this._gl,t)}deleteProgram(t){Fs(this._gl,t)}deleteTransformFeedback(t){Vs(this._gl,t)}}console.log("@feng3d/webgl v0.1.0");let Gt=class{constructor(t,n){this.dependencies=[],this.elementType=(()=>new t.constructor),this.length=n,this.glslType=t.glslType,this.wgslType=t.wgslType}_setAccessPath(t,n,s){return this.toGLSL=()=>`${t}.${s}`,this.toWGSL=()=>`${n}.${s}`,this}_setVarName(t){return this._varName=t,this.toGLSL=()=>t,this.toWGSL=()=>t,this}index(t){const n=this.elementType();return n.toGLSL=()=>{const s=typeof t=="number"?`${t}`:t.toGLSL();return`${this.toGLSL()}[${s}]`},n.toWGSL=()=>{let s;return typeof t=="number"?s=`${t}`:t.toRawWGSL?s=t.toRawWGSL():s=t.toWGSL(),`${this.toWGSL()}[${s}]`},n.dependencies=typeof t=="number"?[this]:[this,t],n}};function ti(e,t){return new Gt(e,t)}let Xt;function yt(e,t){const n=Xt;Xt=e;let s;try{s=t()}catch(r){throw s=void 0,console.error("Error in buildParam",r),new Error(`Error in buildParam: ${r.message}`)}return Xt=n,s}function Kt(){return Xt}class Ln{constructor(t,n,s){this.name=t,this.value=n,this.location=s}setAutoLocation(t){this._autoLocation=t}getEffectiveLocation(){return this.location!==void 0?this.location:this._autoLocation??0}toGLSL(){var i;if(!this.value)throw new Error(`Attribute '${this.name}' 没有设置 value，无法生成 GLSL。`);const t=(i=this.value)==null?void 0:i.glslType,n=this.getEffectiveLocation(),s=Kt();return((s==null?void 0:s.version)??1)===2?`layout(location = ${n}) in ${t} ${this.name};`:`attribute ${t} ${this.name};`}toWGSL(){var r;if(!this.value)throw new Error(`Attribute '${this.name}' 没有设置 value，无法生成 WGSL。`);const t=(r=this.value)==null?void 0:r.wgslType;return`${`@location(${this.getEffectiveLocation()})`} ${this.name}: ${t}`}}function ei(e,t,n){const s=new Ln(e,void 0,n),r=new t.constructor;return r.toGLSL=()=>e,r.toWGSL=()=>e,r.dependencies=[s],s.value=r,r}const mn=Symbol("structType");function ge(e){return typeof e=="object"&&e!==null&&e[mn]===!0}const Vt=ge;class Rr{constructor(t,n){this.name=t,this.members=n}toGLSLStruct(){const t=Object.entries(this.members).map(([n,s])=>Vt(s)?`    ${s._definition.name} ${n};`:s instanceof Gt?`    ${s.glslType} ${n}[${s.length}];`:`    ${s.glslType} ${n};`);return`struct ${this.name}
{
${t.join(`
`)}
};`}toGLSLBlock(t){const n=Object.entries(this.members).map(([s,r])=>Vt(r)?`    ${r._definition.name} ${s};`:r instanceof Gt?`    ${r.glslType} ${s}[${r.length}];`:`    ${r.glslType} ${s};`);return`layout(std140, column_major) uniform;
uniform ${this.name}
{
${n.join(`
`)}
} ${t};`}toWGSLStruct(){const t=Object.entries(this.members).map(([n,s])=>Vt(s)?`    ${n}: ${s._definition.name}`:s instanceof Gt?`    ${n}: array<${s.wgslType}, ${s.length}>`:`    ${n}: ${s.wgslType}`);return`struct ${this.name}
{
${t.join(`,
`)}
}`}toWGSLUniform(t,n,s){return`@group(${n}) @binding(${s}) var<uniform> ${t}: ${this.name};`}getNestedStructDefinitions(){const t=[];for(const n of Object.values(this.members))Vt(n)&&(t.push(...n._definition.getNestedStructDefinitions()),t.push(n._definition));return t}}class ye{constructor(t,n,s){this._uniform=t,this._structDef=n;const r=s??t.name;for(const[i,o]of Object.entries(n.members)){if(o instanceof Gt){const c=new Gt(o.elementType(),o.length);c._setAccessPath(r,r,i),c.dependencies=[t],this[i]=c;continue}if(ge(o)){const c=`${r}.${i}`,u=new ye(t,o._definition,c);this[i]=u;continue}const a=new o.constructor;a.toGLSL=()=>`${r}.${i}`,a.toWGSL=()=>`${r}.${i}`,a.dependencies=[t],this[i]=a}s||(t.value={glslType:n.name,wgslType:n.name,toGLSL:()=>r,toWGSL:()=>r,dependencies:[],_isStruct:!0,_structDef:n,_instanceName:r})}_createMemberValue(t,n,s){return{glslType:s.glslType,wgslType:s.wgslType,dependencies:[],toGLSL:()=>`${t}.${n}`,toWGSL:()=>`${t}.${n}`}}}function ni(e,t){const n=new Rr(e,t);return{...t,[mn]:!0,_definition:n}}const Cr=new Set(["mat2x3<f32>","mat3x3<f32>","mat4x3<f32>"]);class Sn{constructor(t,n,s){this.name=t,this.group=n,this.binding=s}setAutoBinding(t){this._autoBinding=t}getEffectiveBinding(){return this.binding!==void 0?this.binding:this._autoBinding}toGLSL(){if(!this.value)throw new Error(`Uniform '${this.name}' 没有设置 value，无法生成 GLSL。`);return`uniform ${this.value.glslType} ${this.name};`}getEffectiveGroup(){return this.group??0}toWGSL(){if(!this.value)throw new Error(`Uniform '${this.name}' 没有设置 value，无法生成 WGSL。`);const t=this.value.wgslType;Cr.has(t)&&console.warn(`[TSL] ${t} uniform "${this.name}" 在 WebGPU uniform buffer 中需要对齐，建议避免使用。
WebGPU uniform buffer 要求每列按 vec4 对齐（16 字节），会造成额外的内存开销和数据转换。
建议使用 mat4 代替，或将数据拆分为多个 vec3/vec4 uniform。`);const n=this.getEffectiveBinding(),s=this.getEffectiveGroup(),r=n!==void 0?`@binding(${n})`:"",i=`@group(${s})`,o=[r,i].filter(Boolean).join(" ");return`${o?`${o} `:""}var<uniform> ${this.name} : ${t};`}}function si(e,t,n,s){const r=new Sn(e,n,s);if(t===void 0)return r;if(ge(t))return new ye(r,t._definition);const i=new t.constructor;return i.toGLSL=()=>e,i.toWGSL=()=>e,i.dependencies=[r],r.value=i,i}class _n{constructor(t,n){this.dependencies=[],this.name=t,typeof n=="number"?(this.location=n,this.interpolation="perspective",this.sampling="center"):(this.location=n==null?void 0:n.location,this.interpolation=(n==null?void 0:n.interpolation)??"perspective",this.sampling=(n==null?void 0:n.sampling)??"center")}setAutoLocation(t){this._autoLocation=t}getEffectiveLocation(){return this.location!==void 0?this.location:this._autoLocation??0}getGLSLInterpolationQualifier(){const t=[];return this.interpolation==="flat"?t.push("flat"):this.interpolation==="linear"&&t.push("noperspective"),this.sampling==="centroid"?t.push("centroid"):this.sampling==="sample"&&t.push("sample"),t.length>0?t.join(" ")+" ":""}toGLSL(){if(!this.value)throw new Error(`Varying '${this.name}' 没有设置 value，无法生成 GLSL。`);const t=this.value.glslType,n=Kt(),s=n.version??1,r=n.stage;if(s===2){const i=r==="vertex"?"out":"in";return`${this.getGLSLInterpolationQualifier()}${i} ${t} ${this.name};`}else return`varying ${t} ${this.name};`}getWGSLInterpolateAttribute(){return this.interpolation==="flat"?"@interpolate(flat)":this.interpolation==="perspective"&&this.sampling==="center"?"":`@interpolate(${this.interpolation}, ${this.sampling})`}toWGSL(){if(!this.value)throw new Error(`Varying '${this.name}' 没有设置 value，无法生成 WGSL。`);const t=this.value.wgslType,s=`@location(${this.getEffectiveLocation()})`,r=this.getWGSLInterpolateAttribute();return r?`${s} ${r} ${this.name}: ${t}`:`${s} ${this.name}: ${t}`}getVarName(){return this.name}}function ri(e,t,n){const s=new _n(e,n),r=new t.constructor;return r.toGLSL=()=>e,r.toWGSL=()=>e,r.dependencies=[s],s.value=r,r}let Gn=null;function Qt(e){Gn=e}function bn(){return Gn}let jt=[];function ii(e){jt.push(e)}function oi(){jt.pop()}function Wr(){return jt[jt.length-1]||null}function g(e){if(/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(e))return e;if(e.startsWith("(")&&e.endsWith(")")){let s=0;for(let r=0;r<e.length&&(e[r]==="("?s++:e[r]===")"&&s--,!(s===0&&r<e.length-1));r++);if(s===0)return e}const t=/^[a-zA-Z_][a-zA-Z0-9_<>]*\s*\(/.exec(e);if(t){let s=0,r=t[0].length-1;for(;r<e.length;r++)if(e[r]==="("?s++:e[r]===")"&&s--,s===0){if(r===e.length-1)return e;break}}let n=0;for(let s=0;s<e.length;s++){const r=e[s];if(r==="("||r==="[")n++;else if(r===")"||r==="]")n--;else if(n===0&&(r==="+"||r==="-"||r==="*"||r==="/"||r==="%")){if(r==="-"&&(s===0||/[+\-*/%([]/.test(e[s-1])))continue;return`(${e})`}}return e}function gn(e){if(/^-?\d+(\.\d+)?[eE][+-]?\d+$/.test(e)||/^-?\d+(\.\d+)?$/.test(e))return!1;const t=/^[a-zA-Z_][a-zA-Z0-9_]*\s*\(/.exec(e);if(t){let n=0,s=t[0].length-1;for(;s<e.length;s++)if(e[s]==="("?n++:e[s]===")"&&n--,n===0){if(s===e.length-1)return!1;break}}return/[+\-*/%]/.test(e)}function Fr(e){return/[+-]/.test(e)}function Ir(e){return/[*\/%]/.test(e)}function Pr(e){if(!gn(e))return null;const t=Fr(e),n=Ir(e);return t&&n||t?"addsub":n?"muldiv":null}function Nr(e,t){return t?`(${e})`:e}function p(e,t,n,s){if(typeof e=="number")return e.toString();const r=s();if(!gn(r))return r;const o=Pr(r);let a=!1;return t==="+"||(t==="-"?n||o==="addsub"&&(a=!0):t==="*"?o==="addsub"&&(a=!0):(t==="/"||t==="%")&&(n?o==="addsub"&&(a=!0):a=!0)),Nr(r,a)}function G(e){if(Number.isInteger(e))return`${e}.0`;const t=Math.abs(e);return t!==0&&(t<1e-6||t>=1e15)||!Number.isFinite(e)?e.toExponential().replace(/e/i,"e"):String(e).replace(/E/g,"e")}class Nt{constructor(...t){if(this.glslType="ivec2",this.wgslType="vec2<i32>",t.length!==0)if(t.length===1)if(t[0]instanceof I){const n=t[0];this.toGLSL=()=>`ivec2(${n.toGLSL()})`,this.toWGSL=()=>`vec2<i32>(${n.toWGSL()})`,this.dependencies=[n]}else throw new Error("IVec2 constructor: invalid argument");else if(t.length===2&&typeof t[0]=="number"&&typeof t[1]=="number"){const n=t[0],s=t[1];this.toGLSL=()=>`ivec2(${n}, ${s})`,this.toWGSL=()=>`vec2<i32>(${n}, ${s})`,this.dependencies=[]}else throw new Error("IVec2 constructor: invalid arguments")}get x(){const t=new y;return t.toGLSL=()=>`${this.toGLSL()}.x`,t.toWGSL=()=>`${this.toWGSL()}.x`,t.dependencies=[this],t}get y(){const t=new y;return t.toGLSL=()=>`${this.toGLSL()}.y`,t.toWGSL=()=>`${this.toWGSL()}.y`,t.dependencies=[this],t}add(t){const n=new Nt;return n.toGLSL=()=>`${this.toGLSL()} + ${t.toGLSL()}`,n.toWGSL=()=>`${this.toWGSL()} + ${t.toWGSL()}`,n.dependencies=[this,t],n}subtract(t){const n=new Nt;return typeof t=="number"?(n.toGLSL=()=>`${this.toGLSL()} - ${t}`,n.toWGSL=()=>`${this.toWGSL()} - vec2<i32>(${t})`,n.dependencies=[this]):(n.toGLSL=()=>`${this.toGLSL()} - ${t.toGLSL()}`,n.toWGSL=()=>`${this.toWGSL()} - ${t.toWGSL()}`,n.dependencies=[this,t]),n}}function ai(...e){return new Nt(...e)}class I{constructor(...t){if(this.glslType="vec2",this.wgslType="vec2<f32>",t.length!==0)if(t.length===1)if(t[0]instanceof Nt){const n=t[0];this.toGLSL=()=>`vec2(${n.toGLSL()})`,this.toWGSL=()=>`vec2<f32>(${n.toWGSL()})`,this.dependencies=[n]}else if(typeof t[0]=="object"&&"glslType"in t[0]&&(t[0].glslType==="vec3"||t[0].glslType==="vec4")){const n=t[0];this.toGLSL=()=>`vec2(${n.toGLSL()})`,this.toWGSL=()=>`${g(n.toWGSL())}.xy`,this.dependencies=[n]}else throw new Error("Vec2 构造函数：无效的参数");else if(t.length===2){const n=t[0],s=t[1];if(typeof n!="number"&&!(n instanceof y)||typeof s!="number"&&!(s instanceof y))throw new Error("Vec2 构造函数：无效的参数，期望 number 或 Float 类型");n instanceof y||s instanceof y?(this.toGLSL=()=>`vec2(${typeof n=="number"?G(n):n.toGLSL()}, ${typeof s=="number"?G(s):s.toGLSL()})`,this.toWGSL=()=>`vec2<f32>(${typeof n=="number"?G(n):n.toWGSL()}, ${typeof s=="number"?G(s):s.toWGSL()})`,this.dependencies=[n,s].filter(r=>r instanceof y)):(n===s?(this.toGLSL=()=>`vec2(${G(n)})`,this.toWGSL=()=>`vec2<f32>(${G(n)})`):(this.toGLSL=()=>`vec2(${G(n)}, ${G(s)})`,this.toWGSL=()=>`vec2<f32>(${G(n)}, ${G(s)})`),this.dependencies=[])}else throw new Error("Vec2 构造函数：无效的参数")}get x(){const t=new y;return t.toGLSL=()=>`${g(this.toGLSL())}.x`,t.toWGSL=()=>`${g(this.toWGSL())}.x`,t.dependencies=[this],t}get y(){const t=new y;return t.toGLSL=()=>`${g(this.toGLSL())}.y`,this._builtin&&this._builtin.isFragCoord?t.toWGSL=()=>`(-${g(this.toWGSL())}.y)`:t.toWGSL=()=>`${g(this.toWGSL())}.y`,t.dependencies=[this],t}multiply(t){const n=new I(0,0);return t instanceof I?(n.toGLSL=()=>{const s=p(this,"*",!0,()=>this.toGLSL()),r=p(t,"*",!1,()=>t.toGLSL());return`${s} * ${r}`},n.toWGSL=()=>{const s=p(this,"*",!0,()=>this.toWGSL()),r=p(t,"*",!1,()=>t.toWGSL());return`${s} * ${r}`},n.dependencies=[this,t]):(n.toGLSL=()=>{const s=p(this,"*",!0,()=>this.toGLSL()),r=typeof t=="number"?t.toString():p(t,"*",!1,()=>t.toGLSL());return`${s} * ${r}`},n.toWGSL=()=>{const s=p(this,"*",!0,()=>this.toWGSL()),r=typeof t=="number"?t.toString():p(t,"*",!1,()=>t.toWGSL());return`${s} * ${r}`},n.dependencies=typeof t=="number"?[this]:[this,t]),n}add(t){const n=new I(0,0);return n.toGLSL=()=>{const s=p(this,"+",!0,()=>this.toGLSL()),r=p(t,"+",!1,()=>t.toGLSL());return`${s} + ${r}`},n.toWGSL=()=>{const s=p(this,"+",!0,()=>this.toWGSL()),r=p(t,"+",!1,()=>t.toWGSL());return`${s} + ${r}`},n.dependencies=[this,t],n}subtract(t){const n=new I(0,0);return n.toGLSL=()=>{const s=p(this,"-",!0,()=>this.toGLSL()),r=p(t,"-",!1,()=>t.toGLSL());return`${s} - ${r}`},n.toWGSL=()=>{const s=p(this,"-",!0,()=>this.toWGSL()),r=p(t,"-",!1,()=>t.toWGSL());return`${s} - ${r}`},n.dependencies=[this,t],n}divide(t){const n=new I(0,0);return t instanceof I?(n.toGLSL=()=>{const s=p(this,"/",!0,()=>this.toGLSL()),r=p(t,"/",!1,()=>t.toGLSL());return`${s} / ${r}`},n.toWGSL=()=>{const s=p(this,"/",!0,()=>this.toWGSL()),r=p(t,"/",!1,()=>t.toWGSL());return`${s} / ${r}`},n.dependencies=[this,t]):(n.toGLSL=()=>{const s=p(this,"/",!0,()=>this.toGLSL()),r=typeof t=="number"?G(t):p(t,"/",!1,()=>t.toGLSL());return`${s} / ${r}`},n.toWGSL=()=>{const s=p(this,"/",!0,()=>this.toWGSL()),r=typeof t=="number"?G(t):p(t,"/",!1,()=>t.toWGSL());return`${s} / ${r}`},n.dependencies=typeof t=="number"?[this]:[this,t]),n}assign(t){new Tt(this,t)}}function Or(...e){return new I(...e)}function Ur(e){return e.replace(/_([a-z])/g,(t,n)=>n.toUpperCase())}class X{constructor(t){this.dependencies=[],this.builtinName=t}setStructVarPrefix(t){this._structVarPrefix=t}getFullWGSLVarName(){return this._structVarPrefix?`${this._structVarPrefix}.${this.defaultName}`:this.defaultName}hasStructVarPrefix(){return this._structVarPrefix!==void 0}get wgslBuiltinName(){return this.builtinName==="gl_Position"?"position":this.builtinName==="gl_FrontFacing"?"front_facing":this.builtinName==="gl_VertexID"?"vertex_index":this.builtinName==="gl_FragCoord"?"position":this.builtinName==="gl_InstanceID"?"instance_index":this.builtinName==="gl_PointSize"?"point_size":this.builtinName}get defaultName(){return this.isFragCoord?"fragCoord":this.isFragColorOutput?"fragColor":Ur(this.wgslBuiltinName)}get isPosition(){return this.builtinName==="gl_Position"}get isFrontFacing(){return this.builtinName==="gl_FrontFacing"}get isVertexIndex(){return this.builtinName==="gl_VertexID"}get isFragCoord(){return this.builtinName==="gl_FragCoord"}get isInstanceIndex(){return this.builtinName==="gl_InstanceID"}get isFragColorOutput(){return this.builtinName==="gl_FragColor"}get isPointSize(){return this.builtinName==="gl_PointSize"}toGLSL(){if(this.isPosition)return"gl_Position";if(this.isFrontFacing)return"gl_FrontFacing";if(this.isVertexIndex)return"gl_VertexID";if(this.isFragCoord)return"gl_FragCoord";if(this.isInstanceIndex)return"gl_InstanceID";if(this.isFragColorOutput)return"gl_FragColor";if(this.isPointSize)return"gl_PointSize";throw new Error(`Builtin '${this.builtinName}' 不支持 GLSL，无法生成 GLSL 代码。`)}toWGSL(){if(this.isFragColorOutput)return this.defaultName;let t;if(this.isFrontFacing)t="bool";else if(this.isVertexIndex||this.isInstanceIndex)t="u32";else if(this.isFragCoord||this.isPosition)t="vec4<f32>";else if(this.isPointSize)t="f32";else{if(!this.value)throw new Error(`Builtin '${this.builtinName}' 的 value 没有设置，无法生成 WGSL。`);t=this.value.wgslType??"vec4<f32>"}return`@builtin(${this.wgslBuiltinName}) ${this.defaultName}: ${t}`}}function ut(e,t){const n=new X(e),s=new t.constructor;return s.toGLSL=()=>n.toGLSL(),e==="gl_VertexID"||e==="gl_InstanceID"?(s.toWGSL=()=>`i32(${n.getFullWGSLVarName()})`,s.toRawWGSL=()=>n.getFullWGSLVarName()):s.toWGSL=()=>n.getFullWGSLVarName(),s.dependencies=[n],n.value=s,e==="gl_FragCoord"&&s instanceof I&&(s._builtin=n),s}class Tt{constructor(t,n){this.target=t,this.value=n;const s=bn();if(s){const r=Wr();r?r.addStatement(this):s.statements.push(this),s.dependencies.push(t),s.dependencies.push(n)}}toGLSL(){const t=Kt();let n=!1;if(this.target instanceof X&&this.target.isFragColorOutput)n=!0;else if(this.target&&"dependencies"in this.target&&Array.isArray(this.target.dependencies)){const s=this.target.dependencies[0];s instanceof X&&s.isFragColorOutput&&(n=!0)}return n&&(t==null?void 0:t.version)===2?`color = ${this.value.toGLSL()};`:`${this.target.toGLSL()} = ${this.value.toGLSL()};`}toWGSL(){const t=Kt();let n=!1;if(this.target instanceof X&&this.target.isPointSize)n=!0;else if(this.target&&"dependencies"in this.target&&Array.isArray(this.target.dependencies)){const i=this.target.dependencies[0];i instanceof X&&i.isPointSize&&(n=!0)}if(n)return console.warn("[TSL] gl_PointSize is not supported in WebGPU, assignment will be ignored."),"// gl_PointSize not supported in WebGPU";let s=!1;if(this.target instanceof X&&this.target.isPosition)s=!0;else if(this.target&&"dependencies"in this.target&&Array.isArray(this.target.dependencies)){const i=this.target.dependencies[0];i instanceof X&&i.isPosition&&(s=!0)}let r=!1;if(this.target instanceof X&&this.target.isFragColorOutput)r=!0;else if(this.target&&"dependencies"in this.target&&Array.isArray(this.target.dependencies)){const i=this.target.dependencies[0];i instanceof X&&i.isFragColorOutput&&(r=!0)}if(r&&t.stage==="fragment")return`fragColor = ${this.value.toWGSL()};`;if(s&&t.stage==="compute"){const i=this.target.toWGSL();return i.includes("/*")&&i.includes("*/")?"// gl_Position assignment ignored in compute shader":`${i} = ${this.value.toWGSL()};`}if(s&&t.stage==="vertex"){const i=this.value.toWGSL();let o;if(this.target instanceof X&&this.target.isPosition)o=this.target;else if(this.target&&"dependencies"in this.target&&Array.isArray(this.target.dependencies)){const c=this.target.dependencies[0];c instanceof X&&c.isPosition&&(o=c)}return`${o&&o.hasStructVarPrefix()?o.getFullWGSLVarName():this.target.toWGSL()} = ${i};`}else return`${this.target.toWGSL()} = ${this.value.toWGSL()};`}}class Q{constructor(...t){if(this.glslType="bool",this.wgslType="bool",t.length!==0)if(t.length===1&&typeof t[0]=="boolean"){const n=t[0];this.dependencies=[],this.toGLSL=()=>n.toString(),this.toWGSL=()=>n.toString()}else throw new Error("Invalid arguments for Bool")}equals(t){const n=new Q,s=t instanceof Q;return n.toGLSL=()=>{const r=this.toGLSL(),i=s?t.toGLSL():typeof t=="boolean"?t.toString():t;return`${r} == ${i}`},n.toWGSL=()=>{const r=this.toWGSL(),i=s?t.toWGSL():typeof t=="boolean"?t.toString():t;return`${r} == ${i}`},n.dependencies=s?[this,t]:[this],n}or(t){const n=new Q;return n.toGLSL=()=>{const s=this.toGLSL(),r=t.toGLSL();return`(${s}) || (${r})`},n.toWGSL=()=>{const s=this.toWGSL(),r=t.toWGSL();return`(${s}) || (${r})`},n.dependencies=[this,t],n}and(t){const n=new Q;return n.toGLSL=()=>{const s=this.toGLSL(),r=t.toGLSL();return`(${s}) && (${r})`},n.toWGSL=()=>{const s=this.toWGSL(),r=t.toWGSL();return`(${s}) && (${r})`},n.dependencies=[this,t],n}}function Mr(e){return new Q}class Ot{constructor(...t){if(this.glslType="uint",this.wgslType="u32",this._isGLSLInt=!1,t.length!==0)if(t.length===1&&typeof t[0]=="number"){const n=t[0],s=Math.floor(n);this.toGLSL=()=>`${s}u`,this.toWGSL=()=>`${s}u`,this.dependencies=[]}else if(t.length===1&&typeof t[0]=="object"){const n=t[0];this.dependencies=[n],this.toGLSL=()=>`uint(${n.toGLSL()})`,this.toWGSL=()=>`u32(${n.toWGSL()})`}else throw new Error("Invalid arguments for UInt")}divide(t){const n=new Ot,s=Math.floor(t);return n.toGLSL=()=>`${this.toGLSL()} / ${s}${this._isGLSLInt?"":"u"}`,n.toWGSL=()=>`${this.toWGSL()} / ${s}u`,n.dependencies=[this],n._isGLSLInt=this._isGLSLInt,n}mod(t){const n=new Ot;return n.toGLSL=()=>{const s=p(this,"%",!0,()=>this.toGLSL()),r=typeof t=="number"?`${Math.floor(t)}${this._isGLSLInt?"":"u"}`:p(t,"%",!1,()=>t.toGLSL());return`${s} % ${r}`},n.toWGSL=()=>{const s=p(this,"%",!0,()=>this.toWGSL()),r=typeof t=="number"?`${Math.floor(t)}u`:p(t,"%",!1,()=>t.toWGSL());return`${s} % ${r}`},n.dependencies=typeof t=="number"?[this]:[this,t],n._isGLSLInt=this._isGLSLInt,n}equals(t){const n=new Q;if(typeof t=="number"){const s=Math.floor(t);n.toGLSL=()=>`(${this.toGLSL()} == ${s}${this._isGLSLInt?"":"u"})`,n.toWGSL=()=>`(${this.toWGSL()} == ${s}u)`,n.dependencies=[this]}else n.toGLSL=()=>`(${this.toGLSL()} == ${t.toGLSL()})`,n.toWGSL=()=>`(${this.toWGSL()} == ${t.toWGSL()})`,n.dependencies=[this,t];return n}}class it{constructor(...t){var n;if(this.glslType="int",this.wgslType="i32",t.length!==0)if(t.length===1&&typeof t[0]=="number"){const s=t[0],r=Math.floor(s);this.toGLSL=()=>`${r}`,this.toWGSL=()=>`${r}`,this.dependencies=[]}else if(t.length===1&&t[0]instanceof it){const s=t[0];this.toGLSL=()=>s.toGLSL(),this.toWGSL=()=>s.toWGSL(),this.dependencies=s.dependencies?[...s.dependencies]:[]}else if(t.length===1&&t[0]instanceof Ot){const s=t[0];if(this.dependencies=[s],(n=s.dependencies)==null?void 0:n.some(i=>i instanceof X&&i.isInstanceIndex)){const i=s.dependencies.find(o=>o instanceof X);this.toGLSL=()=>i.toGLSL(),this.toWGSL=()=>`i32(${s.toWGSL()})`}else this.toGLSL=()=>`int(${s.toGLSL()})`,this.toWGSL=()=>`i32(${s.toWGSL()})`}else throw new Error("Invalid arguments for Int")}assign(t){if(typeof t=="number"){const n=new it(t);new Tt(this,n)}else new Tt(this,t)}equals(t){const n=new Q;if(typeof t=="number"){const s=Math.floor(t);n.toGLSL=()=>`(${this.toGLSL()} == ${s})`,n.toWGSL=()=>`(${this.toWGSL()} == ${s})`,n.dependencies=[this]}else n.toGLSL=()=>`(${this.toGLSL()} == ${t.toGLSL()})`,n.toWGSL=()=>`(${this.toWGSL()} == ${t.toWGSL()})`,n.dependencies=[this,t];return n}mod(t){const n=new it;if(typeof t=="number"){const s=Math.floor(t);n.toGLSL=()=>`${this.toGLSL()} % ${s}`,n.toWGSL=()=>`${this.toWGSL()} % ${s}`,n.dependencies=[this]}else n.toGLSL=()=>`${this.toGLSL()} % ${t.toGLSL()}`,n.toWGSL=()=>`${this.toWGSL()} % ${t.toWGSL()}`,n.dependencies=[this,t];return n}divide(t){const n=new it;if(typeof t=="number"){const s=Math.floor(t);n.toGLSL=()=>`${this.toGLSL()} / ${s}`,n.toWGSL=()=>`${this.toWGSL()} / ${s}`,n.dependencies=[this]}else n.toGLSL=()=>`${this.toGLSL()} / ${t.toGLSL()}`,n.toWGSL=()=>`${this.toWGSL()} / ${t.toWGSL()}`,n.dependencies=[this,t];return n}}function yn(...e){return new it(...e)}class O{constructor(...t){if(this.glslType="vec3",this.wgslType="vec3<f32>",t.length!==0)if(t.length===1&&(typeof t[0]=="number"||t[0]instanceof y)){const n=t[0];typeof n=="number"?(this.toGLSL=()=>`vec3(${G(n)})`,this.toWGSL=()=>`vec3<f32>(${G(n)})`,this.dependencies=[]):(this.toGLSL=()=>`vec3(${n.toGLSL()})`,this.toWGSL=()=>`vec3<f32>(${n.toWGSL()})`,this.dependencies=[n])}else if(t.length===2&&t[0]instanceof I){const n=t[0],s=t[1];typeof s=="number"?(this.toGLSL=()=>`vec3(${n.toGLSL()}, ${G(s)})`,this.toWGSL=()=>`vec3<f32>(${n.toWGSL()}, ${G(s)})`,this.dependencies=[n]):(this.toGLSL=()=>`vec3(${n.toGLSL()}, ${s.toGLSL()})`,this.toWGSL=()=>`vec3<f32>(${n.toWGSL()}, ${s.toWGSL()})`,this.dependencies=[n,s])}else if(t.length===3&&typeof t[0]=="number"&&typeof t[1]=="number"&&typeof t[2]=="number"){const n=t[0],s=t[1],r=t[2];n===s&&s===r?(this.toGLSL=()=>`vec3(${G(n)})`,this.toWGSL=()=>`vec3<f32>(${G(n)})`):(this.toGLSL=()=>`vec3(${G(n)}, ${G(s)}, ${G(r)})`,this.toWGSL=()=>`vec3<f32>(${G(n)}, ${G(s)}, ${G(r)})`),this.dependencies=[]}else if(t.length===3&&t[0]instanceof y&&t[1]instanceof y&&t[2]instanceof y){const n=t[0],s=t[1],r=t[2];this.toGLSL=()=>`vec3(${n.toGLSL()}, ${s.toGLSL()}, ${r.toGLSL()})`,this.toWGSL=()=>`vec3<f32>(${n.toWGSL()}, ${s.toWGSL()}, ${r.toWGSL()})`,this.dependencies=[n,s,r]}else throw new Error("Invalid arguments for vec3")}get x(){const t=new y;return t.toGLSL=()=>`${g(this.toGLSL())}.x`,t.toWGSL=()=>`${g(this.toWGSL())}.x`,t.dependencies=[this],t}get y(){const t=new y;return t.toGLSL=()=>`${g(this.toGLSL())}.y`,t.toWGSL=()=>`${g(this.toWGSL())}.y`,t.dependencies=[this],t}get z(){const t=new y;return t.toGLSL=()=>`${g(this.toGLSL())}.z`,t.toWGSL=()=>`${g(this.toWGSL())}.z`,t.dependencies=[this],t}get r(){const t=new y;return t.toGLSL=()=>`${g(this.toGLSL())}.r`,t.toWGSL=()=>`${g(this.toWGSL())}.r`,t.dependencies=[this],t}get g(){const t=new y;return t.toGLSL=()=>`${g(this.toGLSL())}.g`,t.toWGSL=()=>`${g(this.toWGSL())}.g`,t.dependencies=[this],t}get b(){const t=new y;return t.toGLSL=()=>`${g(this.toGLSL())}.b`,t.toWGSL=()=>`${g(this.toWGSL())}.b`,t.dependencies=[this],t}multiply(t){const n=new O;return t instanceof O?(n.toGLSL=()=>{const s=p(this,"*",!0,()=>this.toGLSL()),r=p(t,"*",!1,()=>t.toGLSL());return`${s} * ${r}`},n.toWGSL=()=>{const s=p(this,"*",!0,()=>this.toWGSL()),r=p(t,"*",!1,()=>t.toWGSL());return`${s} * ${r}`},n.dependencies=[this,t]):(n.toGLSL=()=>{const s=p(this,"*",!0,()=>this.toGLSL()),r=typeof t=="number"?G(t):p(t,"*",!1,()=>t.toGLSL());return`${s} * ${r}`},n.toWGSL=()=>{const s=p(this,"*",!0,()=>this.toWGSL()),r=typeof t=="number"?G(t):p(t,"*",!1,()=>t.toWGSL());return`${s} * ${r}`},n.dependencies=typeof t=="number"?[this]:[this,t]),n}add(t){const n=new O;return n.toGLSL=()=>{const s=p(this,"+",!0,()=>this.toGLSL()),r=p(t,"+",!1,()=>t.toGLSL());return`${s} + ${r}`},n.toWGSL=()=>{const s=p(this,"+",!0,()=>this.toWGSL()),r=p(t,"+",!1,()=>t.toWGSL());return`${s} + ${r}`},n.dependencies=[this,t],n}subtract(t){const n=new O;return typeof t=="number"?(n.toGLSL=()=>`${p(this,"-",!0,()=>this.toGLSL())} - ${G(t)}`,n.toWGSL=()=>`${p(this,"-",!0,()=>this.toWGSL())} - vec3<f32>(${G(t)})`,n.dependencies=[this]):(n.toGLSL=()=>{const s=p(this,"-",!0,()=>this.toGLSL()),r=p(t,"-",!1,()=>t.toGLSL());return`${s} - ${r}`},n.toWGSL=()=>{const s=p(this,"-",!0,()=>this.toWGSL()),r=p(t,"-",!1,()=>t.toWGSL());return`${s} - ${r}`},n.dependencies=[this,t]),n}negate(){const t=new O;return t.toGLSL=()=>`-${g(this.toGLSL())}`,t.toWGSL=()=>`-${g(this.toWGSL())}`,t.dependencies=[this],t}divide(t){const n=new O;return t instanceof O?(n.toGLSL=()=>{const s=p(this,"/",!0,()=>this.toGLSL()),r=p(t,"/",!1,()=>t.toGLSL());return`${s} / ${r}`},n.toWGSL=()=>{const s=p(this,"/",!0,()=>this.toWGSL()),r=p(t,"/",!1,()=>t.toWGSL());return`${s} / ${r}`},n.dependencies=[this,t]):(n.toGLSL=()=>{const s=p(this,"/",!0,()=>this.toGLSL()),r=typeof t=="number"?G(t):p(t,"/",!1,()=>t.toGLSL());return`${s} / ${r}`},n.toWGSL=()=>{const s=p(this,"/",!0,()=>this.toWGSL()),r=typeof t=="number"?G(t):p(t,"/",!1,()=>t.toWGSL());return`${s} / ${r}`},n.dependencies=typeof t=="number"?[this]:[this,t]),n}assign(t){new Tt(this,t)}}function ci(...e){return new O(...e)}class Te{constructor(t,n){this.dependencies=[],this.location=t,this.name=n??`fragColor${t}`,this.toGLSL=()=>this.name,this.toWGSL=()=>this.name}}function ui(e,t){return new Te(e,t)}class qt{constructor(...t){if(this.glslType="uvec4",this.wgslType="vec4<u32>",t.length!==0)if(t.length===1)if(t[0]instanceof Y){const n=t[0];this.toGLSL=()=>`uvec4(${n.toGLSL()})`,this.toWGSL=()=>`vec4<u32>(${n.toWGSL()})`,this.dependencies=[n]}else throw new Error("Uvec4 constructor: invalid argument");else if(t.length===4&&typeof t[0]=="number"&&typeof t[1]=="number"&&typeof t[2]=="number"&&typeof t[3]=="number"){const n=t[0],s=t[1],r=t[2],i=t[3];this.toGLSL=()=>`uvec4(${n}, ${s}, ${r}, ${i})`,this.toWGSL=()=>`vec4<u32>(${n}, ${s}, ${r}, ${i})`,this.dependencies=[]}else throw new Error("Uvec4 constructor: invalid arguments")}get x(){const t=new y;return t.toGLSL=()=>`${this.toGLSL()}.x`,t.toWGSL=()=>`${this.toWGSL()}.x`,t.dependencies=[this],t}get y(){const t=new y;return t.toGLSL=()=>`${this.toGLSL()}.y`,t.toWGSL=()=>`${this.toWGSL()}.y`,t.dependencies=[this],t}get z(){const t=new y;return t.toGLSL=()=>`${this.toGLSL()}.z`,t.toWGSL=()=>`${this.toWGSL()}.z`,t.dependencies=[this],t}get w(){const t=new y;return t.toGLSL=()=>`${this.toGLSL()}.w`,t.toWGSL=()=>`${this.toWGSL()}.w`,t.dependencies=[this],t}divide(t){const n=new qt;return n.toGLSL=()=>`${this.toGLSL()} / ${t}u`,n.toWGSL=()=>`${this.toWGSL()} / ${t}u`,n.dependencies=[this],n}multiply(t){const n=new qt;return n.toGLSL=()=>`${this.toGLSL()} * ${t}u`,n.toWGSL=()=>`${this.toWGSL()} * ${t}u`,n.dependencies=[this],n}}class Y{constructor(...t){if(this.glslType="vec4",this.wgslType="vec4<f32>",t.length!==0)if(t.length===1)if(t[0]instanceof Te){const n=t[0];this.toGLSL=()=>n.toGLSL(),this.toWGSL=()=>n.toWGSL(),this.dependencies=[n]}else if(t[0]instanceof Y){const n=t[0];this.toGLSL=n.toGLSL,this.toWGSL=n.toWGSL,this.dependencies=n.dependencies}else if(t[0]instanceof qt){const n=t[0];this.toGLSL=()=>`vec4(${n.toGLSL()})`,this.toWGSL=()=>`vec4<f32>(${n.toWGSL()})`,this.dependencies=[n]}else if(typeof t[0]=="number"||t[0]instanceof y){const n=t[0];typeof n=="number"?(this.toGLSL=()=>`vec4(${G(n)})`,this.toWGSL=()=>`vec4<f32>(${G(n)})`,this.dependencies=[]):(this.toGLSL=()=>`vec4(${n.toGLSL()})`,this.toWGSL=()=>`vec4<f32>(${n.toWGSL()})`,this.dependencies=[n])}else throw new Error("Vec4 constructor: invalid argument");else if(t.length===3&&t[0]instanceof I&&typeof t[1]=="number"&&typeof t[2]=="number"){const n=t[0],s=t[1],r=t[2];this.toGLSL=()=>`vec4(${n.toGLSL()}, ${G(s)}, ${G(r)})`,this.toWGSL=()=>`vec4<f32>(${n.toWGSL()}, ${G(s)}, ${G(r)})`,this.dependencies=[n]}else if(t.length===2&&t[0]instanceof I&&t[1]instanceof I){const n=t[0],s=t[1];this.toGLSL=()=>`vec4(${n.toGLSL()}, ${s.toGLSL()})`,this.toWGSL=()=>`vec4<f32>(${n.toWGSL()}, ${s.toWGSL()})`,this.dependencies=[n,s]}else if(t.length===2&&(t[0]instanceof O||t[0]&&t[0].glslType==="vec3")&&(typeof t[1]=="number"||t[1]instanceof y)){const n=t[0],s=t[1];typeof s=="number"?(this.toGLSL=()=>`vec4(${n.toGLSL()}, ${G(s)})`,this.toWGSL=()=>`vec4<f32>(${n.toWGSL()}, ${G(s)})`,this.dependencies=[n]):(this.toGLSL=()=>`vec4(${n.toGLSL()}, ${s.toGLSL()})`,this.toWGSL=()=>`vec4<f32>(${n.toWGSL()}, ${s.toWGSL()})`,this.dependencies=[n,s])}else if(t.length===4){const n=t[0],s=t[1],r=t[2],i=t[3];typeof n=="number"&&typeof s=="number"&&typeof r=="number"&&typeof i=="number"&&n===s&&s===r&&r===i?(this.toGLSL=()=>`vec4(${G(n)})`,this.toWGSL=()=>`vec4<f32>(${G(n)})`,this.dependencies=[]):(this.toGLSL=()=>`vec4(${typeof n=="number"?G(n):n.toGLSL()}, ${typeof s=="number"?G(s):s.toGLSL()}, ${typeof r=="number"?G(r):r.toGLSL()}, ${typeof i=="number"?G(i):i.toGLSL()})`,this.toWGSL=()=>`vec4<f32>(${typeof n=="number"?G(n):n.toWGSL()}, ${typeof s=="number"?G(s):s.toWGSL()}, ${typeof r=="number"?G(r):r.toWGSL()}, ${typeof i=="number"?G(i):i.toWGSL()})`,this.dependencies=[n,s,r,i].filter(o=>o instanceof y))}else throw new Error("Vec4 constructor: invalid arguments")}get x(){const t=new y;return t.toGLSL=()=>`${g(this.toGLSL())}.x`,t.toWGSL=()=>`${g(this.toWGSL())}.x`,t.dependencies=[this],t}get y(){const t=new y;return t.toGLSL=()=>`${g(this.toGLSL())}.y`,t.toWGSL=()=>`${g(this.toWGSL())}.y`,t.dependencies=[this],t}get z(){const t=new y;return t.toGLSL=()=>`${g(this.toGLSL())}.z`,t.toWGSL=()=>`${g(this.toWGSL())}.z`,t.dependencies=[this],t}get w(){const t=new y;return t.toGLSL=()=>`${g(this.toGLSL())}.w`,t.toWGSL=()=>`${g(this.toWGSL())}.w`,t.dependencies=[this],t}get xy(){const t=new I;return t.toGLSL=()=>`${g(this.toGLSL())}.xy`,t.toWGSL=()=>`${g(this.toWGSL())}.xy`,t.dependencies=[this],t}get zw(){const t=new I;return t.toGLSL=()=>`${g(this.toGLSL())}.zw`,t.toWGSL=()=>`${g(this.toWGSL())}.zw`,t.dependencies=[this],t}get xyz(){const t=new O;return t.toGLSL=()=>`${g(this.toGLSL())}.xyz`,t.toWGSL=()=>`${g(this.toWGSL())}.xyz`,t.dependencies=[this],t}get r(){const t=new y;return t.toGLSL=()=>`${g(this.toGLSL())}.r`,t.toWGSL=()=>`${g(this.toWGSL())}.r`,t.dependencies=[this],t}get g(){const t=new y;return t.toGLSL=()=>`${g(this.toGLSL())}.g`,t.toWGSL=()=>`${g(this.toWGSL())}.g`,t.dependencies=[this],t}get b(){const t=new y;return t.toGLSL=()=>`${g(this.toGLSL())}.b`,t.toWGSL=()=>`${g(this.toWGSL())}.b`,t.dependencies=[this],t}get rgb(){const t=new O;return t.toGLSL=()=>`${g(this.toGLSL())}.rgb`,t.toWGSL=()=>`${g(this.toWGSL())}.rgb`,t.dependencies=[this],t}get a(){const t=new y;return t.toGLSL=()=>`${g(this.toGLSL())}.a`,t.toWGSL=()=>`${g(this.toWGSL())}.a`,t.dependencies=[this],t}multiply(t){const n=new Y;return t instanceof Y?(n.toGLSL=()=>{const s=p(this,"*",!0,()=>this.toGLSL()),r=p(t,"*",!1,()=>t.toGLSL());return`${s} * ${r}`},n.toWGSL=()=>{const s=p(this,"*",!0,()=>this.toWGSL()),r=p(t,"*",!1,()=>t.toWGSL());return`${s} * ${r}`},n.dependencies=[this,t]):(n.toGLSL=()=>{const s=p(this,"*",!0,()=>this.toGLSL()),r=typeof t=="number"?t.toString():p(t,"*",!1,()=>t.toGLSL());return`${s} * ${r}`},n.toWGSL=()=>{const s=p(this,"*",!0,()=>this.toWGSL()),r=typeof t=="number"?t.toString():p(t,"*",!1,()=>t.toWGSL());return`${s} * ${r}`},n.dependencies=typeof t=="number"?[this]:[this,t]),n}add(t){const n=new Y;return n.toGLSL=()=>{const s=p(this,"+",!0,()=>this.toGLSL()),r=p(t,"+",!1,()=>t.toGLSL());return`${s} + ${r}`},n.toWGSL=()=>{const s=p(this,"+",!0,()=>this.toWGSL()),r=p(t,"+",!1,()=>t.toWGSL());return`${s} + ${r}`},n.dependencies=[this,t],n}subtract(t){const n=new Y;return n.toGLSL=()=>{const s=p(this,"-",!0,()=>this.toGLSL()),r=p(t,"-",!1,()=>t.toGLSL());return`${s} - ${r}`},n.toWGSL=()=>{const s=p(this,"-",!0,()=>this.toWGSL()),r=p(t,"-",!1,()=>t.toWGSL());return`${s} - ${r}`},n.dependencies=[this,t],n}divide(t){const n=new Y;return t instanceof Y||t instanceof O?(n.toGLSL=()=>{const s=p(this,"/",!0,()=>this.toGLSL()),r=p(t,"/",!1,()=>t.toGLSL());return`${s} / ${r}`},n.toWGSL=()=>{const s=p(this,"/",!0,()=>this.toWGSL()),r=p(t,"/",!1,()=>t.toWGSL());return`${s} / ${r}`},n.dependencies=[this,t]):(n.toGLSL=()=>{const s=p(this,"/",!0,()=>this.toGLSL()),r=typeof t=="number"?G(t):p(t,"/",!1,()=>t.toGLSL());return`${s} / ${r}`},n.toWGSL=()=>{const s=p(this,"/",!0,()=>this.toWGSL()),r=typeof t=="number"?G(t):p(t,"/",!1,()=>t.toWGSL());return`${s} / ${r}`},n.dependencies=typeof t=="number"?[this]:[this,t]),n}assign(t){new Tt(this,t)}}function Tn(...e){return new Y(...e)}class y{constructor(...t){if(this.glslType="float",this.wgslType="f32",t.length!==0)if(t.length===1&&t[0]instanceof it){const n=t[0];this.toGLSL=()=>`float(${n.toGLSL()})`,this.toWGSL=()=>`f32(${n.toWGSL()})`,this.dependencies=[n]}else if(t.length===1&&t[0]instanceof Ot){const n=t[0];this.toGLSL=()=>`float(${n.toGLSL()})`,this.toWGSL=()=>`f32(${n.toWGSL()})`,this.dependencies=[n]}else if(t.length===1&&typeof t[0]=="number"){const n=t[0];this.toGLSL=()=>G(n),this.toWGSL=()=>G(n),this.dependencies=[]}else throw new Error("Invalid arguments for Float")}lessThan(t){const n=new Q;return typeof t=="number"?(n.toGLSL=()=>`${this.toGLSL()} < ${G(t)}`,n.toWGSL=()=>`${this.toWGSL()} < ${G(t)}`,n.dependencies=[this]):(n.toGLSL=()=>{const s=this.toGLSL(),r=t.toGLSL();return`${s} < ${r}`},n.toWGSL=()=>{const s=this.toWGSL(),r=t.toWGSL();return`${s} < ${r}`},n.dependencies=[this,t]),n}lessThanOrEqual(t){const n=new Q;return typeof t=="number"?(n.toGLSL=()=>`${this.toGLSL()} <= ${G(t)}`,n.toWGSL=()=>`${this.toWGSL()} <= ${G(t)}`,n.dependencies=[this]):(n.toGLSL=()=>`${this.toGLSL()} <= ${t.toGLSL()}`,n.toWGSL=()=>`${this.toWGSL()} <= ${t.toWGSL()}`,n.dependencies=[this,t]),n}greaterThan(t){const n=new Q;return typeof t=="number"?(n.toGLSL=()=>`${this.toGLSL()} > ${G(t)}`,n.toWGSL=()=>`${this.toWGSL()} > ${G(t)}`,n.dependencies=[this]):(n.toGLSL=()=>`${this.toGLSL()} > ${t.toGLSL()}`,n.toWGSL=()=>`${this.toWGSL()} > ${t.toWGSL()}`,n.dependencies=[this,t]),n}greaterThanOrEqual(t){const n=new Q;return typeof t=="number"?(n.toGLSL=()=>`${this.toGLSL()} >= ${G(t)}`,n.toWGSL=()=>`${this.toWGSL()} >= ${G(t)}`,n.dependencies=[this]):(n.toGLSL=()=>`${this.toGLSL()} >= ${t.toGLSL()}`,n.toWGSL=()=>`${this.toWGSL()} >= ${t.toWGSL()}`,n.dependencies=[this,t]),n}equals(t){const n=new Q,s=t instanceof y;if(typeof t=="number")n.toGLSL=()=>`${this.toGLSL()} == ${G(t)}`,n.toWGSL=()=>`${this.toWGSL()} == ${G(t)}`,n.dependencies=[this];else if(s)n.toGLSL=()=>{const r=this.toGLSL(),i=t.toGLSL();return`${r} == ${i}`},n.toWGSL=()=>{const r=this.toWGSL(),i=t.toWGSL();return`${r} == ${i}`},n.dependencies=[this,t];else throw new Error("Invalid argument for equals: "+typeof t);return n}multiply(t){if(t instanceof O){const i=new O,o=this.toGLSL(),a=o==="-1.0"||o==="-1";return i.toGLSL=()=>{const c=t.toGLSL(),u=/[+\-*/]/.test(c),l=/^-?\d+(\.\d+)?[eE][+-]?\d+$/.test(c),d=/^-?\d+(\.\d+)?$/.test(c);if(a)return u&&!l&&!d?`-(${c})`:`-${c}`;const h=p(this,"*",!0,()=>this.toGLSL()),f=p(t,"*",!1,()=>c);return`${h} * ${f}`},i.toWGSL=()=>{const c=t.toWGSL(),u=/[+\-*/]/.test(c),l=/^-?\d+(\.\d+)?[eE][+-]?\d+$/.test(c),d=/^-?\d+(\.\d+)?$/.test(c);if(a)return u&&!l&&!d?`-(${c})`:`-${c}`;const h=p(this,"*",!0,()=>this.toWGSL()),f=p(t,"*",!1,()=>c);return`${h} * ${f}`},i.dependencies=[this,t],i}if(t instanceof Y){const i=new Y,o=this.toGLSL(),a=o==="-1.0"||o==="-1";return i.toGLSL=()=>{const c=t.toGLSL(),u=/[+\-*/]/.test(c),l=/^-?\d+(\.\d+)?[eE][+-]?\d+$/.test(c),d=/^-?\d+(\.\d+)?$/.test(c);if(a)return u&&!l&&!d?`-(${c})`:`-${c}`;const h=p(this,"*",!0,()=>this.toGLSL()),f=p(t,"*",!1,()=>c);return`${h} * ${f}`},i.toWGSL=()=>{const c=t.toWGSL(),u=/[+\-*/]/.test(c),l=/^-?\d+(\.\d+)?[eE][+-]?\d+$/.test(c),d=/^-?\d+(\.\d+)?$/.test(c);if(a)return u&&!l&&!d?`-(${c})`:`-${c}`;const h=p(this,"*",!0,()=>this.toWGSL()),f=p(t,"*",!1,()=>c);return`${h} * ${f}`},i.dependencies=[this,t],i}if(t instanceof I){const i=new I(0,0),o=this.toGLSL(),a=o==="-1.0"||o==="-1";return i.toGLSL=()=>{const c=t.toGLSL(),u=/[+\-*/]/.test(c),l=/^-?\d+(\.\d+)?[eE][+-]?\d+$/.test(c),d=/^-?\d+(\.\d+)?$/.test(c);if(a)return u&&!l&&!d?`-(${c})`:`-${c}`;const h=p(this,"*",!0,()=>this.toGLSL()),f=p(t,"*",!1,()=>c);return`${h} * ${f}`},i.toWGSL=()=>{const c=t.toWGSL(),u=/[+\-*/]/.test(c),l=/^-?\d+(\.\d+)?[eE][+-]?\d+$/.test(c),d=/^-?\d+(\.\d+)?$/.test(c);if(a)return u&&!l&&!d?`-(${c})`:`-${c}`;const h=p(this,"*",!0,()=>this.toWGSL()),f=p(t,"*",!1,()=>c);return`${h} * ${f}`},i.dependencies=[this,t],i}const n=new y,s=this.toGLSL(),r=s==="-1.0"||s==="-1";return n.toGLSL=()=>{if(r){const a=typeof t=="number"?G(t):t.toGLSL(),c=/[+\-*/]/.test(a),u=/^-?\d+(\.\d+)?[eE][+-]?\d+$/.test(a),l=/^-?\d+(\.\d+)?$/.test(a);return c&&!u&&!l?`-(${a})`:`-${a}`}const i=typeof t=="number"?G(t):p(t,"*",!1,()=>t.toGLSL());return`${p(this,"*",!0,()=>this.toGLSL())} * ${i}`},n.toWGSL=()=>{if(r){const a=typeof t=="number"?G(t):t.toWGSL(),c=/[+\-*/]/.test(a),u=/^-?\d+(\.\d+)?[eE][+-]?\d+$/.test(a),l=/^-?\d+(\.\d+)?$/.test(a);return c&&!u&&!l?`-(${a})`:`-${a}`}const i=typeof t=="number"?G(t):p(t,"*",!1,()=>t.toWGSL());return`${p(this,"*",!0,()=>this.toWGSL())} * ${i}`},n.dependencies=typeof t=="number"?[this]:[this,t],n}add(t){const n=new y;return n.toGLSL=()=>{const s=p(this,"+",!0,()=>this.toGLSL()),r=p(t,"+",!1,()=>t.toGLSL());return`${s} + ${r}`},n.toWGSL=()=>{const s=p(this,"+",!0,()=>this.toWGSL()),r=p(t,"+",!1,()=>t.toWGSL());return`${s} + ${r}`},n.dependencies=[this,t],n}subtract(t){if(t instanceof O){const s=new O;return s.toGLSL=()=>{const r=p(this,"-",!0,()=>this.toGLSL()),i=p(t,"-",!1,()=>t.toGLSL());return`${r} - ${i}`},s.toWGSL=()=>{const r=p(this,"-",!0,()=>this.toWGSL()),i=p(t,"-",!1,()=>t.toWGSL());return`${r} - ${i}`},s.dependencies=[this,t],s}if(t instanceof Y){const s=new Y;return s.toGLSL=()=>{const r=p(this,"-",!0,()=>this.toGLSL()),i=p(t,"-",!1,()=>t.toGLSL());return`${r} - ${i}`},s.toWGSL=()=>{const r=p(this,"-",!0,()=>this.toWGSL()),i=p(t,"-",!1,()=>t.toWGSL());return`${r} - ${i}`},s.dependencies=[this,t],s}if(t instanceof I){const s=new I(0,0);return s.toGLSL=()=>{const r=p(this,"-",!0,()=>this.toGLSL()),i=p(t,"-",!1,()=>t.toGLSL());return`${r} - ${i}`},s.toWGSL=()=>{const r=p(this,"-",!0,()=>this.toWGSL()),i=p(t,"-",!1,()=>t.toWGSL());return`${r} - ${i}`},s.dependencies=[this,t],s}const n=new y;return n.toGLSL=()=>{const s=p(this,"-",!0,()=>this.toGLSL()),r=typeof t=="number"?G(t):p(t,"-",!1,()=>t.toGLSL());return`${s} - ${r}`},n.toWGSL=()=>{const s=p(this,"-",!0,()=>this.toWGSL()),r=typeof t=="number"?G(t):p(t,"-",!1,()=>t.toWGSL());return`${s} - ${r}`},n.dependencies=typeof t=="number"?[this]:[this,t],n}divide(t){const n=new y;return n.toGLSL=()=>{const s=p(this,"/",!0,()=>this.toGLSL()),r=typeof t=="number"?G(t):p(t,"/",!1,()=>t.toGLSL());return`${s} / ${r}`},n.toWGSL=()=>{const s=p(this,"/",!0,()=>this.toWGSL()),r=typeof t=="number"?G(t):p(t,"/",!1,()=>t.toWGSL());return`${s} / ${r}`},n.dependencies=typeof t=="number"?[this]:[this,t],n}mod(t){const n=new y;return n.toGLSL=()=>{const s=p(this,"%",!0,()=>this.toGLSL()),r=typeof t=="number"?G(t):p(t,"%",!1,()=>t.toGLSL());return`${s} % ${r}`},n.toWGSL=()=>{const s=p(this,"%",!0,()=>this.toWGSL()),r=typeof t=="number"?G(t):p(t,"%",!1,()=>t.toWGSL());return`${s} % ${r}`},n.dependencies=typeof t=="number"?[this]:[this,t],n}assign(t){new Tt(this,t)}negate(){const t=new y;return t.toGLSL=()=>{const n=this.toGLSL(),s=/[+\-*/]/.test(n),r=/^-?\d+(\.\d+)?[eE][+-]?\d+$/.test(n),i=/^-?\d+(\.\d+)?$/.test(n);return s&&!r&&!i?`-(${n})`:`-${n}`},t.toWGSL=()=>{const n=this.toWGSL(),s=/[+\-*/]/.test(n),r=/^-?\d+(\.\d+)?[eE][+-]?\d+$/.test(n),i=/^-?\d+(\.\d+)?$/.test(n);return s&&!r&&!i?`-(${n})`:`-${n}`},t.dependencies=[this],t}}function Br(...e){return new y(...e)}class rt{constructor(t,n="float"){this.dependencies=[],this.value=t,this.type=n}toGLSL(){return`precision ${this.value} ${this.type};`}toWGSL(){return""}}function fi(e,t="float"){const n=new rt(e,t),s=bn();if(!s)throw new Error("precision() 必须在 fragment shader 函数中调用");return s.dependencies.push(n),n}class te{constructor(t){this.dependencies=[],this.uniform=t}isDepthTexture(){return!1}toGLSL(){return`uniform ${this.getGLSLSamplerType()} ${this.uniform.name};`}toWGSL(){const t=this.uniform.getEffectiveBinding()??0,n=this.uniform.getEffectiveGroup(),s=`@binding(${t}) @group(${n})`,r=`@binding(${t+1}) @group(${n})`;return`${s} var ${this.uniform.name}_texture: ${this.getWGSLTextureType()};
${r} var ${this.uniform.name}: sampler;`}}function Dr(e){const t=new Set,n=new Set,s=new Set,r=new Set,i=new Set,o=new Set,a=new Map,c=new Set,u=new Map,l=new Set,d=new WeakSet,h=f=>{if(f!=null&&!(typeof f=="object"&&d.has(f))){if(typeof f=="object"&&d.add(f),f instanceof Sn){if(n.add(f),f.value&&f.value._isStruct){const S=f.value;u.set(f,{uniform:f,structDef:S._structDef,instanceName:S._instanceName})}return}if(f instanceof Ln){t.add(f);return}if(f instanceof rt){c.add(f);return}if(f instanceof _n){s.add(f);return}if(f instanceof te){r.add(f);return}if(f instanceof X){i.add(f);return}if(f instanceof Te){o.add(f);return}if(f instanceof Le){l.add(f);for(const S of f.dependencies)h(S);return}if(typeof f=="object"&&f._shaderFunc instanceof Le){l.add(f._shaderFunc);for(const S of f._shaderFunc.dependencies)h(S)}if(typeof f=="object"&&f._isExternalVar){const S=f._varName,m=f._varExpr;S&&m&&!a.has(S)&&a.set(S,{name:S,expr:m})}if(typeof f=="object"&&"dependencies"in f&&Array.isArray(f.dependencies))for(const S of f.dependencies)h(S)}};for(const f of e)h(f);return{attributes:t,uniforms:n,precisions:c,varyings:s,samplers:r,builtins:i,fragColors:o,externalVars:globalThis.Array.from(a.values()),structUniforms:globalThis.Array.from(u.values()),shaderFuncs:l}}class Ee{constructor(t,n){this.statements=[],this.dependencies=[],this.name=t,this.body=n}executeBodyIfNeeded(){if(!(this.dependencies.length>0||this.statements.length>0)){Qt(this);try{this.body()}finally{Qt(null)}}}getAnalyzedDependencies(){return this._analyzedDependencies||(this.executeBodyIfNeeded(),this._analyzedDependencies=Dr(this.dependencies)),this._analyzedDependencies}toGLSL(){this.executeBodyIfNeeded();const t=[];return t.push(`void ${this.name}() {`),this.statements.forEach(n=>{const s=n.toGLSL();if(s.trim()!==""){const r=s.split(`
`);for(const i of r)t.push(`    ${i}`)}}),t.push("}"),t.join(`
`)}toWGSL(){this.executeBodyIfNeeded();const t=[];return t.push(`fn ${this.name}() {`),this.statements.forEach(n=>{const r=n.toWGSL().split(`
`);for(const i of r)t.push(`    ${i}`)}),t.push("}"),t.join(`
`)}generateWGSLStatements(){const t=[];return this.statements.forEach(n=>{const r=n.toWGSL().split(`
`);for(const i of r)t.push(`    ${i}`)}),t}}class Le{constructor(t,n,s,r){this.statements=[],this.dependencies=[],this.name=t,this.returnTypeFunc=s;const i=s();this.returnType={glslType:i.glslType,wgslType:i.wgslType},this.params=n.map((a,c)=>{const u=Array.isArray(a),l=u?a[0]:`p${c}`,d=u?a[1]:a,h=d(),f=d();return f.toGLSL=()=>l,f.toWGSL=()=>l,{name:l,glslType:h.glslType,wgslType:h.wgslType,value:f}});const o=new Ee(t,()=>{const a=this.params.map(c=>c.value);r(...a)});Qt(o);try{const a=this.params.map(c=>c.value);r(...a),this.statements.push(...o.statements),this.dependencies.push(...o.dependencies)}finally{Qt(null)}}call(...t){const n=t.map(r=>{if(typeof r=="number"){const i=Number.isInteger(r)?`${r}.0`:r.toString();return{toGLSL:()=>i,toWGSL:()=>i}}return r}),s=this.returnTypeFunc();return s.toGLSL=()=>`${this.name}(${n.map(r=>r.toGLSL()).join(", ")})`,s.toWGSL=()=>`${this.name}(${n.map(r=>r.toWGSL()).join(", ")})`,s.dependencies=n,s._shaderFunc=this,s}toGLSL(){return this._glslCode?this._glslCode:(this._glslCode=yt({language:"glsl",stage:"fragment",version:2,isHelperFunction:!0},()=>{const t=[],n=this.params.map(s=>`in ${s.glslType} ${s.name}`).join(", ");t.push(`${this.returnType.glslType} ${this.name}(${n}) {`);for(const s of this.statements){const r=s.toGLSL();if(r.trim())for(const i of r.split(`
`))t.push(`    ${i}`)}return t.push("}"),t.join(`
`)}),this._glslCode)}toWGSL(){return this._wgslCode?this._wgslCode:(this._wgslCode=yt({language:"wgsl",stage:"fragment",version:1,isHelperFunction:!0},()=>{const t=[],n=this.params.map(s=>`${s.name}: ${s.wgslType}`).join(", ");t.push(`fn ${this.name}(${n}) -> ${this.returnType.wgslType} {`);for(const s of this.statements){const r=s.toWGSL();if(r.trim())for(const i of r.split(`
`))t.push(`    ${i}`)}return t.push("}"),t.join(`
`)}),this._wgslCode)}}function li(e,t,n,s){const r=new Le(e,t,n,s),i=(...o)=>r.call(...o);return i._shaderFunc=r,i}class En extends te{getGLSLSamplerType(){return"sampler2DArray"}getWGSLTextureType(){return"texture_2d_array<f32>"}}function di(e){return new En(e)}class vn extends te{getGLSLSamplerType(){return"sampler3D"}getWGSLTextureType(){return"texture_3d<f32>"}}function hi(e){return new vn(e)}class An extends te{getGLSLSamplerType(){return"usampler2D"}getWGSLTextureType(){return"texture_2d<u32>"}isUintTexture(){return!0}}function pi(e){return new An(e)}class zr extends Ee{constructor(t,n){super(t,n)}toGLSL(t=1){return yt({language:"glsl",stage:"fragment",version:t},()=>{const n=[];t===2&&(n.push("#version 300 es"),n.push("")),super.toGLSL();const s=this.getAnalyzedDependencies(),r=new Map;for(const L of s.precisions)r.set(L.type,L);const i=r.get("float")||new rt("highp","float");if(n.push(i.toGLSL()),t===2){let L=!1;if(L=Array.from(s.uniforms).some(_=>_.value&&_.value.glslType==="int"),L||(L=Array.from(s.attributes).some(_=>_.value&&_.value.glslType==="int")),!L){const _=b=>!b||typeof b!="object"?!1:"glslType"in b&&b.glslType==="int"?!0:"dependencies"in b&&Array.isArray(b.dependencies)?b.dependencies.some(T=>_(T)):!1;L=this.dependencies.some(b=>_(b))}if(L){const _=r.get("int")||new rt("highp","int");n.push(_.toGLSL())}}if(Array.from(s.samplers).some(L=>L instanceof En)){const L=r.get("sampler2DArray")||new rt("lowp","sampler2DArray");n.push(L.toGLSL())}if(Array.from(s.samplers).some(L=>L instanceof vn)){const L=r.get("sampler3D")||new rt("lowp","sampler3D");n.push(L.toGLSL())}if(Array.from(s.samplers).some(L=>L instanceof An)){const L=r.get("usampler2D")||new rt("highp","usampler2D");n.push(L.toGLSL())}for(const L of s.varyings)n.push(L.toGLSL());const u=new Set(s.structUniforms.map(L=>L.uniform.name)),l=new Set;for(const L of s.structUniforms){const _=L.structDef.getNestedStructDefinitions();for(const b of _)l.has(b.name)||(n.push(b.toGLSLStruct()),l.add(b.name))}for(const L of s.structUniforms)n.push(L.structDef.toGLSLBlock(L.instanceName));for(const L of s.uniforms)u.has(L.name)||n.push(L.toGLSL());for(const L of s.samplers)n.push(L.toGLSL());if(t===2)if(n.push(""),s.fragColors.size>0){const L=Array.from(s.fragColors).sort((_,b)=>_.location-b.location);for(const _ of L)n.push(`layout(location = ${_.location}) out vec4 ${_.name};`)}else n.push("layout(location = 0) out vec4 color;");const d=s.externalVars;for(const{name:L,expr:_}of d)n.push(`const ${_.glslType} ${L} = ${_.toGLSL()};`);for(const L of s.shaderFuncs)n.push(""),n.push(L.toGLSL());const f=super.toGLSL().split(`
`).filter(L=>L.trim()!=="");n.length>0&&f.length>0&&n.push(""),n.push(...f);const S=[];for(let L=0;L<n.length;L++){const _=n[L];L===n.length-1&&_.trim()===""||S.push(_)}return S.join(`
`)})}toWGSL(t){return yt({language:"wgsl",stage:"fragment",version:1},()=>{const n=[];this.executeBodyIfNeeded();const s=this.getAnalyzedDependencies();this.allocateBindings(s.uniforms,s.samplers,t);const r=s.varyings.size>0;if(r){this.allocateVaryingLocations(s.varyings,t);for(const L of s.varyings)if(L.value){const _=L.name;L.value.toWGSL=()=>`input.${_}`}const m=["struct FragmentInput {"];for(const L of s.varyings)L.value&&m.push(`    ${L.toWGSL()},`);m.push("}"),n.push(m.join(`
`))}if(s.fragColors.size>0){const m=Array.from(s.fragColors).sort((_,b)=>_.location-b.location),L=["struct FragmentOut {"];for(const _ of m)L.push(`    @location(${_.location}) ${_.name}: vec4<f32>,`);L.push("};"),n.push(L.join(`
`))}const i=new Set(s.structUniforms.map(m=>m.uniform.name)),o=new Set;for(const m of s.structUniforms){const L=m.structDef.getNestedStructDefinitions();for(const _ of L)o.has(_.name)||(n.push(_.toWGSLStruct()),o.add(_.name))}for(const m of s.structUniforms)n.push(m.structDef.toWGSLStruct());for(const m of s.structUniforms){const L=m.uniform.getEffectiveBinding()??0,_=m.uniform.getEffectiveGroup();n.push(m.structDef.toWGSLUniform(m.instanceName,_,L))}for(const m of s.uniforms)i.has(m.name)||n.push(m.toWGSL());for(const m of s.samplers){const L=m.toWGSL();n.push(...L.split(`
`))}const a=s.externalVars;for(const{name:m,expr:L}of a)n.push(`const ${m}: ${L.wgslType} = ${L.toWGSL()};`);for(const m of s.shaderFuncs)n.push(""),n.push(m.toWGSL());n.length>0&&n.push(""),n.push("@fragment");const c=[];r&&c.push("input: FragmentInput");for(const m of s.builtins)(m.isFragCoord||m.isFrontFacing)&&c.push(m.toWGSL());const u=c.length>0?`(
    ${c.map(m=>`${m},`).join(`
    `)}
)`:"()",l=Array.from(s.builtins).some(m=>m.isFragColorOutput),d=s.fragColors.size>0,h=l||d||this.statements.some(m=>m.toWGSL().includes("return"));let f;return h?d?f="FragmentOut":f="@location(0) vec4<f32>":f=null,f?n.push(`fn ${this.name}${u} -> ${f} {`):n.push(`fn ${this.name}${u} {`),d?(n.push("    var output: FragmentOut;"),this.statements.forEach(m=>{let L=m.toWGSL();const _=Array.from(s.fragColors).sort((T,E)=>T.location-E.location);for(const T of _)L=L.replace(new RegExp(`\\b${T.name}\\b`,"g"),`output.${T.name}`);const b=L.split(`
`);for(const T of b)n.push(`    ${T}`)}),n.push("    return output;")):l?(n.push("    var fragColor: vec4<f32>;"),this.statements.forEach(m=>{const _=m.toWGSL().split(`
`);for(const b of _)n.push(`    ${b}`)}),n.push("    return fragColor;")):this.statements.forEach(m=>{const _=m.toWGSL().split(`
`);for(const b of _)n.push(`    ${b}`)}),n.push("}"),n.join(`
`)+`
`})}allocateBindings(t,n,s){const r=new Map,i=a=>(r.has(a)||r.set(a,new Set),r.get(a)),o=new Map;if(s){s.toWGSL();const a=s.getAnalyzedDependencies();for(const c of a.uniforms){const u=c.getEffectiveBinding();if(u!==void 0){const l=c.getEffectiveGroup();i(l).add(u),o.set(c.name,{binding:u,group:l})}}for(const c of a.samplers){const u=c.uniform.getEffectiveBinding()??0,l=c.uniform.getEffectiveGroup(),d=i(l);d.add(u),d.add(u+1)}}for(const a of t)a.binding!==void 0&&i(a.getEffectiveGroup()).add(a.binding);for(const a of n)if(a.uniform.binding!==void 0){const c=a.uniform.getEffectiveGroup(),u=i(c);u.add(a.uniform.binding),u.add(a.uniform.binding+1)}for(const a of t)if(a.binding===void 0){const c=a.getEffectiveGroup(),u=i(c),l=o.get(a.name);if(l&&l.group===c)a.setAutoBinding(l.binding),u.add(l.binding);else{let d=0;for(;u.has(d);)d++;a.setAutoBinding(d),u.add(d)}}for(const a of n)if(a.uniform.binding===void 0){const c=a.uniform.getEffectiveGroup(),u=i(c);let l=0;for(;u.has(l)||u.has(l+1);)l++;a.uniform.setAutoBinding(l),u.add(l),u.add(l+1)}}allocateVaryingLocations(t,n){if(n){const r=n.getAnalyzedDependencies(),i=new Map;for(const o of r.varyings){const a=o.getEffectiveLocation();a!==void 0&&i.set(o.name,a)}for(const o of t)if(o.location===void 0){const a=i.get(o.name);a!==void 0&&o.setAutoLocation(a)}return}const s=new Set;for(const r of t)r.location!==void 0&&s.add(r.location);for(const r of t)if(r.location===void 0){let i=0;for(;s.has(i);)i++;r.setAutoLocation(i),s.add(i)}}}function Li(e,t){return new zr(e,t)}class Vr extends Ee{constructor(t,n){super(t,n)}toGLSL(t=1){return yt({language:"glsl",stage:"vertex",version:t},()=>{const n=[];t===2&&(n.push("#version 300 es"),n.push(""),n.push("precision highp float;"),n.push("precision highp int;"),n.push("")),super.toGLSL();const s=this.getAnalyzedDependencies();this.allocateLocations(s.attributes);for(const d of s.attributes)n.push(d.toGLSL());const r=new Set(s.structUniforms.map(d=>d.uniform.name)),i=new Set;for(const d of s.structUniforms){const h=d.structDef.getNestedStructDefinitions();for(const f of h)i.has(f.name)||(n.push(f.toGLSLStruct()),i.add(f.name))}for(const d of s.structUniforms)n.push(d.structDef.toGLSLBlock(d.instanceName));for(const d of s.uniforms)r.has(d.name)||n.push(d.toGLSL());for(const d of s.samplers)n.push(d.toGLSL());for(const d of s.varyings)n.push(d.toGLSL());const o=s.externalVars;for(const{name:d,expr:h}of o)n.push(`const ${h.glslType} ${d} = ${h.toGLSL()};`);for(const d of s.shaderFuncs)n.push(""),n.push(d.toGLSL());const c=super.toGLSL().split(`
`).filter(d=>d.trim()!=="");n.length>0&&c.length>0&&n.push(""),n.push(...c);const u=[];for(let d=0;d<n.length;d++){const h=n[d];d===n.length-1&&h.trim()===""||u.push(h)}return u.join(`
`)})}toWGSL(t){const n=(t==null?void 0:t.convertDepth)??!1;return yt({language:"wgsl",stage:"vertex",version:1,convertDepth:n},()=>{const s=[];this.executeBodyIfNeeded();const r=this.getAnalyzedDependencies();this.allocateLocations(r.attributes),this.allocateBindings(r.uniforms,r.samplers);const i=globalThis.Array.from(r.builtins).some(f=>f.isPosition),o=r.varyings.size>0,a=i||o;if(a){this.allocateVaryingLocations(r.varyings);for(const S of r.varyings)if(S.value){const m=S.name;S.value.toWGSL=()=>`output.${m}`}for(const S of r.builtins)S.isPosition&&S.setStructVarPrefix("output");const f=this.generateVertexOutputStructDefinition(r.varyings,r.builtins);s.push(f)}const c=new Set(r.structUniforms.map(f=>f.uniform.name)),u=new Set;for(const f of r.structUniforms){const S=f.structDef.getNestedStructDefinitions();for(const m of S)u.has(m.name)||(s.push(m.toWGSLStruct()),u.add(m.name))}for(const f of r.structUniforms)s.push(f.structDef.toWGSLStruct());for(const f of r.structUniforms){const S=f.uniform.getEffectiveBinding()??0,m=f.uniform.getEffectiveGroup();s.push(f.structDef.toWGSLUniform(f.instanceName,m,S))}for(const f of r.uniforms)c.has(f.name)||s.push(f.toWGSL());for(const f of r.samplers)s.push(f.toWGSL());const l=r.externalVars;for(const{name:f,expr:S}of l)s.push(`const ${f}: ${S.wgslType} = ${S.toWGSL()};`);for(const f of r.shaderFuncs)s.push(""),s.push(f.toWGSL());s.length>0&&s.push("");const d=this.generateVertexFunctionWGSL(r,a,i,n);return s.push(...d.split(`
`)),s.join(`
`)+`
`})}generateVertexFunctionWGSL(t,n,s,r){const i=[],o=[];for(const u of t.attributes)o.push(u.toWGSL());for(const u of t.builtins)(u.isVertexIndex||u.isInstanceIndex)&&o.push(u.toWGSL());if(n){if(!this.statements.some(h=>h._isAutoVarDeclaration)){const h={toGLSL:()=>"",toWGSL:()=>"var output: VertexOutput;"};h._isAutoVarDeclaration=!0;const f=[h];for(const S of this.statements)f.push(S);this.statements=f}const l=this.statements.some(h=>h._isReturn||h._isAutoReturn),d=this.statements.some(h=>h._isAutoDepthConvert);if(r&&s&&!l&&!d){const h=globalThis.Array.from(t.builtins).find(f=>f.isPosition);if(h){const f={toGLSL:()=>"",toWGSL:()=>{const S=h.getFullWGSLVarName();return`${S} = vec4<f32>(${S}.xy, (${S}.z + 1.0) * 0.5, ${S}.w);`}};f._isAutoDepthConvert=!0,this.statements.push(f)}}if(!l){const h={toGLSL:()=>"",toWGSL:()=>"return output;"};h._isAutoReturn=!0,this.statements.push(h)}}i.push("@vertex");const a=o.length>0?`(
    ${o.map(u=>`${u},`).join(`
    `)}
)`:"()",c=n?"VertexOutput":"@builtin(position) vec4<f32>";return i.push(`fn ${this.name}${a} -> ${c} {`),i.push(...this.generateWGSLStatements()),i.push("}"),i.join(`
`)}generateVertexOutputStructDefinition(t,n){const s=["struct VertexOutput {"];for(const r of n)if(r.isPosition){s.push("    @builtin(position) position: vec4<f32>,");break}for(const r of t)r.value&&s.push(`    ${r.toWGSL()},`);return s.push("}"),s.join(`
`)}allocateVaryingLocations(t){const n=new Set;for(const s of t)s.location!==void 0&&n.add(s.location);for(const s of t)if(s.location===void 0){let r=0;for(;n.has(r);)r++;s.setAutoLocation(r),n.add(r)}}allocateLocations(t){const n=new Set;for(const s of t)s.location!==void 0&&n.add(s.location);for(const s of t)if(s.location===void 0){let r=0;for(;n.has(r);)r++;s.setAutoLocation(r),n.add(r)}}allocateBindings(t,n){const s=new Map,r=i=>(s.has(i)||s.set(i,new Set),s.get(i));for(const i of t)i.binding!==void 0&&r(i.getEffectiveGroup()).add(i.binding);for(const i of n)if(i.uniform.binding!==void 0){const o=i.uniform.getEffectiveGroup(),a=r(o);a.add(i.uniform.binding),a.add(i.uniform.binding+1)}for(const i of t)if(i.binding===void 0){const o=i.getEffectiveGroup(),a=r(o);let c=0;for(;a.has(c);)c++;i.setAutoBinding(c),a.add(c)}for(const i of n)if(i.uniform.binding===void 0){const o=i.uniform.getEffectiveGroup(),a=r(o);let c=0;for(;a.has(c)||a.has(c+1);)c++;i.uniform.setAutoBinding(c),a.add(c),a.add(c+1)}}}function mi(e,t){return new Vr(e,t)}const Si=ut("gl_Position",Tn()),_i=ut("gl_FragColor",Tn()),Gi=ut("gl_VertexID",yn()),bi=ut("gl_FragCoord",Or()),gi=ut("gl_InstanceID",yn()),yi=ut("gl_FrontFacing",Mr()),Ti=ut("gl_PointSize",Br());export{En as $,ai as A,pi as B,An as C,Cn as D,Xr as E,y as F,Qr as G,et as H,ft as I,st as J,ee as K,jr as L,le as M,Yr as N,wn as O,Kr as P,Rn as Q,kr as R,te as S,Hr as T,qt as U,O as V,Zr as W,Qe as X,bn as Y,Wr as Z,Kt as _,ei as a,vn as a0,it as a1,Gt as a2,ii as a3,oi as a4,Nt as a5,li as a6,Vr as a7,yt as a8,Ti as a9,yi as aa,mi as b,Tn as c,ci as d,ri as e,Li as f,Si as g,Br as h,_i as i,Gi as j,bi as k,gi as l,ti as m,yn as n,di as o,fi as p,ui as q,tt as r,ni as s,I as t,si as u,Or as v,Y as w,G as x,g as y,hi as z};
