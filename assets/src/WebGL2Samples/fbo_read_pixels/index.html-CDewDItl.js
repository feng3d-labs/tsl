import"../../../modulepreload-polyfill-B5Qt9EMX.js";import{a as O,v as A,u as L,e as ee,b as C,g as F,c as n,o as te,n as re,f as R,p as f,q as G,W as oe}from"../../../builtins-C5GxhwDd.js";import{W as se,a as ie}from"../../../frame-comparison-CBkPASci.js";import{t as ae}from"../../../texture-D0-A-o9X.js";import{r as ne}from"../../../return-DhHkPme9.js";import{m as le}from"../../../mat4-Pkjqt0vg.js";const z=O("position",A()),ce=O("textureCoordinates",A()),D=L("mvp",le()),M=ee("v_st",A()),v=C("main",()=>{M.assign(ce),F.assign(D.multiply(n(z,0,1)))}),ge=te(L("diffuse")),me=L("layer",re()),U=R("main",()=>{f("highp","float"),f("highp","int"),f("lowp","sampler2DArray"),ne(ae(ge,M,me))}),h=C("main",()=>{F.assign(D.multiply(n(z,0,1)))}),ue=n(G(0,"red")),pe=n(G(1,"green")),we=n(G(2,"blue")),_=R("main",()=>{ue.assign(n(.5,0,0,1)),pe.assign(n(0,.3,0,1)),we.assign(n(0,0,.8,1))});document.addEventListener("DOMContentLoaded",async()=>{const B=v.toGLSL(2),I=U.toGLSL(2),$=v.toWGSL(),j=U.toWGSL(v),N=h.toGLSL(2),X=_.toGLSL(2),H=h.toWGSL(),q=_.toWGSL(h),y=window.devicePixelRatio||1,l=document.getElementById("webgpu");l.width=l.clientWidth*y,l.height=l.clientHeight*y;const m=await new se({canvasId:"webgpu"}).init(),u=document.getElementById("webgl");u.width=u.clientWidth*y,u.height=u.clientHeight*y;const p=new oe({canvasId:"webgl",webGLcontextId:"webgl2"}),s={x:l.width,y:l.height},a={RED:0,GREEN:1,BLUE:2,MAX:3},c=new Array(a.MAX);c[a.RED]={x:s.x/2,y:0,z:s.x/2,w:s.y/2},c[a.GREEN]={x:s.x/2,y:s.y/2,z:s.x/2,w:s.y/2},c[a.BLUE]={x:0,y:s.y/2,z:s.x/2,w:s.y/2};const P=new Float32Array([-1,-1,1,-1,1,1,1,1,-1,1,-1,-1]),T=new Float32Array([0,0,1,0,1,1,1,1,0,1,0,0]),k={vertices:{position:{data:P,format:"float32x2"}}},J={vertices:{position:{data:P,format:"float32x2"},textureCoordinates:{data:T,format:"float32x2"}}},e=16,t=16,x={descriptor:{size:[e,t,3],dimension:"2d-array",format:"rgba8unorm"}},K={minFilter:"nearest",magFilter:"nearest",lodMinClamp:0,lodMaxClamp:0},g={colorAttachments:[{view:{texture:x,baseMipLevel:0,baseArrayLayer:a.RED}},{view:{texture:x,baseMipLevel:0,baseArrayLayer:a.GREEN}},{view:{texture:x,baseMipLevel:0,baseArrayLayer:a.BLUE}}]},W=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),Q={descriptor:g,renderPassObjects:[{viewport:{x:0,y:0,width:e,height:t},pipeline:{vertex:{glsl:N,wgsl:H},fragment:{glsl:X,wgsl:q},primitive:{topology:"triangle-list"}},bindingResources:{mvp:{value:W}},vertices:k.vertices,draw:{__type__:"DrawVertex",vertexCount:6}}]},Y={vertex:{glsl:B,wgsl:$},fragment:{glsl:I,wgsl:j},primitive:{topology:"triangle-list"}},S=[],Z={descriptor:{colorAttachments:[{clearValue:[0,0,0,1],loadOp:"clear"}]},renderPassObjects:S},V={pipeline:Y,bindingResources:{mvp:{value:W},diffuse:{texture:x,sampler:K}},vertices:J.vertices,draw:{__type__:"DrawVertex",vertexCount:6}};for(let r=0;r<a.MAX;++r)S.push({viewport:{x:c[r].x,y:c[r].y,width:c[r].z,height:c[r].w},...V,bindingResources:{...V.bindingResources,layer:{value:r}},draw:{__type__:"DrawVertex",vertexCount:6}});const E={commandEncoders:[{passEncoders:[Q,Z]}]};m.submit(E),p.submit(E),ie(p,m,u,l,0);const o=new Uint8Array(e*t*4*3),i=new Uint8Array(e*t*4*3);console.log("=== WebGL readPixels 结果 ===");let w=p.readPixels({textureView:g.colorAttachments[0].view,origin:[0,0],copySize:[e,t]});o.set(new Uint8Array(w.buffer),0),console.log("红色层像素数据 (前16个字节):",Array.from(o.slice(0,16))),w=p.readPixels({textureView:g.colorAttachments[1].view,origin:[0,0],copySize:[e,t]}),o.set(new Uint8Array(w.buffer),e*t*4),console.log("绿色层像素数据 (前16个字节):",Array.from(o.slice(e*t*4,e*t*4+16))),w=p.readPixels({textureView:g.colorAttachments[2].view,origin:[0,0],copySize:[e,t]}),o.set(new Uint8Array(w.buffer),e*t*4*2),console.log("蓝色层像素数据 (前16个字节):",Array.from(o.slice(e*t*4*2,e*t*4*2+16))),console.log("WebGL 完整像素数据大小:",o.length,"字节"),console.log(`
=== WebGPU readPixels 结果 ===`);let d=await m.readPixels({textureView:g.colorAttachments[0].view,origin:[0,0],copySize:[e,t]});i.set(new Uint8Array(d.buffer),0),console.log("红色层像素数据 (前16个字节):",Array.from(i.slice(0,16))),d=await m.readPixels({textureView:g.colorAttachments[1].view,origin:[0,0],copySize:[e,t]}),i.set(new Uint8Array(d.buffer),e*t*4),console.log("绿色层像素数据 (前16个字节):",Array.from(i.slice(e*t*4,e*t*4+16))),d=await m.readPixels({textureView:g.colorAttachments[2].view,origin:[0,0],copySize:[e,t]}),i.set(new Uint8Array(d.buffer),e*t*4*2),console.log("蓝色层像素数据 (前16个字节):",Array.from(i.slice(e*t*4*2,e*t*4*2+16))),console.log("WebGPU 完整像素数据大小:",i.length,"字节"),console.log(`
=== WebGL vs WebGPU readPixels 比较 ===`);let b=0;for(let r=0;r<o.length;r++)o[r]!==i[r]&&(b++,b<=10&&console.log(`像素差异 [${r}]: WebGL=${o[r]}, WebGPU=${i[r]}`));console.log(b===0?"✓ WebGL 和 WebGPU 读取的像素数据完全一致！":`✗ 发现 ${b} 个字节不一致（共 ${o.length} 字节）`)});
