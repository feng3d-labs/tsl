import"../../../modulepreload-polyfill-B5Qt9EMX.js";import{a as it,d as k,u as rt,e as at,b as ct,p as b,c as _,g as lt,q as ft,f as ht,W as Vt}from"../../../builtins-C5GxhwDd.js";import{W as Nt,a as Gt}from"../../../frame-comparison-CBkPASci.js";import{n as mt}from"../../../normalize-BhFzRmv8.js";import{m as pt}from"../../../mat4-Pkjqt0vg.js";import{c as D,s as M}from"../../../vec3-BLfYq55O.js";import{c as At,s as Ft}from"../../../quat-C6_OgK1s.js";import{c as u,m as O,f as Ct,s as ut,e as It,t as Bt,p as Dt,b as Mt,i as Ot,a as kt}from"../../../mat4-Lq7FX_53.js";import"../../../common-C8IKy_GC.js";const dt=it("position",k(),0),gt=it("normal",k(),1),bt=rt("mvp",pt()),_t=rt("mvNormal",pt()),yt=at("v_normal",k()),z=ct("main",()=>{b("highp","float"),b("highp","int"),yt.assign(mt(_t.multiply(_(gt,0)).xyz)),lt.assign(bt.multiply(_(dt,1)))}),Et=_(ft(0,"color")),K=ht("main",()=>{b("highp","float"),b("highp","int"),Et.assign(_(yt,1))}),wt=at("v_normal",k(),{interpolation:"flat"}),U=ct("main",()=>{b("highp","float"),b("highp","int"),wt.assign(mt(_t.multiply(_(gt,0)).xyz)),lt.assign(bt.multiply(_(dt,1)))}),Wt=_(ft(0,"color")),Z=ht("main",()=>{b("highp","float"),b("highp","int"),Wt.assign(_(wt,1))});class Rt{constructor(){this.meshes=[]}}class Pt{constructor(){this.meshID="",this.primitives=[]}}class zt{constructor(){this.mode=4,this.indices=null,this.indicesComponentType=5123,this.vertexBuffer=null,this.matrix=u(),this.attributes={}}}class Ut{constructor(){this.defaultScene="",this.scenes={},this.json=null}}class qt{constructor(){this._init(),this.glTF=null}_init(){this._parseDone=!1,this._loadDone=!1,this._bufferRequested=0,this._bufferLoaded=0,this._buffers={},this._bufferTasks={},this._bufferViews={},this._pendingTasks=0,this._finishedPendingTasks=0,this.onload=null}_getBufferViewData(e,t,o){const l=this._bufferViews[t];if(l)o(l);else{const s=e.bufferViews[t],r=this._buffers[s.buffer];if(r)this._bufferViews[t]=r.slice(s.byteOffset,s.byteOffset+s.byteLength),o(l);else{this._pendingTasks++;let a=this._bufferTasks[s.buffer];a||(this._bufferTasks[s.buffer]=[],a=this._bufferTasks[s.buffer]);const f=this;a.push(function(i){let c=f._bufferViews[t];c||(console.log(`create new BufferView Data for ${t}`),c=f._bufferViews[t]=i.slice(s.byteOffset,s.byteOffset+s.byteLength)),f._finishedPendingTasks++,o(c)})}}}_checkComplete(){this._bufferRequested===this._bufferLoaded&&(this._loadDone=!0),this._loadDone&&this._parseDone&&this._pendingTasks===this._finishedPendingTasks&&this.onload(this.glTF)}_parseGLTF(e){this.glTF.json=e,this.glTF.defaultScene=e.scene;for(const t in e.scenes){const o=new Rt;this.glTF.scenes[t]=o;const s=e.scenes[t].nodes,r=s.length;for(let a=0;a<r;++a){const f=s[a],i=e.nodes[f];this._parseNode(e,i,o)}}this._parseDone=!0,this._checkComplete()}_parseNode(e,t,o,l){l===void 0&&(l=u());const s=u();if(t.hasOwnProperty("matrix")){for(let i=0;i<16;++i)s[i]=t.matrix[i];O(s,l,s)}else M(j,t.translation[0],t.translation[1],t.translation[2]),Ft(tt,t.rotation[0],t.rotation[1],t.rotation[2],t.rotation[3]),Ct(st,tt,j),O(s,s,st),M(et,t.scale[0],t.scale[1],t.scale[2]),ut(s,s,et);const r=t.meshes;if(r){const i=r.length;for(let c=0;c<i;++c){const m=new Pt;o.meshes.push(m);const y=r[c],h=e.meshes[y];m.meshID=y;const d=h.primitives,E=d.length;for(let x=0;x<E;++x){const N=new zt;m.primitives.push(N);const G=d[x];G.indices&&this._parseIndices(e,G,N),this._parseAttributes(e,G,N,s)}}}const a=t.children,f=a.length;for(let i=0;i<f;++i){const c=a[i],m=e.nodes[c];this._parseNode(e,m,o,s)}}_parseIndices(e,t,o){const l=t.indices,s=e.accessors[l];o.mode=t.mode||4,o.indicesComponentType=$t[s.componentType];const r=this;this._getBufferViewData(e,s.bufferView,function(a){o.indices=Ht(a,s),r._checkComplete()})}_parseAttributes(e,t,o,l){const s=Object.keys(t.attributes)[0],r=e.accessors[t.attributes[s]],a=r.bufferView,f=e.bufferViews[a],i=this;this._getBufferViewData(e,a,function(c){o.vertexBuffer=vt(c,0,f.byteLength/ot[r.componentType],r.componentType);for(const m in t.attributes){const y=t.attributes[m],h=e.accessors[y],d=ot[h.componentType];h.byteStride/d,h.byteOffset/d,h.count,It(o.matrix,l),o.attributes[m]={size:Tt[h.type],type:h.componentType,stride:h.byteStride,offset:h.byteOffset}}i._checkComplete()})}loadGLTF(e,t){this._init(),this.onload=t||(l=>{console.log("glTF model loaded."),console.log(l)}),this.glTF=new Ut,this.baseUri=Xt(e);const o=this;Yt(e,function(l){const s=JSON.parse(l);let r;const a=f=>{if(o._buffers[r]=f,o._bufferLoaded++,o._bufferTasks[r]){let i,c;for(i=0,c=o._bufferTasks[r].length;i<c;++i)o._bufferTasks[r][i](f)}o._checkComplete()};if(s.buffers)for(r in s.buffers)o._bufferRequested++,Jt(`${o.baseUri}/${s.buffers[r].uri}`,a);o._parseGLTF(s)})}}const j=D(),tt=At(),et=D(),st=u(),ot={5120:1,5121:1,5122:2,5123:2,5126:4},Tt={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},$t={5121:"UNSIGNED_BYTE",5123:"UNSIGNED_SHORT",5124:"UNSIGNED_INT"};function vt(n,e,t,o){switch(o){case 5122:return new Int16Array(n,e,t);case 5123:return new Uint16Array(n,e,t);case 5126:return new Float32Array(n,e,t);default:return null}}function Ht(n,e){return vt(n,e.byteOffset,e.count*Tt[e.type],e.componentType)}function Xt(n){let e="";const t=n.lastIndexOf("/");return t!==-1&&(e=n.substring(0,t+1)),e}function Yt(n,e){const t=new XMLHttpRequest;t.overrideMimeType("application/json"),t.open("GET",n,!0),t.onreadystatechange=function(){t.readyState===4&&t.status===200&&e(t.responseText,this)},t.send(null)}function Jt(n,e){const t=new XMLHttpRequest;t.responseType="arraybuffer",t.open("GET",n,!0),t.onreadystatechange=function(){if(t.readyState===4&&t.status===200){const o=t.response;o&&e&&e(o)}},t.send(null)}function nt(n){const e=window.devicePixelRatio||1;n.width=n.clientWidth*e,n.height=n.clientHeight*e}const Qt={MAX:2};document.addEventListener("DOMContentLoaded",async()=>{const n=U.toGLSL(2),e=Z.toGLSL(2),t=U.toWGSL(),o=Z.toWGSL(U),l=z.toGLSL(2),s=K.toGLSL(2),r=z.toWGSL(),a=K.toWGSL(z),f=document.getElementById("webgpu");nt(f);const i=await new Nt({canvasId:"webgpu"}).init(),c=document.getElementById("webgl");nt(c);const m=new Vt({canvasId:"webgl",webGLcontextId:"webgl2"}),y={x:c.width,y:c.height},h=y.x/2,d=y.y,E=[{x:0,y:0,width:h,height:d},{x:h,y:0,width:h,height:d}],x=[{vertex:{glsl:n,wgsl:t},fragment:{glsl:e,wgsl:o},depthStencil:{depthCompare:"less-equal"},primitive:{topology:"triangle-list"}},{vertex:{glsl:l,wgsl:r},fragment:{glsl:s,wgsl:a},depthStencil:{depthCompare:"less-equal"},primitive:{topology:"triangle-list"}}];new qt().loadGLTF("./assets/gltf/di_model_tri.gltf",function(q){const A=q.scenes[q.defaultScene],F={};let v,g,$,p,C;for(const L in A.meshes)for(v=A.meshes[L],F[L]=[],p=0,C=v.primitives.length;p<C;++p){g=v.primitives[p];const V=g.vertexBuffer,P=g.indices,S=g.attributes.POSITION,T=g.attributes.NORMAL;$={vertices:{position:{data:V,format:["float32","float32x2","float32x3","float32x4"][S.size],arrayStride:S.stride,offset:S.offset},normal:{data:V,format:["float32","float32x2","float32x3","float32x4"][T.size],arrayStride:T.stride,offset:T.offset}}},F[L].push({vertexArray:$,indices:P})}const H=D();M(H,0,-18,-60);const X=D(),W=.3;M(X,W,W,W);const w=u();Bt(w,w,H),ut(w,w,X);const St=.01,Y=u();Dt(Y,.785,1,1,1e3);const R=u(),J=u(),I=u();let Q=!1;(function L(){const V=[],P={descriptor:{colorAttachments:[{clearValue:[0,0,0,1],loadOp:"clear"}],depthStencilAttachment:{depthLoadOp:"clear"}},renderPassObjects:V};Mt(w,w,St);for(const T in A.meshes)for(v=A.meshes[T],p=0,C=v.primitives.length;p<C;++p){g=v.primitives[p],O(R,w,g.matrix),O(J,Y,R),Ot(I,R),kt(I,I);const xt=F[T][p].vertexArray,Lt=F[T][p].indices;for(let B=0;B<Qt.MAX;++B)V.push({viewport:E[B],pipeline:x[B],bindingResources:{mvp:{value:J},mvNormal:{value:I}},vertices:xt.vertices,indices:Lt,draw:{__type__:"DrawIndexed",indexCount:g.indices.length,firstIndex:0}})}const S={commandEncoders:[{passEncoders:[P]}]};m.submit(S),i.submit(S),Q||(Q=!0,Gt(m,i,c,f,0)),requestAnimationFrame(L)})()})});
