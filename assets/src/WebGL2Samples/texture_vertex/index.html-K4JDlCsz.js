import"../../../modulepreload-polyfill-B5Qt9EMX.js";import{w as X,x as B,t as le,V as fe,F as De,a as J,d as Q,v as $,u as W,e as we,b as Be,p as M,c as q,g as $e,a6 as We,h as ke,f as Re,W as Ue,O as me}from"../../../builtins-C5GxhwDd.js";import{W as Pe,a as ze}from"../../../frame-comparison-CBkPASci.js";import{c as I,s as E}from"../../../vec3-BLfYq55O.js";import{c as Ye,s as Xe}from"../../../quat-C6_OgK1s.js";import{c as b,m as F,f as qe,s as He,e as Ge,l as Je,p as Qe,r as ue,b as de,d as Ze}from"../../../mat4-Lq7FX_53.js";import{l as d}from"../../../let-Czo32qSi.js";import{v as Ke}from"../../../var-BrV_KNjZ.js";import{s as Ne}from"../../../sampler2D-DSRZ_QT6.js";import{t as je}from"../../../texture-D0-A-o9X.js";import{t as et}from"../../../textureSize-DF-iDVy_.js";import{d as Me,a as Ie,c as tt}from"../../../cross-D7V0moss.js";import{r as Ee}from"../../../return-DhHkPme9.js";import{d as pe}from"../../../dot-di-r-mUL.js";import{n as st}from"../../../normalize-BhFzRmv8.js";import{p as ot}from"../../../pow-BSCluLP5.js";import{c as nt}from"../../../clamp-DYFz6aCQ.js";import{f as it}from"../../../fract-fjFXQogY.js";import{m as he}from"../../../max-DfBZmhFk.js";import{m as rt}from"../../../mix-vZRoDtYO.js";import{m as Fe}from"../../../mat4-Pkjqt0vg.js";import"../../../common-C8IKy_GC.js";import"../../../wgslKeywords-TYZDccpG.js";function at(s,t,e){const o=new X,i=typeof e=="number"?B(e):e.toGLSL(),n=typeof e=="number"?B(e):e.toWGSL();return o.toGLSL=()=>`textureLod(${s.uniform.name}, ${t.toGLSL()}, ${i})`,o.toWGSL=()=>`textureSampleLevel(${s.uniform.name}_texture, ${s.uniform.name}, ${t.toWGSL()}, ${n})`,o.dependencies=typeof e=="number"?[s,t]:[s,t,e],o}function U(s){if(s instanceof le){const e=new le;return e.toGLSL=()=>`log2(${s.toGLSL()})`,e.toWGSL=()=>`log2(${s.toWGSL()})`,e.dependencies=[s],e}if(s instanceof fe){const e=new fe;return e.toGLSL=()=>`log2(${s.toGLSL()})`,e.toWGSL=()=>`log2(${s.toWGSL()})`,e.dependencies=[s],e}if(s instanceof X){const e=new X;return e.toGLSL=()=>`log2(${s.toGLSL()})`,e.toWGSL=()=>`log2(${s.toWGSL()})`,e.dependencies=[s],e}const t=new De;return t.toGLSL=()=>`log2(${typeof s=="number"?B(s):s.toGLSL()})`,t.toWGSL=()=>`log2(${typeof s=="number"?B(s):s.toWGSL()})`,t.dependencies=typeof s=="number"?[]:[s],t}class ct{constructor(){this.meshes=[]}}class lt{constructor(){this.meshID="",this.primitives=[]}}class ft{constructor(){this.mode=4,this.indices=null,this.indicesComponentType=5123,this.vertexBuffer=null,this.matrix=b(),this.attributes={}}}class mt{constructor(){this.defaultScene="",this.scenes={},this.json=null}}class ut{constructor(){this._init(),this.glTF=null}_init(){this._parseDone=!1,this._loadDone=!1,this._bufferRequested=0,this._bufferLoaded=0,this._buffers={},this._bufferTasks={},this._bufferViews={},this._pendingTasks=0,this._finishedPendingTasks=0,this.onload=null}_getBufferViewData(t,e,o){const i=this._bufferViews[e];if(i)o(i);else{const n=t.bufferViews[e],r=this._buffers[n.buffer];if(r)this._bufferViews[e]=r.slice(n.byteOffset,n.byteOffset+n.byteLength),o(i);else{this._pendingTasks++;let l=this._bufferTasks[n.buffer];l||(this._bufferTasks[n.buffer]=[],l=this._bufferTasks[n.buffer]);const m=this;l.push(function(a){let c=m._bufferViews[e];c||(console.log(`create new BufferView Data for ${e}`),c=m._bufferViews[e]=a.slice(n.byteOffset,n.byteOffset+n.byteLength)),m._finishedPendingTasks++,o(c)})}}}_checkComplete(){this._bufferRequested===this._bufferLoaded&&(this._loadDone=!0),this._loadDone&&this._parseDone&&this._pendingTasks===this._finishedPendingTasks&&this.onload(this.glTF)}_parseGLTF(t){this.glTF.json=t,this.glTF.defaultScene=t.scene;for(const e in t.scenes){const o=new ct;this.glTF.scenes[e]=o;const n=t.scenes[e].nodes,r=n.length;for(let l=0;l<r;++l){const m=n[l],a=t.nodes[m];this._parseNode(t,a,o)}}this._parseDone=!0,this._checkComplete()}_parseNode(t,e,o,i){i===void 0&&(i=b());const n=b();if(e.hasOwnProperty("matrix")){for(let a=0;a<16;++a)n[a]=e.matrix[a];F(n,i,n)}else E(ge,e.translation[0],e.translation[1],e.translation[2]),Xe(be,e.rotation[0],e.rotation[1],e.rotation[2],e.rotation[3]),qe(Le,be,ge),F(n,n,Le),E(_e,e.scale[0],e.scale[1],e.scale[2]),He(n,n,_e);const r=e.meshes;if(r){const a=r.length;for(let c=0;c<a;++c){const f=new lt;o.meshes.push(f);const y=r[c],u=t.meshes[y];f.meshID=y;const v=u.primitives,w=v.length;for(let G=0;G<w;++G){const T=new ft;f.primitives.push(T);const V=v[G];V.indices&&this._parseIndices(t,V,T),this._parseAttributes(t,V,T,n)}}}const l=e.children,m=l.length;for(let a=0;a<m;++a){const c=l[a],f=t.nodes[c];this._parseNode(t,f,o,n)}}_parseIndices(t,e,o){const i=e.indices,n=t.accessors[i];o.mode=e.mode||4,o.indicesComponentType=dt[n.componentType];const r=this;this._getBufferViewData(t,n.bufferView,function(l){o.indices=pt(l,n),r._checkComplete()})}_parseAttributes(t,e,o,i){const n=Object.keys(e.attributes)[0],r=t.accessors[e.attributes[n]],l=r.bufferView,m=t.bufferViews[l],a=this;this._getBufferViewData(t,l,function(c){o.vertexBuffer=Oe(c,0,m.byteLength/ye[r.componentType],r.componentType);for(const f in e.attributes){const y=e.attributes[f],u=t.accessors[y],v=ye[u.componentType];u.byteStride/v,u.byteOffset/v,u.count,Ge(o.matrix,i),o.attributes[f]={size:Ve[u.type],type:u.componentType,stride:u.byteStride,offset:u.byteOffset}}a._checkComplete()})}loadGLTF(t,e){this._init(),this.onload=e||(i=>{console.log("glTF model loaded."),console.log(i)}),this.glTF=new mt,this.baseUri=ht(t);const o=this;gt(t,function(i){const n=JSON.parse(i);let r;const l=m=>{if(o._buffers[r]=m,o._bufferLoaded++,o._bufferTasks[r]){let a,c;for(a=0,c=o._bufferTasks[r].length;a<c;++a)o._bufferTasks[r][a](m)}o._checkComplete()};if(n.buffers)for(r in n.buffers)o._bufferRequested++,bt(`${o.baseUri}/${n.buffers[r].uri}`,l);o._parseGLTF(n)})}}const ge=I(),be=Ye(),_e=I(),Le=b(),ye={5120:1,5121:1,5122:2,5123:2,5126:4},Ve={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},dt={5121:"UNSIGNED_BYTE",5123:"UNSIGNED_SHORT",5124:"UNSIGNED_INT"};function Oe(s,t,e,o){switch(o){case 5122:return new Int16Array(s,t,e);case 5123:return new Uint16Array(s,t,e);case 5126:return new Float32Array(s,t,e);default:return null}}function pt(s,t){return Oe(s,t.byteOffset,t.count*Ve[t.type],t.componentType)}function ht(s){let t="";const e=s.lastIndexOf("/");return e!==-1&&(t=s.substring(0,e+1)),t}function gt(s,t){const e=new XMLHttpRequest;e.overrideMimeType("application/json"),e.open("GET",s,!0),e.onreadystatechange=function(){e.readyState===4&&e.status===200&&t(e.responseText,this)},e.send(null)}function bt(s,t){const e=new XMLHttpRequest;e.responseType="arraybuffer",e.open("GET",s,!0),e.onreadystatechange=function(){if(e.readyState===4&&e.status===200){const o=e.response;o&&t&&t(o)}},e.send(null)}const _t=J("position",Q(),0),Lt=J("normal",Q(),1),ve=J("texcoord",$(),4),Te=W("mvMatrix",Fe()),yt=W("pMatrix",Fe()),vt=Ne(W("displacementMap")),D=we("v_st",$()),H=we("v_position",Q()),P=Be("main",()=>{M("highp","float"),M("highp","int"),D.assign(ve);const s=d("height",je(vt,ve).b),t=d("displacedPosition",q(_t,1).add(q(Lt.multiply(s),0)));H.assign(Te.multiply(t).xyz),$e.assign(yt.multiply(Te).multiply(t))}),Ae=Ne(W("diffuse")),Tt=We("textureLevel",[["v_st",$]],ke,s=>{const t=d("size",$(et(Ae,0))),e=d("levelCount",he(U(t.x),U(t.y))),o=d("dx",Me(s.multiply(t))),i=d("dy",Ie(s.multiply(t))),n=Ke("d",he(pe(o,o),pe(i,i))),r=ot(2,e.subtract(1).multiply(2));n.assign(nt(n,1,r)),Ee(U(n).multiply(.5))}),Se=Re("main",()=>{M("highp","float"),M("highp","int"),M("highp","sampler2D"),d("sampleCoord",it(D));const s=d("level",Tt(D)),t=d("texColor",at(Ae,D,s)),e=d("fdx",Me(H)),o=d("fdy",Ie(H)),i=d("N",st(tt(e,o))),n=d("finalColor",rt(t,q(i,1),.5));Ee(n)});function xe(s){const t=window.devicePixelRatio||1;s.width=s.clientWidth*t,s.height=s.clientHeight*t}function St(s){return new Promise((t,e)=>{const o=new Image;o.onload=()=>t(o),o.onerror=e,o.src=s})}const xt={0:"point-list",3:"line-strip",2:"LINE_LOOP",1:"line-list",5:"triangle-strip",6:"TRIANGLE_FAN",4:"triangle-list"},z=Object.freeze({5126:"FLOAT",5120:"BYTE",5122:"SHORT",5121:"UNSIGNED_BYTE",5123:"UNSIGNED_SHORT",5131:"HALF_FLOAT",5124:"INT",5125:"UNSIGNED_INT",36255:"INT_2_10_10_10_REV",33640:"UNSIGNED_INT_2_10_10_10_REV"});function Y(s,t="FLOAT",e=!1){for(const o in me){const i=me[o];if(i.numComponents===s&&i.type===t&&!i.normalized==!e)return o}console.error(`没有找到与 ${JSON.stringify({numComponents:s,type:t,normalized:e})} 对应的顶点数据格式！`)}document.addEventListener("DOMContentLoaded",async()=>{const s=P.toGLSL(2),t=Se.toGLSL(2),e=P.toWGSL({convertDepth:!0}),o=Se.toWGSL(P),i=document.getElementById("webgpu");xe(i);const n=await new Pe({canvasId:"webgpu"}).init(),r=document.getElementById("webgl");xe(r);const l=new Ue({canvasId:"webgl",webGLcontextId:"webgl2"}),m={vertex:{glsl:s,wgsl:e},fragment:{glsl:t,wgsl:o,targets:[{}]},depthStencil:{depthCompare:"less"}},a={};let c,f,y,u,v,w;const G=new ut;let T;G.loadGLTF("./assets/gltf/plane.gltf",function(h){T=h.scenes[h.defaultScene];let L,p;for(const g in T.meshes)for(c=T.meshes[g],a[g]=[],L=0,p=c.primitives.length;L<p;++L){f=c.primitives[L],y=f.vertexBuffer,u=f.indices;const O=f.attributes.POSITION,A=f.attributes.NORMAL,C=f.attributes.TEXCOORD_0;a[g].push({vertices:{position:{data:y,format:Y(O.size,z[O.type]),arrayStride:O.stride,offset:O.offset},normal:{data:y,format:Y(A.size,z[A.type]),arrayStride:A.stride,offset:A.offset},texcoord:{data:y,format:Y(C.size,z[C.type]),arrayStride:C.stride,offset:C.offset}},indices:u})}St("./images/heightmap.jpg").then(g=>{v={descriptor:{format:"rgba8unorm",mipLevelCount:1,size:[256,256]},sources:[{image:g,flipY:!1}]},w={minFilter:"nearest",magFilter:"nearest",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},requestAnimationFrame(ce)})});const S=[0,0,0],Z=b(),Ce=b(),K=I();E(K,4,3,1);const j=I();E(j,0,.5,0);const ee=I();E(ee,0,1,0);const te=b();Je(te,K,j,ee);const _=b();F(_,te,Ce);const se=b();Qe(se,.785,1,1,1e3);let k=0,R=0;const oe=h=>{k=h.clientX,R=h.clientY},ne=()=>{},ie=h=>{const L=h.clientX,p=h.clientY,N=L-k,g=p-R,x=b();ue(x,x,N/100),de(x,x,g/100),F(Z,_,x),Ge(_,Z),k=L,R=p};r.addEventListener("mousedown",oe),r.addEventListener("mouseup",ne),r.addEventListener("mousemove",ie),i.addEventListener("mousedown",oe),i.addEventListener("mouseup",ne),i.addEventListener("mousemove",ie);let re=!1;const ae=b();function ce(){const h=[],L={descriptor:{colorAttachments:[{clearValue:[0,0,0,1],loadOp:"clear"}],depthStencilAttachment:{depthLoadOp:"clear"}},renderPassObjects:h};S[0]=2e-4,S[1]=1e-4,S[2]=5e-5,ue(_,_,S[0]*Math.PI),de(_,_,S[1]*Math.PI),Ze(_,_,S[2]*Math.PI);let p,N;for(const g in T.meshes)for(c=T.meshes[g],p=0,N=c.primitives.length;p<N;++p)f=c.primitives[p],F(ae,_,f.matrix),h.push({pipeline:{...m,primitive:{topology:xt[f.mode]}},bindingResources:{mvMatrix:{value:ae},pMatrix:{value:se},displacementMap:{texture:v,sampler:w},diffuse:{texture:v,sampler:w}},vertices:a[g][p].vertices,indices:a[g][p].indices,draw:{__type__:"DrawIndexed",indexCount:f.indices.length}});l.submit({commandEncoders:[{passEncoders:[L]}]}),n.submit({commandEncoders:[{passEncoders:[L]}]}),re||(re=!0,ze(l,n,r,i,1)),requestAnimationFrame(ce)}});
