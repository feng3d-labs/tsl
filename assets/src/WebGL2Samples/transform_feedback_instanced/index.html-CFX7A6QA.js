import"../../../modulepreload-polyfill-B5Qt9EMX.js";import{x as k,t as N,F as ct,u as dt,h as c,a as L,v as i,e as $,a6 as lt,d as Q,b as mt,p as h,g as X,c as M,f as ft,W as pt,r as B}from"../../../builtins-C5GxhwDd.js";import{W as ut,a as _t}from"../../../frame-comparison-CBkPASci.js";import{l as f}from"../../../let-Czo32qSi.js";import{t as ht}from"../../../transform-D6sp5tn9.js";import{r as Y}from"../../../return-DhHkPme9.js";import{s as H}from"../../../select-DnGDa-4t.js";import{d as Lt}from"../../../dot-di-r-mUL.js";import{n as vt}from"../../../normalize-BhFzRmv8.js";import{a as wt}from"../../../atan-IxokGhrk.js";import{c as A}from"../../../cos-0AUzw8Ns.js";import{s as x}from"../../../sin-C4vXRgAE.js";import{f as gt}from"../../../fract-fjFXQogY.js";import"../../../wgslKeywords-TYZDccpG.js";class T{constructor(...t){if(this.glslType="mat2",this.wgslType="mat2x2<f32>",t.length!==0)if(t.length===1&&typeof t[0]=="number"){const o=t[0],e=k(o);this.toGLSL=()=>`mat2(${e})`,this.toWGSL=()=>`mat2x2<f32>(vec2<f32>(${e}, 0.0), vec2<f32>(0.0, ${e}))`,this.dependencies=[]}else if(t.length===2){const o=t[0],e=t[1];this.toGLSL=()=>`mat2(${o.toGLSL()}, ${e.toGLSL()})`,this.toWGSL=()=>`mat2x2<f32>(${o.toWGSL()}, ${e.toWGSL()})`,this.dependencies=[o,e]}else if(t.length===4){const o=[],e=(s,w)=>s instanceof ct?(o.push(s),w?s.toWGSL():s.toGLSL()):k(s),u=t[0],d=t[1],l=t[2],m=t[3];this.toGLSL=()=>`mat2(${e(u,!1)}, ${e(d,!1)}, ${e(l,!1)}, ${e(m,!1)})`,this.toWGSL=()=>`mat2x2<f32>(${e(u,!0)}, ${e(d,!0)}, ${e(l,!0)}, ${e(m,!0)})`,this.dependencies=o}else throw new Error("Mat2 constructor: invalid arguments")}multiply(t){if(t instanceof N){const o=new N;return o.toGLSL=()=>`${this.toGLSL()} * ${t.toGLSL()}`,o.toWGSL=()=>`${this.toWGSL()} * ${t.toWGSL()}`,o.dependencies=[this,t],o}else{const o=new T;return o.toGLSL=()=>`${this.toGLSL()} * ${t.toGLSL()}`,o.toWGSL=()=>`${this.toWGSL()} * ${t.toWGSL()}`,o.dependencies=[this,t],o}}}function Z(...n){return new T(...n)}const bt=6.28318530718,S=1.01,St=.01,xt=.04,Gt=.001,yt=dt("u_time",c()),W=L("a_offset",i(),0),E=L("a_rotation",c(),1),U=$("v_offset",i()),Wt=$("v_rotation",c()),Et=lt("rand",[["co",i]],c,n=>{Y(gt(x(Lt(n,i(12.9898,78.233))).multiply(43758.5453)))}),z=ht("main",()=>{h("highp","float"),h("highp","int");const n=f("theta",c(bt).multiply(Et(i(yt,E.add(W.x).add(W.y))))),t=f("cos_r",A(E)),o=f("sin_r",x(E)),e=Z(t,o,o.negate(),t),u=f("p",i(A(n),x(n)).multiply(St).add(i(xt,0))),d=f("moveDir",vt(e.multiply(u)));Wt.assign(wt(d.y,d.x));const l=f("newOffset",W.add(d.multiply(Gt))),m=s=>H(s.greaterThan(S),c(-S),H(s.lessThan(c(-S)),c(S),s));U.assign(i(m(l.x),m(l.y))),X.assign(M(U,0,1))}),Ft=L("a_position",i(),2),j=L("a_rotation",c(),1),At=L("a_offset",i(),0),$t=L("a_color",Q(),3),tt=$("v_color",Q()),F=mt("main",()=>{h("highp","float"),h("highp","int"),tt.assign($t);const n=f("cos_r",A(j)),t=f("sin_r",x(j)),o=Z(n,t,t.negate(),n);X.assign(M(o.multiply(Ft).add(At),0,1))}),q=.9,J=ft("main",()=>{h("highp","float"),h("highp","int"),Y(M(tt.multiply(q),q))});function K(n){const t=window.devicePixelRatio||1;n.width=n.clientWidth*t,n.height=n.clientHeight*t}document.addEventListener("DOMContentLoaded",async()=>{const n=z.toGLSL(),t=z.toWGSL({varyings:["v_offset","v_rotation"],bufferMode:"SEPARATE_ATTRIBS"}),o=F.toGLSL(2),e=F.toWGSL(),u=J.toGLSL(2),d=J.toWGSL(F),l=document.getElementById("webgpu");K(l);const m=await new ut({canvasId:"webgpu"}).init(),s=document.getElementById("webgl");K(s);const w=new pt({canvasId:"webgl",webGLcontextId:"webgl2"}),_=1e3,ot=new Float32Array([.015,0,-.01,.01,-.01,-.01]),G=new Float32Array(_*2),P=new Float32Array(_),g=new Float32Array(_*3);for(let a=0;a<_;a++){const r=a*2,p=a*3;G[r]=Math.random()*2-1,G[r+1]=Math.random()*2-1,P[a]=Math.random()*2*Math.PI,g[p]=Math.random(),g[p+1]=Math.random(),g[p+2]=Math.random()}let v=0;const y=[],C=[];for(let a=0;a<2;a++){const r=G.slice(),p=P.slice(),rt={a_offset:{data:r,format:"float32x2"},a_rotation:{data:p,format:"float32"}},it={a_offset:{data:r,format:"float32x2",stepMode:"instance"},a_rotation:{data:p,format:"float32",stepMode:"instance"},a_position:{data:ot,format:"float32x2"},a_color:{data:g,format:"float32x3",stepMode:"instance"}};y[a]=[{vertices:rt},{vertices:it}],C[a]={bindBuffers:[{index:0,data:r},{index:1,data:p}]}}const et={vertex:{code:n,wgsl:t},transformFeedbackVaryings:{varyings:["v_offset","v_rotation"],bufferMode:"SEPARATE_ATTRIBS"}},nt={vertex:{code:o,wgsl:e},fragment:{code:u,wgsl:d,targets:[{blend:{color:{srcFactor:"src-alpha",dstFactor:"one"},alpha:{srcFactor:"src-alpha",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"}},b={pipeline:et,vertices:null,transformFeedback:null,uniforms:{},draw:{__type__:"DrawVertex",vertexCount:_}},D={viewport:{x:0,y:0,width:s.width,height:s.height},pipeline:nt,bindingResources:{},draw:{__type__:"DrawVertex",vertexCount:3,instanceCount:_}},I={commandEncoders:[{passEncoders:[{__type__:"TransformFeedbackPass",transformFeedbackObjects:[b]},{descriptor:{colorAttachments:[{clearValue:[0,0,0,1],loadOp:"clear"}]},renderPassObjects:[D]}]}]},R=Date.now();function st(){const a=Date.now()-R,r=(v+1)%2;b.vertices=y[v][0].vertices,b.transformFeedback=C[r],B(b.uniforms).u_time={value:a},v=(v+1)%2}let O=!1;const at=1e3;function V(){st(),B(D).vertices=y[v][1].vertices,w.submit(I),m.submit(I);const a=Date.now()-R;!O&&a>=at&&(O=!0,_t(w,m,s,l,0).then(r=>{Mt(r)})),requestAnimationFrame(V)}requestAnimationFrame(V)});function Mt(n){const t=document.getElementById("comparison-result");if(!t)return;const o=document.createElement("div");o.style.cssText="margin-top: 12px; padding: 10px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; font-size: 13px; color: #856404;",n.isMatch?o.innerHTML=`
            <div style="color: #155724; background: #d4edda; border-color: #c3e6cb; padding: 10px; border-radius: 4px;">
                ✓ WebGL 和 WebGPU 渲染结果一致
            </div>
        `:o.innerHTML=`
            <div style="font-weight: bold; margin-bottom: 6px;">⚠️ 不一致原因：</div>
            <div style="margin-bottom: 8px;">
                WebGL 和 WebGPU 各自维护独立的缓冲区，随机数精度和浮点运算存在微小差异，累积误差会随时间增加。
            </div>
        `,t.appendChild(o)}
