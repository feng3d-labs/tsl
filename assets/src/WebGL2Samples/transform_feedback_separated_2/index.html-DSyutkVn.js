import"../../../modulepreload-polyfill-B5Qt9EMX.js";import{a as l,v as a,h as n,u as S,e as u,a6 as rt,p as c,g as tt,c as F,b as ct,a9 as lt,f as dt,W as mt,r as z}from"../../../builtins-C5GxhwDd.js";import{W as pt,a as ft}from"../../../frame-comparison-CBkPASci.js";import{l as _t}from"../../../let-Czo32qSi.js";import{t as ut}from"../../../transform-D6sp5tn9.js";import{i as gt}from"../../../if_-brTBmB0z.js";import{r as et}from"../../../return-DhHkPme9.js";import{d as vt}from"../../../dot-di-r-mUL.js";import{s as bt}from"../../../sin-C4vXRgAE.js";import{f as wt}from"../../../fract-fjFXQogY.js";import"../../../wgslKeywords-TYZDccpG.js";const U=l("a_position",a(),0),xt=l("a_velocity",a(),1),x=l("a_spawntime",n(),2),q=l("a_lifetime",n(),3),y=l("a_ID",n(),4),H=S("u_time",n()),yt=S("u_acceleration",a()),h=u("v_position",a()),j=u("v_velocity",a()),Y=u("v_spawntime",n()),J=u("v_lifetime",n()),K=rt("rand",[["co",a]],n,o=>{et(wt(bt(vt(o,a(12.9898,78.233))).multiply(43758.5453)))}),Q=ut("main",()=>{c("highp","float"),c("highp","int"),c("highp","sampler3D");const o=x.equals(0),i=H.subtract(x).greaterThan(q),s=U.y.lessThan(-.5),g=o.or(i).or(s);gt(g,()=>{h.assign(a(0,0)),j.assign(a(K(a(y,0)).subtract(.5),K(a(y,y)))),Y.assign(H),J.assign(n(5e3))}).else(()=>{const p=_t("newVelocity",xt.add(n(.01).multiply(yt)));j.assign(p),h.assign(U.add(n(.01).multiply(p))),Y.assign(x),J.assign(q)}),tt.assign(F(h,0,1))}),ht=l("a_position",a(),0),I=ct("main",()=>{c("highp","float"),c("highp","int"),c("highp","sampler3D"),tt.assign(F(ht,0,1)),lt.assign(n(2))}),It=S("u_color",F()),X=dt("main",()=>{c("highp","float"),c("highp","int"),et(It)}),r=1e3,Lt=-1,_=0,L=1,A=2,T=3,Z=4,At=5;function $(o){const i=window.devicePixelRatio||1;o.width=o.clientWidth*i,o.height=o.clientHeight*i}document.addEventListener("DOMContentLoaded",async()=>{const o=Q.toGLSL(),i=Q.toWGSL({varyings:["v_position","v_velocity","v_spawntime","v_lifetime"],bufferMode:"SEPARATE_ATTRIBS"}),s=I.toGLSL(2),g=X.toGLSL(2),p=I.toWGSL(),ot=X.toWGSL(I),v=new Float32Array(r*2),b=new Float32Array(r*2),O=new Float32Array(r),E=new Float32Array(r),C=new Float32Array(r);for(let t=0;t<r;++t)v[t*2]=0,v[t*2+1]=0,b[t*2]=0,b[t*2+1]=0,O[t]=0,E[t]=0,C[t]=t;const d=[],D=[],e=[];for(let t=0;t<2;++t)e[t]=new Array(At),e[t][_]=v.slice(),e[t][L]=b.slice(),e[t][A]=O.slice(),e[t][T]=E.slice(),e[t][Z]=C,d[t]=[],d[t][0]={vertices:{a_position:{data:e[t][_],format:"float32x2"},a_velocity:{data:e[t][L],format:"float32x2"},a_spawntime:{data:e[t][A],format:"float32"},a_lifetime:{data:e[t][T],format:"float32"},a_ID:{data:e[t][Z],format:"float32"}}},d[t][1]={vertices:{a_position:{data:e[t][_],format:"float32x2"}}},D[t]={bindBuffers:[{index:0,data:e[t][_]},{index:1,data:e[t][L]},{index:2,data:e[t][A]},{index:3,data:e[t][T]}]};const at={vertex:{glsl:o,wgsl:i},transformFeedbackVaryings:{varyings:["v_position","v_velocity","v_spawntime","v_lifetime"],bufferMode:"SEPARATE_ATTRIBS"}},nt={vertex:{glsl:s,wgsl:p},fragment:{glsl:g,wgsl:ot,targets:[{blend:{color:{srcFactor:"src-alpha",dstFactor:"one"},alpha:{srcFactor:"src-alpha",dstFactor:"one"}}}]},primitive:{topology:"point-list"}},f={pipeline:at,vertices:null,transformFeedback:null,uniforms:{u_acceleration:{value:[0,Lt]}},draw:{__type__:"DrawVertex",vertexCount:r}},P={pipeline:nt,bindingResources:{u_color:{value:[0,1,1,1]}},draw:{__type__:"DrawVertex",vertexCount:r}},G={commandEncoders:[{passEncoders:[{__type__:"TransformFeedbackPass",transformFeedbackObjects:[f]},{descriptor:{colorAttachments:[{clearValue:[0,0,0,1],loadOp:"clear"}]},renderPassObjects:[P]}]}]},W=document.getElementById("webgl");$(W);const R=new mt({canvasId:"webgl",webGLcontextId:"webgl2",webGLContextAttributes:{antialias:!1}}),N=document.getElementById("webgpu");$(N);const k=await new pt({canvasId:"webgpu"}).init(),M=Date.now();let m=0;function it(){const t=Date.now()-M,w=(m+1)%2;f.vertices=d[m][0].vertices,f.transformFeedback=D[w],z(f.uniforms).u_time={value:t},m=(m+1)%2}let V=!1;const st=1e3;function B(){it(),z(P).vertices=d[m][1].vertices,R.submit(G),k.submit(G);const t=Date.now()-M;!V&&t>=st&&(V=!0,ft(R,k,W,N,0).then(w=>{Tt(w)})),requestAnimationFrame(B)}requestAnimationFrame(B)});function Tt(o){const i=document.getElementById("comparison-result");if(!i)return;const s=document.createElement("div");s.style.cssText="margin-top: 12px; padding: 10px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; font-size: 13px; color: #856404;",o.isMatch?s.innerHTML=`
            <div style="color: #155724; background: #d4edda; border-color: #c3e6cb; padding: 10px; border-radius: 4px;">
                âœ“ WebGL å’Œ WebGPU æ¸²æŸ“ç»“æœä¸€è‡´
            </div>
        `:s.innerHTML=`
            <div style="font-weight: bold; margin-bottom: 6px;">âš ï¸ ä¸ä¸€è‡´åŸå› ï¼š</div>
            <div style="margin-bottom: 8px;">
                WebGPU ä¸æ”¯æŒ <code>gl_PointSize</code> / <code>point_size</code> builtinï¼Œæ‰€æœ‰ç‚¹éƒ½ä»¥ 1 åƒç´ æ¸²æŸ“ï¼Œè€Œ WebGL æ”¯æŒè®¾ç½®ç‚¹å¤§å°ä¸º 2 åƒç´ ã€‚
            </div>
            <div style="padding: 8px; background: #e7f3ff; border-radius: 4px; color: #0066cc;">
                ğŸ’¡ å¦‚éœ€å¤§äº 1 åƒç´ çš„ç‚¹ï¼Œéœ€è¦ä½¿ç”¨å®ä¾‹åŒ–æ¸²æŸ“å››è¾¹å½¢æˆ–å…¶ä»–æ›¿ä»£æ–¹æ¡ˆã€‚
            </div>
        `,i.appendChild(s)}
